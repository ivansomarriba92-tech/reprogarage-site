<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Archivo - ReproGarage</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        :root{ 
            --bg-1:#0b0b0e; 
            --electric-blue:#1E90FF; 
            --purple:#8E44AD; 
            --accent:#DA70D6; 
            --card-bg:#2F2F2F; 
            --glass:rgba(255,255,255,0.03); 
            --text:#fff; 
            --muted:#cfcfe0; 
            --radius:12px; 
            --gap:18px; 
        }
        *{box-sizing:border-box}
        body{ 
            font-family: 'Montserrat', system-ui, Arial, sans-serif;
            background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { 
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .btn {
            background: linear-gradient(135deg, var(--electric-blue), #4aa0ff);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin: 10px 5px;
            border: none;
            cursor: pointer;
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--muted);
            color: var(--muted);
        }
        .loading {
            color: var(--muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="logo" style="margin-bottom: 20px;">
            <h2 style="margin:0;color:var(--electric-blue)">ReproGarage</h2>
            <p style="color:var(--muted);margin:5px 0 20px 0">Descarga de Archivos ECU</p>
        </div>
        
        <div id="contenido">
            <div id="loading" class="loading">
                <p>Verificando enlace de descarga...</p>
            </div>
            
            <div id="success" style="display:none;">
                <h3 class="success">‚úÖ Descarga Lista</h3>
                <p>Tu archivo <strong id="fileName"></strong> est√° listo para descargar.</p>
                <a id="downloadLink" class="btn">üì• Descargar Archivo .bin</a>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è Recordatorio:</strong><br>
                    ‚Ä¢ Este enlace es de un solo uso<br>
                    ‚Ä¢ Guarda el archivo en un lugar seguro<br>
                    ‚Ä¢ Verifica la compatibilidad con tu veh√≠culo
                </div>
            </div>
            
            <div id="error" style="display:none;">
                <h3 class="error">‚ùå Error en la Descarga</h3>
                <p id="errorMessage"></p>
                <button onclick="window.location.href='index.html'" class="btn btn-secondary">
                    Volver al Inicio
                </button>
                <button onclick="window.location.href='mailto:info@reprogarage.es'" class="btn">
                    Contactar Soporte
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n Firebase (USA TU CONFIGURACI√ìN REAL)
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };
        
        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log('Firebase ya inicializado o error:', error);
        }

        // Elementos DOM
        const loadingEl = document.getElementById('loading');
        const successEl = document.getElementById('success');
        const errorEl = document.getElementById('error');
        const fileNameEl = document.getElementById('fileName');
        const downloadLinkEl = document.getElementById('downloadLink');
        const errorMessageEl = document.getElementById('errorMessage');

        // Obtener par√°metros URL
        const urlParams = new URLSearchParams(window.location.search);
        const fileName = urlParams.get('file');
        const token = urlParams.get('token');

        // Iniciar proceso de descarga
        iniciarDescarga();

        async function iniciarDescarga() {
            try {
                if (!fileName || !token) {
                    throw new Error('Enlace de descarga incompleto');
                }

                // Verificar token (aqu√≠ integrar√°s con Firestore despu√©s)
                // const tokenValido = await verificarToken(token);
                // if (!tokenValido) {
                //     throw new Error('Enlace inv√°lido o expirado');
                // }

                // Obtener URL de descarga desde Firebase Storage
                const downloadURL = await obtenerURLDescarga(fileName);
                
                // Mostrar √©xito
                fileNameEl.textContent = fileName;
                downloadLinkEl.href = downloadURL;
                downloadLinkEl.download = fileName;
                
                // Configurar descarga autom√°tica
                setTimeout(() => {
                    downloadLinkEl.click();
                    
                    // Marcar token como usado (cuando tengas Firestore)
                    // marcarTokenUsado(token);
                    
                    // Opcional: Redirigir despu√©s de descargar
                    // setTimeout(() => {
                    //     window.location.href = 'index.html?descarga=exito';
                    // }, 3000);
                }, 1000);

                loadingEl.style.display = 'none';
                successEl.style.display = 'block';

            } catch (error) {
                console.error('Error en descarga:', error);
                mostrarError(error.message);
            }
        }

        async function obtenerURLDescarga(fileName) {
            const storage = firebase.storage();
            const storageRef = storage.ref();
            const fileRef = storageRef.child(fileName);
            
            try {
                const url = await fileRef.getDownloadURL();
                return url;
            } catch (error) {
                if (error.code === 'storage/object-not-found') {
                    throw new Error('Archivo no encontrado en el servidor');
                } else if (error.code === 'storage/unauthorized') {
                    throw new Error('No autorizado para descargar este archivo');
                } else {
                    throw new Error('Error al acceder al archivo: ' + error.message);
                }
            }
        }

        function mostrarError(mensaje) {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            errorMessageEl.textContent = mensaje;
            
            // Enviar error al admin
            enviarErrorAdmin(mensaje, fileName, token);
        }

        function enviarErrorAdmin(mensaje, fileName, token) {
            // Aqu√≠ podr√≠as enviar un email con EmailJS
            console.error('Error de descarga:', { mensaje, fileName, token });
        }

        // Funciones para Firestore (implementar despu√©s)
        async function verificarToken(token) {
            // Implementar con Firestore
            return true; // Temporal
        }

        async function marcarTokenUsado(token) {
            // Implementar con Firestore
            console.log('Token marcado como usado:', token);
        }
    </script>
</body>
</html>