<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="description" content="ReproGarage ‚Äî Reprogramaci√≥n de ECU, archivos Stage 1 y Stage 2. Reprogramaciones a medida para particulares y talleres en Espa√±a."/>
  <meta name="keywords" content="reprogramacion ECU, tuning, archivos stage 1, stage 2, reprogarage, reprogramacion coche, chip tuning, aumentar potencia"/>
  <meta name="theme-color" content="#1E90FF"/>
  
  <!-- SEO -->
  <title>ReproGarage ‚Äî Reprogramaci√≥n de ECU y Tuning Profesional</title>
  <link rel="canonical" href="https://reprogarage.es"/>
  
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://js.stripe.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com/;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://api.emailjs.com https://www.google.com/recaptcha/ https://curly-hall-2272.ivansomarriba92.workers.dev https://firebasestorage.googleapis.com;
    frame-src https://js.stripe.com https://www.google.com/recaptcha/;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  "/>
  <meta http-equiv="X-Content-Type-Options" content="nosniff"/>
  <meta http-equiv="X-XSS-Protection" content="1; mode=block"/>
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin"/>
  
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
:root{ --bg-1:#0b0b0e; --electric-blue:#1E90FF; --purple:#8E44AD; --accent:#DA70D6; --card-bg:#2F2F2F; --glass:rgba(255,255,255,0.03); --text:#fff; --muted:#cfcfe0; --radius:12px; --gap:18px; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Montserrat, system-ui, Arial, sans-serif;background:linear-gradient(90deg, #757575 0%, #2F2F2F 100%);color:var(--text);-webkit-font-smoothing:antialiased;background-attachment:fixed}
.wrap{max-width:1140px;margin:0 auto;padding:20px 16px}
.nav{position:sticky;top:0;z-index:120;backdrop-filter:blur(6px);background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.12));padding-top:env(safe-area-inset-top)}
.nav-inner{display:flex;align-items:center;max-width:1140px;margin:0 auto;padding:12px 16px 12px 30px;position:relative}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{width:80px;height:80px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden;margin-top:-5px;margin-bottom:-5px}
.brand .logo img{width:100%;height:100%;object-fit:contain}
.nav-links{display:flex;gap:16px;align-items:center;position:fixed !important;right:20px !important;top:50% !important;transform:translateY(-50%) !important;margin:0 !important;z-index:1000 !important;}
.nav-links a{padding:10px 8px;border-radius:8px;color:#ffffff !important;font-weight:600;text-decoration:none;white-space:nowrap;background: transparent !important;}
.nav-links a:hover {background: rgba(255,255,255,0.1) !important;}
.hamburger{display:none;background:none;border:0;color:var(--text);padding:8px}
.side-menu{position:fixed;right:0;top:0;height:100vh;width:320px;background:linear-gradient(0deg, rgba(8,3,20,0.95), rgba(20,4,40,0.95));transform:translateX(110%);transition:transform .35s;z-index:200;padding:28px;display:flex;flex-direction:column}
.side-menu.open{transform:translateX(0)}
.side-menu a { color: #ffffff; text-decoration: none; }

header.main-header{position:relative;min-height:420px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;background: url('https://i.ibb.co/Y7cvnHj1/reprogarage-header.png') center center / cover no-repeat}
.hero-inner{z-index:2}
.hero-title{font-size:2rem;margin:0}
.hero-sub{color:#ffffff;margin-top:8px;text-shadow:0 2px 4px rgba(0,0,0,0.5);}
.cta{display:inline-block;padding:12px 18px;border-radius:12px;background:linear-gradient(135deg,var(--electric-blue),#4aa0ff);border:0;color:white;font-weight:700}

.grid{display:grid;grid-template-columns: 1fr 400px;gap: 40px;margin-top:20px;align-items: start;}
.productos {display: grid;grid-template-columns: repeat(3, 1fr);gap: 15px;max-width: 100%;}
.producto {background: var(--card-bg);padding: 14px;border-radius: 12px;border: 1px solid rgba(255,255,255,0.04);display: flex;flex-direction: column;height: 100%;min-height: 380px;}
.producto img {width: 100%;display: block;border-radius: 8px;margin-bottom: 10px;object-fit: cover;height: 130px;}
.producto h4 {margin: 8px 0 4px;font-size: 1.1rem;}
.producto p {flex-grow: 1;font-size: 0.9rem;line-height: 1.4;}

.panel{background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);margin-left: 20px;}
.imagenes-derecha {margin-top: 15px;display: flex;flex-direction: column;gap: 18px;margin-left: 20px;}
.imagen-derecha {background: transparent;border-radius: 12px;overflow: hidden;border: none;width: 100%;margin-left: 0;position: relative;}
.imagen-derecha img {width: 100%;height: 120px;object-fit: cover;display: block;border-radius: 12px;}
.imagen-contenido {padding: 12px;}
.imagen-contenido h4 {margin: 0 0 6px 0;color: var(--text);font-size: 0.95rem;}
.imagen-contenido p {color: var(--muted);font-size: 0.8rem;line-height: 1.4;margin: 0;}
.texto-pagos {text-align: center;color: #ffffff !important;font-size: 0.92rem;margin: 15px 0;padding: 12px;background: transparent;border-radius: 8px;font-weight: 600;margin-left: 20px;}

#reservas .form-card,
#reprogramacion .form-card {background: var(--card-bg);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);}
.form-row{display:flex;gap:10px}
.form-row .col{flex:1}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:0;background:#e0e0e0;color:#000000}
.checkbox-group{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;}

.file-input-container {margin-top: 15px;}
.file-input-label {display: block;margin-bottom: 8px;color: #ffffff;font-weight: 600;}
.file-input {background: #e0e0e0 !important;padding: 10px;border-radius: 8px;color: #000000 !important;width: 100%;border: 0;}
.file-input::file-selector-button {background: #757575 !important;color: white;border: none;padding: 8px 12px;border-radius: 6px;cursor: pointer;margin-right: 10px;font-weight: 600;}
.file-input::file-selector-button:hover {background: #5a5a5a !important;}
.file-input::-webkit-file-upload-button {background: #757575 !important;color: white;border: none;padding: 8px 12px;border-radius: 6px;cursor: pointer;margin-right: 10px;font-weight: 600;}
.file-input::-webkit-file-upload-button:hover {background: #5a5a5a !important;}

#whatsappCTA{position:fixed;right:18px;bottom:18px;background:#25D366;color:#fff;border-radius:50%;width:62px;height:62px;display:flex;align-items:center;justify-content:center;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,0.3);text-decoration:none}
#backToTop{position:fixed;bottom:96px;right:20px;background:var(--electric-blue);color:white;border:0;border-radius:50%;width:50px;height:50px;display:none;align-items:center;justify-content:center;z-index:99}

::placeholder { color: #000000 !important; opacity: 1; }
input, select, textarea { color: #000000 !important; }
footer a { color: #000000 !important; text-decoration: none; }
#comentariosECU {margin-top: 20px;}

.modal-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,0.95);z-index: 1000;display: none;align-items: center;justify-content: center;padding: 20px;overflow-y: auto;}
.modal-content {background: var(--card-bg);padding: 30px;border-radius: 15px;max-width: 1000px;width: 100%;max-height: 90vh;overflow-y: auto;border: 1px solid rgba(255,255,255,0.1);box-shadow: 0 20px 60px rgba(0,0,0,0.5);}
.modal-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 25px;border-bottom: 1px solid rgba(255,255,255,0.1);padding-bottom: 15px;}
.modal-title {margin: 0;font-size: 1.5rem;color: var(--text);}
.close-btn {background: none;border: none;color: var(--muted);font-size: 24px;cursor: pointer;padding: 5px;border-radius: 5px;}
.close-btn:hover {background: rgba(255,255,255,0.1);}

.categorias-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 15px;margin-bottom: 30px;}
.categoria-btn {background: rgba(255,255,255,0.05);border: 2px solid rgba(255,255,255,0.1);padding: 25px 15px;border-radius: 12px;color: var(--text);font-size: 1.1rem;font-weight: bold;cursor: pointer;transition: all 0.3s ease;display: flex;flex-direction: column;align-items: center;gap: 12px;}
.categoria-btn:hover {border-color: var(--electric-blue);transform: translateY(-3px);}
.categoria-btn.active {border-color: var(--electric-blue);background: rgba(30, 144, 255, 0.1);}
.logo-marca {width: 60px;height: 60px;object-fit: contain;filter: brightness(0) invert(1);}

.subcategorias {display: none;margin: 20px 0;padding: 25px;background: rgba(255,255,255,0.02);border-radius: 12px;border: 1px solid rgba(255,255,255,0.05);}
.subcategorias.active {display: block;animation: fadeIn 0.3s ease;}
.subcategoria-title {color: var(--muted);font-size: 1.3rem;margin-bottom: 20px;text-align: center;}
.filtros {display: flex;flex-wrap: wrap;gap: 10px;margin-bottom: 25px;justify-content: center;}
.filtro-btn {background: rgba(255,255,255,0.05);border: 1px solid rgba(255,255,255,0.1);padding: 10px 20px;border-radius: 20px;color: var(--text);cursor: pointer;transition: all 0.3s ease;font-size: 0.9rem;}
.filtro-btn:hover, .filtro-btn.active {background: var(--electric-blue);border-color: var(--electric-blue);}

.archivos-grid {display: grid;grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));gap: 20px;margin-top: 25px;}
.archivo-card {background: rgba(255,255,255,0.05);padding: 20px;border-radius: 12px;border: 1px solid rgba(255,255,255,0.08);transition: all 0.3s ease;text-align: left;}
.archivo-card:hover {transform: translateY(-5px);border-color: var(--electric-blue);box-shadow: 0 10px 30px rgba(30, 144, 255, 0.2);}
.archivo-header {display: flex;justify-content: space-between;align-items: flex-start;margin-bottom: 15px;}
.archivo-title {margin: 0;font-size: 1.1rem;color: var(--text);}
.archivo-precio {background: linear-gradient(135deg, var(--electric-blue), var(--purple));padding: 6px 14px;border-radius: 20px;font-weight: bold;font-size: 0.95rem;}
.archivo-info {color: var(--muted);margin: 8px 0;font-size: 0.9rem;}
.archivo-features {display: flex;flex-wrap: wrap;gap: 8px;margin: 15px 0;}
.feature-tag {background: rgba(30, 144, 255, 0.15);padding: 6px 12px;border-radius: 15px;font-size: 0.8rem;color: var(--electric-blue);}
.add-to-cart-btn {background: linear-gradient(135deg, var(--electric-blue), #4aa0ff);border: none;padding: 12px 20px;border-radius: 8px;color: white;font-weight: 600;cursor: pointer;width: 100%;transition: all 0.3s ease;font-family: inherit;}
.add-to-cart-btn:hover {transform: translateY(-2px);box-shadow: 0 5px 15px rgba(30, 144, 255, 0.4);}
.add-to-cart-btn.added {background: var(--success);}

@keyframes fadeIn {from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }}
.hidden {display: none;}

.campo-error {border: 2px solid #ff4444 !important;background: #fff0f0 !important;}
.mensaje-error {color: #ff4444;font-size: 0.8rem;margin-top: 4px;display: block;font-weight: 600;}
.formulario-error {background: rgba(255, 68, 68, 0.1);border: 1px solid #ff4444;padding: 12px;border-radius: 8px;margin-bottom: 15px;}

@media (max-width: 768px) {
    #reprogramacion .checkbox-group {display: grid !important;grid-template-columns: 1fr 1fr !important;gap: 6px !important;width: 100% !important;margin-top: 15px !important;}
    #reprogramacion .checkbox-group label {display: flex !important;align-items: center !important;font-size: 11px !important;padding: 4px 4px !important;background: rgba(255,255,255,0.05) !important;border-radius: 6px !important;margin: 0 !important;min-height: 32px !important;height: 32px !important;width: 100% !important;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
    #reprogramacion .checkbox-group input[type="checkbox"] {-webkit-appearance: none !important;width: 14px !important;height: 14px !important;border: 2px solid #666 !important;border-radius: 3px !important;background: #e0e0e0 !important;margin-right: 6px !important;position: relative !important;flex-shrink: 0 !important;}
    #reprogramacion .checkbox-group input[type="checkbox"]:checked {background: #1E90FF !important;border-color: #1E90FF !important;}
    #reprogramacion .checkbox-group input[type="checkbox"]:checked::after {content: "‚úì" !important;position: absolute !important;color: white !important;font-size: 10px !important;font-weight: bold !important;top: 50% !important;left: 50% !important;transform: translate(-50%, -50%) !important;}
}

@media (max-width: 980px) {
    .productos {grid-template-columns: 1fr;gap: 18px;}
    .producto {min-height: auto;}
    .grid {grid-template-columns: 1fr;gap: 20px;}
    .panel, .imagenes-derecha, .texto-pagos {margin-left: 0;}
    .nav-links{display:none !important;}
    .hamburger{display:inline-block !important;}
    .side-menu{width:86%}
    .brand .logo {width: 60px;height: 60px;margin-top: 0;margin-bottom: 0;}
    .categorias-grid {grid-template-columns: repeat(2, 1fr);}
    .archivos-grid {grid-template-columns: 1fr;}
    .imagenes-derecha {display: none;}
}

@media (max-width: 600px) {
    .categorias-grid {grid-template-columns: 1fr;}
    .modal-content {padding: 20px;}
    .modal-title {font-size: 1.3rem;}
    input, select, textarea {padding: 16px !important;min-height: 54px !important;}
    .cta, button {min-height: 54px !important;padding: 16px 20px !important;}
}

#reservasH, #reprogH {color: #ffffff !important;}
#contacto {color: #ffffff !important;}
#contacto h2, #contacto p, #contacto label, #contacto h4, #contacto a, #contacto div {color: #ffffff !important;}
#contacto input, #contacto textarea {color: #000000 !important;background: #e0e0e0 !important;}
#contacto ::placeholder {color: #000000 !important;}
#btnPagar {background: linear-gradient(135deg, var(--purple), var(--accent)) !important;}
button[type="reset"] {background: white !important;color: #000000 !important;border: 0 !important;border-radius: 12px !important;padding: 12px 18px !important;font-weight: 700 !important;display: inline-block !important;}

@media (max-width: 768px) {
    .form-row {gap: 8px !important;margin-bottom: 12px !important;}
    #formReserva .form-row:nth-child(1), #formReprog .form-row:nth-child(1) {margin-bottom: 8px !important;}
    #formReprog .form-row:nth-child(2) {margin-bottom: 8px !important;}
    #formReserva .form-row:nth-child(3) {display: flex;flex-direction: column;width: 100%;}
    #formReserva .form-row:nth-child(3) .col {width: 100% !important;margin-right: 0 !important;}
    #formReserva .form-row:nth-child(3) .col:last-child {margin-top: 8px;}
    #comentariosECU {min-height: 120px !important;}
    .cta, button {padding: 10px 14px !important;font-size: 14px !important;min-height: 44px !important;}
    #formReserva .form-row:nth-child(1), #formReserva .form-row:nth-child(2), #formReprog .form-row:nth-child(1), #formReprog .form-row:nth-child(2) {flex-direction: column !important;}
    #formReserva .form-row:nth-child(1) .col:first-child, #formReserva .form-row:nth-child(2) .col:first-child, #formReprog .form-row:nth-child(1) .col:first-child, #formReprog .form-row:nth-child(2) .col:first-child {margin-bottom: 15px;}
    #reservas button.cta, #reprogramacion button.cta, #reservas button[type="reset"], #reprogramacion button[type="reset"] {padding: 10px 16px !important;font-size: 14px !important;min-height: 44px !important;}
}

@media (min-width: 981px) {
    .checkbox-group label:last-child input[type="checkbox"] {position: relative;right: 35px;}
}

.g-recaptcha {margin: 15px 0;display: flex;justify-content: center;}

#datosClienteModal .modal-content {max-width: 500px;}
#formDatosCliente input {width: 100%;padding: 12px;margin-bottom: 15px;border-radius: 8px;border: 0;background: #e0e0e0;color: #000000;}
#formDatosCliente label {display: block;margin-bottom: 5px;color: var(--text);font-weight: 600;}
.btn-secondary {background: rgba(255,255,255,0.1);border: 1px solid rgba(255,255,255,0.2);color: var(--text);padding: 10px 20px;border-radius: 8px;cursor: pointer;font-weight: 600;}
.btn-secondary:hover {background: rgba(255,255,255,0.2);}

.success{background:#e6ffed;border:1px solid #2db33a;padding:10px;margin-top:10px;border-radius:6px;color:#000000}
.error{background:#fff1f0;border:1px solid #ff4d4f;padding:10px;margin-top:10px;border-radius:6px;color:#000000}

html { scroll-behavior: smooth; }
body { font-family: 'Inter', sans-serif; color: var(--text); background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%); }
form {background: var(--card-bg);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.06);padding:1.5rem;margin-top:1rem;}
button, input, select, textarea {transition: all 0.2s ease;}
button:hover {transform: scale(1.02);box-shadow: 0 0 8px rgba(27,79,114,0.3);}
footer {background: rgba(0,0,0,0.2);color: var(--text);padding:1rem;text-align:center;font-size:0.9rem;border-top:4px solid rgba(255,255,255,0.1);margin-top:2rem;}
.file-input-container label {font-weight:600;color: var(--text);}
.swal2-popup {font-family: 'Inter', sans-serif !important;}
</style>
<link rel="icon" href="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png" type="image/png">
</head>
<body>
<nav aria-label="Navegaci√≥n principal" class="nav" role="navigation">
<div class="nav-inner">
<div class="brand">
<div class="logo">
  <img src="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png" alt="ReproGarage Logo">
</div>
<div>
<h3 style="margin:0">ReproGarage.es</h3>
<div style="font-size:12px;color:var(--muted)">Tuning ¬∑ Reprogramaciones ¬∑ Servicios</div>
</div>
</div>
<div class="nav-links" role="menubar">
<a href="#productos" role="menuitem">Archivos ECU</a>
<a href="#carrito" role="menuitem" onclick="scrollToCarrito()">Carrito</a>
<a href="#reservas" role="menuitem">Reservar</a>
<a href="#reprogramacion" role="menuitem">Reprogramaci√≥n</a>
<a href="#contacto" role="menuitem" onclick="scrollToContacto()">Contacto</a>
</div>
<button aria-controls="sideMenu" aria-expanded="false" aria-label="Abrir men√∫" class="hamburger" id="btnHamb">
<svg aria-hidden="true" fill="none" height="26" viewbox="0 0 24 24" width="26"><path d="M4 7h16M4 12h16M4 17h16" stroke="white" stroke-linecap="round" stroke-width="2"></path></svg>
</button>
</div>
</nav>

<aside aria-hidden="true" class="side-menu" id="sideMenu">
<button aria-label="Cerrar men√∫" class="side-close" id="btnClose">‚úï</button>
<h4>Men√∫</h4>
<a href="#productos" onclick="handleMenuClick('productos')">Archivos ECU</a>
<a href="#carrito" onclick="handleMenuClick('carrito')">Carrito</a>
<a href="#reservas" onclick="handleMenuClick('reservas')">Reservar</a>
<a href="#reprogramacion" onclick="handleMenuClick('reprogramacion')">Reprogramaci√≥n</a>
<a href="#contacto" onclick="handleMenuClick('contacto')">Contacto</a>
<div style="margin-top:auto;color:var(--muted);font-size:0.92rem">
<strong>Contacto</strong><br/>
    Iv√°n - 644 777 079
  </div>
</aside>

<header class="main-header" role="banner">
<div class="hero-inner wrap">
<h1 class="hero-title">ReproGarage ‚Äî Reprogramaci√≥n de ECU Profesional</h1>
<p class="hero-sub">Archivos Stage 1 y Stage 2 ¬∑ Reprogramaciones a medida para particulares y talleres en Espa√±a</p>
</div>
</header>

<main class="wrap" id="main">
<div aria-label="Cat√°logo y carrito" class="grid" role="region">
<section aria-labelledby="productosH" id="productos">
<h2 id="productosH">Archivos ECU Disponibles</h2>
<p style="color:var(--muted);margin-bottom:16px;">Selecciona el archivo que mejor se adapte a tu veh√≠culo</p>
<div class="productos" role="list">
<article class="producto" role="listitem">
<img alt="Stage 1 - optimizaci√≥n para uso diario" height="200" loading="lazy" src="https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 1 - Optimizaci√≥n diaria</h4>
<p style="color:var(--muted);font-size:0.95rem;">Mejora de respuesta y eficiencia, sin modificaciones hardware.</p>
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Incluye ajuste de mapa motor y optimizaci√≥n de curva de par
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 1')" style="margin-top:auto;">Ver archivos</button>
</article>
<article class="producto" role="listitem">
<img alt="Stage 2 - optimizaci√≥n rendimiento" height="200" loading="lazy" src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 2 - Performance</h4>
<p style="color:var(--muted);font-size:0.95rem;">Manejo avanzado del motor para veh√≠culos con mejoras hardware.</p>
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Mapeo optimizado y calibraciones espec√≠ficas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 2')" style="margin-top:auto;">Ver archivos</button>
</article>
<article class="producto" role="listitem">
<img alt="Personalizado - eliminaciones y optimizaciones avanzadas" height="200" loading="lazy" src="https://images.unsplash.com/photo-1563720223185-11003d516935?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Personalizado - Eliminaciones Avanzadas</h4>
<p style="color:var(--muted);font-size:0.95rem;">Eliminaci√≥n de EGR, AdBlue, DTCs, pops and bangs, l√≠mite de corte y m√°s opciones.</p>
<div style="margin:12px 0;padding:10px;background:rgba(218,112,214,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Incluye eliminaciones personalizadas y optimizaciones espec√≠ficas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Personalizado')" style="margin-top:auto;">Ver archivos</button>
</article>
</div>
</section>

<aside aria-label="Carrito y acciones">
<div aria-live="polite" class="panel" id="carrito">
<h3>Tu Carrito</h3>
<ul class="cart-list" id="cartList"></ul>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px"><strong>Total</strong><div id="cartTotal">‚Ç¨0</div></div>
<div style="margin-top:12px;display:flex;gap:10px;">
<button class="cta" id="btnPagar" onclick="procederPago()" style="flex:1">Pagar</button>
<button class="cta" id="btnVaciar" style="flex:1;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)">Vaciar</button>
</div>
</div>

<div class="texto-pagos">
  <div>Medios de pago seguros ¬∑ Env√≠o digital inmediato</div>
</div>

<div class="imagenes-derecha">
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=600&q=80" alt="Herramienta profesional para reprogramaci√≥n ECU">
    <div class="imagen-contenido">
      <h4>KessV3 Professional</h4>
      <p>Equipo profesional KessV3 para lectura y escritura de ECU. Tecnolog√≠a de √∫ltima generaci√≥n</p>
    </div>
  </div>
  
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=600&q=80" alt="An√°lisis especializado de centralitas">
    <div class="imagen-contenido">
      <h4>An√°lisis Especializado</h4>
      <p>T√©cnicos cualificados creando mapas personalizados para m√°ximo rendimiento</p>
    </div>
  </div>
</div>
</aside>
</div>

<section aria-labelledby="reservasH" id="reservas" style="margin-top:36px;">
<h2 id="reservasH">Reservar Servicio Presencial</h2>
<p style="color:var(--muted);margin-bottom:16px;">Agenda tu cita para reprogramaci√≥n presencial</p>
<div class="form-card" style="max-width:900px;margin:0 auto">
<form id="formReserva" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreRes">Nombre y apellidos</label><input id="nombreRes" maxlength="100" name="nombreRes" placeholder="Ej: Juan P√©rez" required="" type="text"/></div>
<div class="col"><label for="telefonoRes">Tel√©fono</label><input id="telefonoRes" maxlength="15" name="telefonoRes" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailRes">Email</label><input id="emailRes" maxlength="254" name="emailRes" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="fechaRes">Fecha</label><input id="fechaRes" name="fechaRes" placeholder="Ej: ejemplo" required="" type="date"/></div>
</div>
<div class="form-row">
<div class="col"><label for="horaRes">Hora</label>
<select id="horaRes" name="horaRes">
  <option value="">Selecciona hora</option>
  <option>08:00</option><option>09:00</option><option>10:00</option><option>11:00</option>
  <option>12:00</option><option>13:00</option><option>14:00</option><option>15:00</option>
  <option>16:00</option><option>17:00</option><option>18:00</option>
</select>
</div>
<div class="col"><label for="vehiculoRes">Marca y modelo</label><input id="vehiculoRes" maxlength="100" name="vehiculoRes" placeholder="Ej: BMW 320d 2019" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="localidadRes">Localidad del servicio</label><input id="localidadRes" maxlength="100" name="localidadRes" placeholder="Ej: Santander" required="" type="text"/></div></div>
<div class="form-row"><div class="col"><label for="dynoactiveRes">DynoActive (resultados de par y cv)</label><select id="dynoactiveRes" name="dynoactiveRes" required=""><option value="">Selecciona</option><option value="si">S√≠</option><option value="no">No</option></select></div></div>
<label for="detallesRes">Detalles del veh√≠culo y servicio</label>
<textarea id="detallesRes" maxlength="1000" name="detallesRes" placeholder="Ej: BMW 320d 2019, matr√≠cula 1234ABC, Stage 1..." required="" style="color:var(--muted)"></textarea>

<div id="recaptchaReserva"></div>

<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta"  id="btnEnviarReserva" type="button">Reservar ahora</button><button type="reset">Limpiar</button></div>
<div id="statusRes" aria-live="polite"></div>
</form>
</div>
</section>

<section aria-labelledby="reprogH" id="reprogramacion" style="margin-top:36px;">
<h2 id="reprogH">Solicitud de Reprogramaci√≥n</h2>
<p style="color:var(--muted);margin-bottom:16px;">Proporciona los datos del veh√≠culo para una reprogramaci√≥n a medida</p>
<div class="form-card" style="max-width:920px;margin:0 auto">
<form id="formReprog" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreReprog">Nombre y apellidos</label><input id="nombreReprog" maxlength="100" name="nombreReprog" placeholder="Ej: Juan P√©rez" required="" type="text"/></div>
<div class="col"><label for="telefonoReprog">Tel√©fono</label><input id="telefonoReprog" maxlength="15" name="telefonoReprog" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailReprog">Email</label><input id="emailReprog" maxlength="254" name="emailReprog" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="marcaCoche">Marca</label><input id="marcaCoche" maxlength="50" name="marcaCoche" placeholder="Ej: BMW, Audi" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="col"><label for="modeloCoche">Modelo</label><input id="modeloCoche" maxlength="50" name="modeloCoche" placeholder="Ej: 320d, A4" required="" type="text"/></div>
<div class="col"><label for="anioCoche">A√±o</label><input id="anioCoche" max="2099" min="1900" name="anioCoche" placeholder="Ej: 2019" required="" type="number"/></div>
</div>
<div class="form-row">
<div class="col"><label for="potenciaECU">Potencia (kW)</label><input id="potenciaECU" max="2000" min="1" name="potenciaECU" placeholder="Ej: 140" required="" type="number"/></div>
<div class="col"><label for="marcaECU">Marca de ECU</label><input id="marcaECU" maxlength="50" name="marcaECU" placeholder="Ej: Bosch" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="serieECU">N√∫mero de serie ECU</label><input id="serieECU" maxlength="50" name="serieECU" placeholder="Ej: EDC17C50" required="" type="text"/></div></div>

<label>Opciones de modificaci√≥n</label>
<div aria-label="Opciones de modificaci√≥n" class="checkbox-group" role="group">
  <label><input name="opciones" type="checkbox" value="Stage 1"/> Stage 1</label>
  <label><input name="opciones" type="checkbox" value="Stage 2"/> Stage 2</label>
  <label><input name="opciones" type="checkbox" value="EGR"/> EGR</label>
  <label><input name="opciones" type="checkbox" value="AdBlue"/> AdBlue</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DTCs"/> Eliminar DTCs</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DPF"/> Eliminar DPF</label>
  <label><input name="opciones" type="checkbox" value="Inmo"/> Inmo</label>
  <label><input name="opciones" type="checkbox" value="Pops and bangs"/> Pops and bangs</label>
  <label><input name="opciones" type="checkbox" value="L√≠mite de corte"/> L√≠mite de corte</label>
</div>
<label for="comentariosECU">Informaci√≥n adicional</label>
<textarea id="comentariosECU" maxlength="2000" name="comentariosECU" placeholder="Ej: Modificaciones hechas al veh√≠culo (downpipe, EGR anulada, escape 2.5 pulgadas, etc.)" style="color:var(--muted)"></textarea>

<div id="recaptchaReprog"></div>

<div class="file-input-container" style="margin-top:10px;">
  <label class="file-input-label" for="archivoReprog">Adjuntar archivo (opcional) ‚Äî .bin .zip .rar .7z .gz .tar</label>
  <input id="archivoReprog" class="file-input" type="file" accept=".bin,.zip,.rar,.7z,.gz,.tar" />
</div>
<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta"  id="btnEnviarReprogramacion" type="button">Solicitar reprogramaci√≥n</button><button type="reset">Limpiar</button></div>
<div id="status" aria-live="polite"></div>
</form>
</div>
</section>
</main>

<footer id="contacto" style="padding:40px 20px;background:rgba(0,0,0,0.2);margin-top:60px;">
<div style="max-width:1140px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:30px;">
<div>
<h4 style="margin-bottom:8px">ReproGarage</h4>
<p style="color:var(--muted);font-size:0.9rem;line-height:1.6">Reprogramaci√≥n ECU y servicios of tuning profesional. Equipos profesionales para lectura y escritura de centralitas (Kess3, ECM Titanium).</p>
</div>
<div>
<h4 style="margin-bottom:8px">Contacto</h4>
<p style="color:var(--muted);font-size:0.9rem">info@reprogarage.es<br/>Iv√°n - 644 777 079<br/>Horario: Lun-Vie 08:00-19:00</p>
</div>
<div>
<h4 style="margin-bottom:8px">Enlaces</h4>
<div style="display:flex;flex-direction:column;gap:8px;color:var(--muted)"><a href="#productos">Archivos ECU</a><a href="#reservas">Reservar cita</a><a href="#reprogramacion">Reprogramaci√≥n</a><a href="#contacto" onclick="scrollToContacto()">Contacto</a></div>
</div>
</div>
<div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:30px;padding-top:20px;text-align:center;color:var(--muted);font-size:0.85rem">¬© <span id="year">2025</span> ReproGarage.es</div>
</footer>

<a aria-label="Contactar por WhatsApp" href="https://wa.me/34644777079?text=Hola%20ReproGarage,%20quiero%20informaci%C3%B3n%20sobre%20reprogramaci%C3%B3n" id="whatsappCTA" rel="noopener noreferrer" target="_blank">
  <svg width="32" height="32" viewBox="0 0 32 32" fill="white">
    <path d="M16 0C7.164 0 0 7.164 0 16c0 2.825.748 5.476 2.053 7.764L0 32l8.516-2.053C10.732 31.338 13.323 32 16 32c8.836 0 16-7.164 16-16S24.836 0 16 0zm7.914 22.375c-.297.834-1.484 1.525-2.422 1.617-.297.033-1.813.297-5.008-1.617-3.195-1.914-5.213-5.545-5.378-5.801-.165-.256-1.352-1.813-1.352-3.461s.843-2.422 1.156-2.734c.313-.313.678-.396.909-.396.231 0 .462 0 .66.033.198.033.462.066.66.429.198.363.66 1.254.726 1.352.066.099.132.231.066.396-.066.165-.066.297-.132.429-.066.132-.66.759-.909 1.023-.231.264-.462.396-.396.66.066.264.66 1.155 1.419 1.875.99.957 1.815 1.254 2.079 1.419.264.165.413.132.578.066.165-.066.99-.429 1.254-.578.264-.149.462-.099.66.033.198.132.99.578 1.155.678.165.099.33.165.33.33 0 .165-.033.264-.198.429z"/>
  </svg>
</a>

<button aria-label="Volver arriba" id="backToTop" title="Volver arriba">‚Üë</button>

<!-- MODALES -->
<div id="catalogoModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitulo">üìÅ Cat√°logo de Archivos ECU</h2>
      <button class="close-btn" id="closeCatalogBtn">‚úï</button>
    </div>
    <p style="color: var(--muted); margin-bottom: 25px; text-align: center;">
      Selecciona la marca de tu veh√≠culo para ver los archivos disponibles
    </p>
    <div class="categorias-grid" id="categoriasGrid"></div>
    <div class="subcategorias" id="subcategorias">
      <h3 class="subcategoria-title" id="subcategoriaTitle">Selecciona un modelo</h3>
      <div class="filtros" id="filtros"></div>
      <div class="archivos-grid" id="archivosGrid"></div>
    </div>
  </div>
</div>

<div id="datosClienteModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üìß Tus datos para la descarga</h2>
      <button class="close-btn" id="closeDatosBtn">‚úï</button>
    </div>
    <div style="padding: 20px;">
      <p style="color: var(--muted); margin-bottom: 20px;">
        Para enviarte los archivos de descarga, necesitamos tu email y nombre.
      </p>
      <form id="formDatosCliente">
        <div style="margin-bottom: 15px;">
          <label for="clienteNombre">Nombre completo</label>
          <input type="text" id="clienteNombre" required placeholder="Ej: Juan P√©rez">
        </div>
        <div style="margin-bottom: 20px;">
          <label for="clienteEmail">Email</label>
          <input type="email" id="clienteEmail" required placeholder="ejemplo@email.com">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" id="cancelarDatosBtn" class="btn-secondary">Cancelar</button>
          <button type="submit" class="cta">Continuar con el pago</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="modalDescargas" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üéâ ¬°Pago Completado!</h2>
      <button class="close-btn" onclick="cerrarModalDescargas()">‚úï</button>
    </div>
    <div id="contenidoDescargas"></div>
  </div>
</div>

<!-- SCRIPT DE reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>

<!-- SCRIPT PRINCIPAL COMPLETO Y SEGURO -->
<script>
// ============================
// CONFIGURACI√ìN SEGURA
// ============================
const WORKER_URL = 'https://curly-hall-2272.ivansomarriba92.workers.dev/';

// ============================
// SISTEMA SEGURO DE FIREBASE
// ============================
class SecureFirebaseManager {
  constructor() {
    this.config = null;
    this.isInitialized = false;
  }

  async initialize() {
    try {
      const response = await fetch(WORKER_URL + 'api/firebase-config');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      this.config = await response.json();
      
      if (this.config && this.config.apiKey) {
        if (!firebase.apps.length) {
          firebase.initializeApp(this.config);
          this.isInitialized = true;
          console.log('‚úÖ Firebase inicializado de forma segura');
          this.enableFirebaseFeatures();
        }
      } else {
        throw new Error('Configuraci√≥n de Firebase no v√°lida');
      }
    } catch (error) {
      console.error('‚ùå Error inicializando Firebase:', error);
      this.disableFirebaseFeatures();
    }
  }

  enableFirebaseFeatures() {
    const fileInput = document.getElementById('archivoReprog');
    if (fileInput) fileInput.disabled = false;
  }

  disableFirebaseFeatures() {
    const fileInput = document.getElementById('archivoReprog');
    if (fileInput) {
      fileInput.disabled = true;
      fileInput.placeholder = 'Subida temporalmente deshabilitada';
    }
  }

  async uploadFile(file) {
    if (!this.isInitialized) throw new Error('Firebase no est√° inicializado');
    try {
      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child('uploads/' + Date.now() + '_' + file.name);
      const snapshot = await fileRef.put(file);
      const downloadURL = await snapshot.ref.getDownloadURL();
      return { success: true, url: downloadURL };
    } catch (error) {
      console.error('Error subiendo archivo:', error);
      return { success: false, error: error.message };
    }
  }
}

// ============================
// SISTEMA DE CARRITO
// ============================
window.appState = { carrito: [] };

const archivosECU = {
    'audi_stage1': { nombre: 'Audi Stage 1', precio: 179, archivo: 'Audi_Stage1.bin', rutaFirebase: 'archivos/Audi/Audi_Stage1.bin', compatibilidad: 'Audi 2015-2020' },
    'audi_stage2': { nombre: 'Audi Stage 2', precio: 219, archivo: 'Audi_Stage2.bin', rutaFirebase: 'archivos/Audi/Audi_Stage2.bin', compatibilidad: 'Audi 2015-2020 con modificaciones' },
    'bmw_stage1': { nombre: 'BMW Stage 1', precio: 179, archivo: 'BMW_Stage1.bin', rutaFirebase: 'archivos/BMW/BMW_Stage1.bin', compatibilidad: 'BMW 2015-2020' },
    'bmw_stage2': { nombre: 'BMW Stage 2', precio: 219, archivo: 'BMW_Stage2.bin', rutaFirebase: 'archivos/BMW/BMW_Stage2.bin', compatibilidad: 'BMW 2015-2020 con modificaciones' },
    'mercedes_stage1': { nombre: 'Mercedes Stage 1', precio: 179, archivo: 'Mercedes_Stage1.bin', rutaFirebase: 'archivos/Mercedes/Mercedes_Stage1.bin', compatibilidad: 'Mercedes 2015-2020' },
    'mercedes_stage2': { nombre: 'Mercedes Stage 2', precio: 219, archivo: 'Mercedes_Stage2.bin', rutaFirebase: 'archivos/Mercedes/Mercedes_Stage2.bin', compatibilidad: 'Mercedes 2015-2020 con modificaciones' },
    'volkswagen_stage1': { nombre: 'Volkswagen Stage 1', precio: 179, archivo: 'Volkswagen_Stage1.bin', rutaFirebase: 'archivos/Volkswagen/Volkswagen_Stage1.bin', compatibilidad: 'Volkswagen 2015-2020' },
    'volkswagen_stage2': { nombre: 'Volkswagen Stage 2', precio: 219, archivo: 'Volkswagen_Stage2.bin', rutaFirebase: 'archivos/Volkswagen/Volkswagen_Stage2.bin', compatibilidad: 'Volkswagen 2015-2020 con modificaciones' }
};

function agregarAlCarrito(id, nombre, precio) {
  const productoExistente = window.appState.carrito.find(item => item.id === id);
  if (productoExistente) {
    productoExistente.cantidad += 1;
  } else {
    window.appState.carrito.push({ id, nombre, precio, cantidad: 1 });
  }
  guardarCarrito();
  actualizarCarrito();
  cerrarCatalogo();
  mostrarNotificacion(`${nombre} a√±adido al carrito`, 'success');
  setTimeout(() => scrollToCarrito(), 500);
}

function actualizarCarrito() {
  const container = document.getElementById('cartList');
  const totalElement = document.getElementById('cartTotal');
  const checkoutBtn = document.getElementById('btnPagar');
  
  if (!container) return;
  
  if (window.appState.carrito.length === 0) {
    container.innerHTML = '<li style="text-align:center;color:var(--muted);">Carrito vac√≠o</li>';
    if (totalElement) totalElement.textContent = '‚Ç¨0';
    if (checkoutBtn) checkoutBtn.disabled = true;
    return;
  }
  
  let html = '';
  let total = 0;
  
  window.appState.carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    total += subtotal;
    
    html += `
      <li style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03);">
        <div style="flex:1">
          <div style="font-weight:600">${item.nombre}</div>
          <div style="font-size:0.8rem;color:var(--muted)">Cantidad: ${item.cantidad}</div>
        </div>
        <div style="text-align:right">
          <div>${subtotal}‚Ç¨</div>
          <button onclick="eliminarDelCarrito('${item.id}')" style="background:none;border:none;color:#ff6b6b;font-size:0.8rem;cursor:pointer">Eliminar</button>
        </div>
      </li>
    `;
  });
  
  container.innerHTML = html;
  if (totalElement) totalElement.textContent = `‚Ç¨${total.toFixed(2)}`;
  if (checkoutBtn) checkoutBtn.disabled = false;
}

function eliminarDelCarrito(id) {
  window.appState.carrito = window.appState.carrito.filter(item => item.id !== id);
  guardarCarrito();
  actualizarCarrito();
}

function vaciarCarrito() {
  if (window.appState.carrito.length === 0) {
    mostrarNotificacion('El carrito ya est√° vac√≠o', 'info');
    return;
  }
  
  if (confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
    window.appState.carrito = [];
    localStorage.removeItem('reprogarage-carrito');
    guardarCarrito();
    actualizarCarrito();
    mostrarNotificacion('Carrito vaciado correctamente', 'success');
  }
}

function guardarCarrito() {
  try {
    localStorage.setItem('reprogarage-carrito', JSON.stringify(window.appState.carrito));
  } catch (e) {
    console.warn('No se pudo guardar el carrito:', e);
  }
}

function cargarCarrito() {
  try {
    const carritoGuardado = localStorage.getItem('reprogarage-carrito');
    if (carritoGuardado) window.appState.carrito = JSON.parse(carritoGuardado);
  } catch (e) {
    console.warn('No se pudo cargar el carrito:', e);
  }
  actualizarCarrito();
}

// ============================
// FUNCIONES DE FORMULARIO
// ============================
let widgetReserva = null;
let widgetReprog = null;

function onloadRecaptcha() {
  if (typeof grecaptcha === 'undefined') return;
  try {
    widgetReserva = grecaptcha.render('recaptchaReserva', { 'sitekey': '6LcBivIrAAAAALSzLolJNtTZT3YBK4V7XpVR40bR' });
  } catch(e){ console.warn(e) }
  try {
    widgetReprog = grecaptcha.render('recaptchaReprog', { 'sitekey': '6LcBivIrAAAAALSzLolJNtTZT3YBK4V7XpVR40bR' });
  } catch(e){ console.warn(e) }
}

function getRecaptchaTokenReserva(){ return widgetReserva ? grecaptcha.getResponse(widgetReserva) : ''; }
function getRecaptchaTokenReprog(){ return widgetReprog ? grecaptcha.getResponse(widgetReprog) : ''; }

function showStatus(el, msg, ok=true){
  el.innerHTML = ok ? '<div class="success">'+msg+'</div>' : '<div class="error">'+msg+'</div>';
}

function clearStatus(el){ el.innerHTML = ''; }

function collectReprogForm(){
  return {
    nombre: document.getElementById('nombreReprog').value.trim(),
    telefono: document.getElementById('telefonoReprog').value.trim(),
    email: document.getElementById('emailReprog').value.trim(),
    marca: document.getElementById('marcaCoche').value.trim(),
    modelo: document.getElementById('modeloCoche').value.trim(),
    anio: document.getElementById('anioCoche').value.trim(),
    potencia: document.getElementById('potenciaECU').value.trim(),
    marcaECU: document.getElementById('marcaECU').value.trim(),
    serieECU: document.getElementById('serieECU').value.trim(),
    opciones: Array.from(document.querySelectorAll('#formReprog input[name="opciones"]:checked')).map(i=>i.value),
    comentarios: document.getElementById('comentariosECU').value.trim(),
    recaptchaToken: getRecaptchaTokenReprog()
  };
}

function collectReservaForm(){
  return {
    nombre: document.getElementById('nombreRes').value.trim(),
    telefono: document.getElementById('telefonoRes').value.trim(),
    email: document.getElementById('emailRes').value.trim(),
    fecha: document.getElementById('fechaRes').value,
    hora: document.getElementById('horaRes').value,
    vehiculo: document.getElementById('vehiculoRes').value.trim(),
    localidad: document.getElementById('localidadRes').value.trim(),
    dynoactive: document.getElementById('dynoactiveRes').value,
    detalles: document.getElementById('detallesRes').value.trim(),
    recaptchaToken: getRecaptchaTokenReserva()
  };
}

async function enviarReprogramacion() {
  const statusEl = document.getElementById('status');
  clearStatus(statusEl);
  const data = collectReprogForm();

  if(!data.nombre || !data.telefono || !data.email){
    showStatus(statusEl,'Completa nombre, tel√©fono y email', false); return;
  }
  if(!data.serieECU){
    showStatus(statusEl,'Introduce el n√∫mero de serie de la ECU', false); return;
  }

  let fileUrl = null;
  const fileInput = document.getElementById('archivoReprog');
  if (fileInput && fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    const allowed = ['.bin','.zip','.rar','.7z','.gz','.tar'];
    const name = file.name.toLowerCase();
    const ext = name.slice(name.lastIndexOf('.'));
    if (!allowed.includes(ext)) {
      showStatus(statusEl, 'Extensiones permitidas: ' + allowed.join(', '), false);
      return;
    }
    if (file.size > 20 * 1024 * 1024) {
      showStatus(statusEl, 'M√°ximo permitido: 20MB', false);
      return;
    }

    try {
      showStatus(statusEl,'Subiendo archivo...');
      if (window.firebaseManager && window.firebaseManager.isInitialized) {
        const uploadResult = await window.firebaseManager.uploadFile(file);
        if (uploadResult.success) fileUrl = uploadResult.url;
      }
    } catch (e) {
      console.error('Upload error', e);
      showStatus(statusEl,'Error subiendo archivo: ' + (e.message || e), false);
      return;
    }
  }

  const payload = {
    type: "reprogramacion",
    nombre: data.nombre,
    telefono: data.telefono,
    email: data.email,
    marca: data.marca,
    modelo: data.modelo,
    anio: data.anio,
    potencia: data.potencia,
    marcaECU: data.marcaECU,
    serieECU: data.serieECU,
    opciones: data.opciones,
    comentarios: data.comentarios,
    fileUrl: fileUrl,
    recaptchaToken: data.recaptchaToken || ''
  };

  try {
    showStatus(statusEl,'Enviando solicitud...');
    const resp = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await resp.json();
    if (!resp.ok || !json.success) throw new Error(json.error || 'Error en el servidor');
    
    showStatus(statusEl,'Solicitud enviada correctamente.');
    document.getElementById('formReprog').reset();
    if (typeof grecaptcha !== 'undefined' && widgetReprog) grecaptcha.reset(widgetReprog);
  } catch (err) {
    console.error('Send error', err);
    showStatus(statusEl,'Error enviando: ' + (err.message||err), false);
  }
}

async function enviarReserva(){
  const statusEl = document.getElementById('statusRes');
  clearStatus(statusEl);
  const data = collectReservaForm();
  if(!data.nombre || !data.telefono || !data.email){
    showStatus(statusEl,'Completa nombre, tel√©fono y email', false); return;
  }
  
  const payload = {
    type: 'reserva',
    nombre: data.nombre,
    telefono: data.telefono,
    email: data.email,
    fecha: data.fecha,
    hora: data.hora,
    vehiculo: data.vehiculo,
    localidad: data.localidad,
    dynoactive: data.dynoactive,
    detalles: data.detalles,
    recaptchaToken: data.recaptchaToken || ''
  };
  
  try {
    showStatus(statusEl,'Enviando reserva...');
    const resp = await fetch(WORKER_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await resp.json();
    if(!resp.ok || !json.success) throw new Error(json.error || 'Error en servidor');
    
    showStatus(statusEl,'Reserva enviada correctamente.');
    document.getElementById('formReserva').reset();
    if (typeof grecaptcha !== 'undefined' && widgetReserva) grecaptcha.reset(widgetReserva);
  } catch (e) {
    console.error(e);
    showStatus(statusEl,'Error: ' + (e.message||e), false);
  }
}

// ============================
// FUNCIONES DE NAVEGACI√ìN
// ============================
function handleMenuClick(target) {
  closeMenu();
  setTimeout(() => {
    switch(target) {
      case 'carrito': scrollToCarrito(); break;
      case 'contacto': scrollToContacto(); break;
      default:
        const element = document.getElementById(target);
        if (element) element.scrollIntoView({ behavior: 'smooth' });
    }
  }, 350);
}

function closeMenu() {
  const sideMenu = document.getElementById('sideMenu');
  const btnHamb = document.getElementById('btnHamb');
  if (sideMenu) {
    sideMenu.classList.remove('open');
    sideMenu.setAttribute('aria-hidden','true');
  }
  if (btnHamb) btnHamb.setAttribute('aria-expanded','false');
  document.body.style.overflow = 'auto';
  document.body.style.position = 'static';
  document.body.style.width = 'auto';
}

function openMenu() {
  const sideMenu = document.getElementById('sideMenu');
  const btnHamb = document.getElementById('btnHamb');
  if (sideMenu) {
    sideMenu.classList.add('open');
    sideMenu.setAttribute('aria-hidden','false');
  }
  if (btnHamb) btnHamb.setAttribute('aria-expanded','true');
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.width = '100%';
}

function scrollToCarrito() {
  setTimeout(() => {
    const carritoElement = document.getElementById('carrito');
    if (carritoElement) {
      const carritoPosition = carritoElement.getBoundingClientRect().top + window.pageYOffset;
      const offset = window.innerHeight * 0.1;
      const targetPosition = carritoPosition - offset;
      window.scrollTo({ top: targetPosition, behavior: 'smooth' });
    }
  }, 100);
}

function scrollToContacto() {
  setTimeout(() => {
    const contactoElement = document.getElementById('contacto');
    if (contactoElement) {
      const contactoPosition = contactoElement.getBoundingClientRect().top + window.pageYOffset;
      const offset = window.innerHeight * 0.1;
      const targetPosition = contactoPosition - offset;
      window.scrollTo({ top: targetPosition, behavior: 'smooth' });
    }
  }, 100);
}

// ============================
// FUNCIONES DEL CAT√ÅLOGO
// ============================
function mostrarCatalogo(tipo) {
  const modal = document.getElementById('catalogoModal');
  const titulo = document.getElementById('modalTitulo');
  titulo.textContent = `üìÅ Cat√°logo ${tipo} - Archivos ECU`;
  modal.style.display = 'flex';
  
  // Simulaci√≥n de categor√≠as
  const categorias = [
    { id: 'audi', nombre: 'Audi', logo: 'https://cdn.worldvectorlogo.com/logos/audi-9.svg' },
    { id: 'bmw', nombre: 'BMW', logo: 'https://cdn.worldvectorlogo.com/logos/bmw-2020.svg' },
    { id: 'mercedes', nombre: 'Mercedes', logo: 'https://cdn.worldvectorlogo.com/logos/mercedes-benz-2021.svg' },
    { id: 'volkswagen', nombre: 'Volkswagen', logo: 'https://cdn.worldvectorlogo.com/logos/volkswagen-2020.svg' }
  ];
  
  const grid = document.getElementById('categoriasGrid');
  grid.innerHTML = categorias.map(cat => `
    <button class="categoria-btn" onclick="seleccionarCategoria('${cat.id}', '${cat.nombre}', '${tipo}')">
      <img src="${cat.logo}" alt="${cat.nombre}" class="logo-marca">
      ${cat.nombre}
    </button>
  `).join('');
}

function seleccionarCategoria(categoriaId, categoriaNombre, tipo) {
  const subcategorias = document.getElementById('subcategorias');
  const titulo = document.getElementById('subcategoriaTitle');
  titulo.textContent = `${categoriaNombre} - ${tipo}`;
  subcategorias.classList.add('active');
  
  // Simulaci√≥n de modelos
  const modelos = ['A3', 'A4', 'A5', 'A6', 'Q3', 'Q5', 'Q7'];
  const filtros = document.getElementById('filtros');
  filtros.innerHTML = modelos.map(modelo => `
    <button class="filtro-btn" onclick="filtrarModelos('${modelo}')">${modelo}</button>
  `).join('');
  
  // Mostrar archivos disponibles
  const archivosGrid = document.getElementById('archivosGrid');
  const archivosFiltrados = Object.entries(archivosECU)
    .filter(([key]) => key.startsWith(categoriaId) && key.includes(tipo.toLowerCase().replace(' ', '')))
    .map(([id, archivo]) => `
      <div class="archivo-card">
        <div class="archivo-header">
          <h3 class="archivo-title">${archivo.nombre}</h3>
          <div class="archivo-precio">${archivo.precio}‚Ç¨</div>
        </div>
        <div class="archivo-info">${archivo.compatibilidad}</div>
        <div class="archivo-features">
          <span class="feature-tag">üíæ ${archivo.archivo}</span>
          <span class="feature-tag">üöó ${categoriaNombre}</span>
        </div>
        <button class="add-to-cart-btn" onclick="agregarAlCarrito('${id}', '${archivo.nombre}', ${archivo.precio})">
          üõí A√±adir al carrito
        </button>
      </div>
    `).join('');
  
  archivosGrid.innerHTML = archivosFiltrados;
}

function filtrarModelos(modelo) {
  // Implementar filtrado por modelo
  console.log('Filtrando por modelo:', modelo);
}

function cerrarCatalogo() {
  const modal = document.getElementById('catalogoModal');
  modal.style.display = 'none';
  const subcategorias = document.getElementById('subcategorias');
  subcategorias.classList.remove('active');
}

// ============================
// FUNCIONES DE PAGO
// ============================
function procederPago() {
  if (window.appState.carrito.length === 0) {
    mostrarNotificacion('El carrito est√° vac√≠o', 'error');
    return;
  }
  document.getElementById('datosClienteModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function cerrarModalDescargas() {
  document.getElementById('modalDescargas').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ============================
// UTILIDADES
// ============================
function mostrarNotificacion(mensaje, tipo = 'success') {
  Swal.fire({
    title: tipo === 'success' ? '‚úÖ √âxito' : '‚ùå Error',
    text: mensaje,
    icon: tipo,
    confirmButtonText: 'Aceptar',
    background: 'var(--card-bg)',
    color: 'var(--text)'
  });
}

// ============================
// INICIALIZACI√ìN
// ============================
document.addEventListener('DOMContentLoaded', async function() {
  // A√±o actual
  const yearEl = document.getElementById('year'); 
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // Inicializar Firebase de forma segura
  window.firebaseManager = new SecureFirebaseManager();
  await window.firebaseManager.initialize();

  // Event listeners
  const btnHamb = document.getElementById('btnHamb'); 
  if (btnHamb) btnHamb.addEventListener('click', openMenu);
  
  const btnClose = document.getElementById('btnClose');
  if (btnClose) btnClose.addEventListener('click', closeMenu);

  const backBtn = document.getElementById('backToTop'); 
  if (backBtn) {
    window.addEventListener('scroll', function() { 
      backBtn.style.display = window.scrollY > 400 ? 'flex' : 'none'; 
    }); 
    backBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
  }

  document.getElementById('btnEnviarReprogramacion').addEventListener('click', enviarReprogramacion);
  document.getElementById('btnEnviarReserva').addEventListener('click', enviarReserva);

  const btnVaciar = document.getElementById('btnVaciar');
  if (btnVaciar) btnVaciar.addEventListener('click', vaciarCarrito);

  // Cargar carrito
  cargarCarrito();

  // Prevenir env√≠o por defecto
  const formReserva = document.getElementById('formReserva'); 
  if (formReserva) formReserva.addEventListener('submit', e => e.preventDefault());
  
  const formReprog = document.getElementById('formReprog'); 
  if (formReprog) formReprog.addEventListener('submit', e => e.preventDefault());

  // Event listeners para modales
  document.getElementById('closeCatalogBtn').addEventListener('click', cerrarCatalogo);
  document.getElementById('closeDatosBtn').addEventListener('click', () => {
    document.getElementById('datosClienteModal').style.display = 'none';
    document.body.style.overflow = 'auto';
  });

  console.log('üîÑ ReproGarage inicializado correctamente');
});

// Prevenci√≥n contra clickjacking
if (self !== top) {
    top.location = self.location;
}
</script>
</body>
</html>