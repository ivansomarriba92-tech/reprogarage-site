<!DOCTYPE html>
<html lang="es">
<head>
  <!-- SECURITY HEADERS - MEJORADOS -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta content="nosniff" http-equiv="X-Content-Type-Options"/>
  <meta content="1; mode=block" http-equiv="X-XSS-Protection"/>
  <meta content="strict-origin-when-cross-origin" http-equiv="Referrer-Policy"/>
  
  <!-- CONTENT SECURITY POLICY - ROBUSTO -->
  <meta content="
    default-src 'self';
    script-src 'self' https://js.stripe.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com/;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://api.emailjs.com https://www.google.com/recaptcha/ https://curly-hall-2272.ivansomarriba92.workers.dev https://api.stripe.com;
    frame-src https://js.stripe.com https://www.google.com/recaptcha/;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  " http-equiv="Content-Security-Policy"/>

  <!-- SEO / Social meta tags -->
  <meta name="description" content="ReproGarage ‚Äî Reprogramaci√≥n de ECU, archivos Stage 1 y Stage 2. Reprogramaciones a medida para particulares y talleres en Espa√±a."/>
  <meta name="keywords" content="reprogramacion ECU, tuning, archivos stage 1, stage 2, reprogarage, reprogramacion coche, chip tuning, aumentar potencia"/>
  <meta property="og:locale" content="es_ES" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ReproGarage ‚Äî Reprogramaci√≥n de ECU Profesional" />
  <meta property="og:description" content="Archivos Stage 1/2 y reprogramaciones a medida. Servicios para particulares y talleres en Espa√±a. Reserva online y compra segura." />
  <meta property="og:url" content="https://reprogarage.es/" />
  <meta property="og:image" content="https://reprogarage.es/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@ReproGarage" />
  <meta name="twitter:title" content="ReproGarage ‚Äî Reprogramaci√≥n de ECU Profesional" />
  <meta name="twitter:description" content="Archivos Stage 1/2 y reprogramaciones a medida. Reserva online y compra segura." />
  <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Structured data (Organization) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "ReproGarage",
    "url": "https://reprogarage.es/",
    "logo": "https://reprogarage.es/logo.png",
    "contactPoint": [{"@type":"ContactPoint","telephone":"+34 644 777 079","contactType":"customer service","areaServed":"ES"}],
    "sameAs": ["https://www.facebook.com/reprogarage","https://www.instagram.com/reprogarage"]
  }
  </script>
  
  <meta name="robots" content="index, follow" />
  <meta name="google-site-verification" content="PUT_YOUR_VERIFICATION_TOKEN_HERE" />
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"/>
  <meta content="#1E90FF" name="theme-color"/>
  <meta content="yes" name="apple-mobile-web-app-capable"/>
  <meta content="yes" name="mobile-web-app-capable"/>
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
  <meta content="ReproGarage" name="apple-mobile-web-app-title"/>
  <meta content="telephone=no" name="format-detection"/>
  <meta content="ReproGarage - Reprogramaci√≥n de ECU y tuning profesional. Archivos Stage 1 y Stage 2, reprogramaciones a medida para particulares y talleres en Espa√±a." name="description"/>
  <meta content="reprogramaci√≥n ECU, tuning, archivos stage 1, stage 2, reprogarage, chip tuning, potencia coche, BMW, Audi, Mercedes, Volkswagen" name="keywords"/>
  <link href="https://reprogarage.es" rel="canonical"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&amp;display=swap" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
  <noscript><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&amp;display=swap" rel="stylesheet"/></noscript>
  
  <!-- Social / Open Graph -->
  <meta content="ReproGarage - Reprogramaci√≥n de ECU Profesional" property="og:title"/>
  <meta content="Reprogramaciones ECU seguras y archivos Stage 1/Stage 2. Servicios optimizados para particulares y talleres en Espa√±a." property="og:description"/>
  <meta content="https://reprogarage.es/og-image.jpg" property="og:image"/>
  <meta content="https://reprogarage.es" property="og:url"/>
  <meta content="website" property="og:type"/>
  <meta content="ReproGarage" property="og:site_name"/>
  <meta content="es_ES" property="og:locale"/>
  <meta content="summary_large_image" name="twitter:card"/>
  <meta content="ReproGarage - Reprogramaci√≥n de ECU" name="twitter:title"/>
  <meta content="Archivos ECU seguros y reprogramaciones profesionales en Espa√±a" name="twitter:description"/>
  <title>ReproGarage ‚Äî Reprogramaci√≥n de ECU y Tuning Profesional</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{ --bg-1:#0b0b0e; --electric-blue:#1E90FF; --purple:#8E44AD; --accent:#DA70D6; --card-bg:#2F2F2F; --glass:rgba(255,255,255,0.03); --text:#fff; --muted:#cfcfe0; --radius:12px; --gap:18px; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Montserrat, system-ui, Arial, sans-serif;background:linear-gradient(90deg, #757575 0%, #2F2F2F 100%);color:var(--text);-webkit-font-smoothing:antialiased;background-attachment:fixed}
  .wrap{max-width:1140px;margin:0 auto;padding:20px 16px}
  .nav{position:sticky;top:0;z-index:120;backdrop-filter:blur(6px);background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.12));padding-top:env(safe-area-inset-top)}
  .nav-inner{display:flex;align-items:center;max-width:1140px;margin:0 auto;padding:12px 16px 12px 30px;position:relative}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:80px;height:80px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden;margin-top:-5px;margin-bottom:-5px}
  .brand .logo img{width:100%;height:100%;object-fit:contain}
  .nav-links{
      display:flex;
      gap:16px;
      align-items:center;
      position:fixed !important;
      right:20px !important;
      top:50% !important;
      transform:translateY(-50%) !important;
      margin:0 !important;
      z-index:1000 !important;
  }
  .nav-links a{
      padding:10px 8px;
      border-radius:8px;
      color:#ffffff !important;
      font-weight:600;
      text-decoration:none;
      white-space:nowrap;
      background: transparent !important;
  }
  .nav-links a:hover {
      background: rgba(255,255,255,0.1) !important;
  }
  .hamburger{display:none;background:none;border:0;color:var(--text);padding:8px}
  .side-menu{position:fixed;right:0;top:0;height:100vh;width:320px;background:linear-gradient(0deg, rgba(8,3,20,0.95), rgba(20,4,40,0.95));transform:translateX(110%);transition:transform .35s;z-index:200;padding:28px;display:flex;flex-direction:column}
  .side-menu.open{transform:translateX(0)}
  .side-menu a { color: #ffffff; text-decoration: none; }
  header.main-header{
      position:relative;
      min-height:420px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px;
      background: url('https://i.ibb.co/M5ffy0mq/Chat-GPT-Image-28-oct-2025-14-21-43.png') center center / cover no-repeat
  }
  .hero-inner{z-index:2}
  .hero-title{font-size:2rem;margin:0}
  .hero-sub{color:#ffffff;margin-top:8px;text-shadow:0 2px 4px rgba(0,0,0,0.5);}
  .cta{display:inline-block;padding:12px 18px;border-radius:12px;background:linear-gradient(135deg,var(--electric-blue),#4aa0ff);border:0;color:white;font-weight:700}

  .grid{
      display:grid;
      grid-template-columns: 1fr 400px;
      gap: 40px;
      margin-top:20px;
      align-items: start;
  }

  .productos {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 100%;
  }

  .producto {
      background: var(--card-bg);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.04);
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 380px;
  }

  .producto img {
      width: 100%;
      display: block;
      border-radius: 8px;
      margin-bottom: 10px;
      object-fit: cover;
      height: 130px;
  }

  .producto h4 {
      margin: 8px 0 4px;
      font-size: 1.1rem;
  }

  .producto p {
      flex-grow: 1;
      font-size: 0.9rem;
      line-height: 1.4;
  }

  .panel{
      background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%);
      padding:16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);
      margin-left: 20px;
  }

  .imagenes-derecha {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-left: 20px;
  }

  .imagen-derecha {
      background: transparent;
      border-radius: 12px;
      overflow: hidden;
      border: none;
      width: 100%;
      margin-left: 0;
      position: relative;
  }

  .imagen-derecha img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
      border-radius: 12px;
  }

  .imagen-contenido {
      padding: 12px;
  }

  .imagen-contenido h4 {
      margin: 0 0 6px 0;
      color: var(--text);
      font-size: 0.95rem;
  }

  .imagen-contenido p {
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.4;
      margin: 0;
  }

  .texto-pagos {
      text-align: center;
      color: #ffffff !important;
      font-size: 0.92rem;
      margin: 15px 0;
      padding: 12px;
      background: transparent;
      border-radius: 8px;
      font-weight: 600;
      margin-left: 20px;
  }

  @media (max-width: 980px) {
      .productos {
          grid-template-columns: 1fr;
          gap: 18px;
      }
      
      .producto {
          min-height: auto;
      }
      
      .grid {
          grid-template-columns: 1fr;
          gap: 20px;
      }
      
      .panel,
      .imagenes-derecha,
      .texto-pagos {
          margin-left: 0;
      }
  }

  #reservas .form-card,
  #reprogramacion .form-card {
      background: var(--card-bg);
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);
  }

  .form-row{display:flex;gap:10px}
  .form-row .col{flex:1}

  input,select,textarea{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:0;
      background:#e0e0e0;
      color:#000000
  }

  .checkbox-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:15px;
  }

  .file-input-container {
    margin-top: 15px;
  }

  .file-input-label {
    display: block;
    margin-bottom: 8px;
    color: #ffffff;
    font-weight: 600;
  }

  .file-input {
    background: #e0e0e0 !important;
    padding: 10px;
    border-radius: 8px;
    color: #000000 !important;
    width: 100%;
    border: 0;
  }

  .file-input::file-selector-button {
    background: #757575 !important;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
    font-weight: 600;
  }

  .file-input::file-selector-button:hover {
    background: #5a5a5a !important;
  }

  .file-input::-webkit-file-upload-button {
    background: #757575 !important;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
    font-weight: 600;
  }

  .file-input::-webkit-file-upload-button:hover {
    background: #5a5a5a !important;
  }

  /* CAMBIO: BOT√ìN DE WHATSAPP DEL PRIMER ARCHIVO CON EL TEL√âFONO EN EL GLOVO BLANCO */
  #whatsappCTA{
      position:fixed;
      right:18px;
      bottom:18px;
      background:#25D366;
      color:#fff;
      border-radius:50%;
      width:62px;
      height:62px;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
      text-decoration:none
  }
  #whatsappCTA:focus{
      outline:3px solid rgba(37,211,102,0.25)
  }

  #backToTop{position:fixed;bottom:96px;right:20px;background:var(--electric-blue);color:white;border:0;border-radius:50%;width:50px;height:50px;display:none;align-items:center;justify-content:center;z-index:99}

  ::placeholder { color: #000000 !important; opacity: 1; }
  input, select, textarea { color: #000000 !important; }

  footer a { color: #000000 !important; text-decoration: none; }

  #comentariosECU {
    margin-top: 20px;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
  }

  .modal-content {
    background: var(--card-bg);
    padding: 30px;
    border-radius: 15px;
    max-width: 1000px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 15px;
  }

  .modal-title {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text);
  }

  .close-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
  }

  .close-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  .categorias-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .categoria-btn {
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.1);
    padding: 25px 15px;
    border-radius: 12px;
    color: var(--text);
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .categoria-btn:hover {
    border-color: var(--electric-blue);
    transform: translateY(-3px);
  }

  .categoria-btn.active {
    border-color: var(--electric-blue);
    background: rgba(30, 144, 255, 0.1);
  }

  .logo-marca {
    width: 60px;
    height: 60px;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }

  .subcategorias {
    display: none;
    margin: 20px 0;
    padding: 25px;
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .subcategorias.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .subcategoria-title {
    color: var(--muted);
    font-size: 1.3rem;
    margin-bottom: 20px;
    text-align: center;
  }

  .filtros {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 25px;
    justify-content: center;
  }

  .filtro-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 10px 20px;
    border-radius: 20px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .filtro-btn:hover, .filtro-btn.active {
    background: var(--electric-blue);
    border-color: var(--electric-blue);
  }

  .archivos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 25px;
  }

  .archivo-card {
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    transition: all 0.3s ease;
    text-align: left;
  }

  .archivo-card:hover {
    transform: translateY(-5px);
    border-color: var(--electric-blue);
    box-shadow: 0 10px 30px rgba(30, 144, 255, 0.2);
  }

  .archivo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
  }

  .archivo-title {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text);
  }

  .archivo-precio {
    background: linear-gradient(135deg, var(--electric-blue), var(--purple));
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.95rem;
  }

  .archivo-info {
    color: var(--muted);
    margin: 8px 0;
    font-size: 0.9rem;
  }

  .archivo-features {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 0;
  }

  .feature-tag {
    background: rgba(30, 144, 255, 0.15);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    color: var(--electric-blue);
  }

  .add-to-cart-btn {
    background: linear-gradient(135deg, var(--electric-blue), #4aa0ff);
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .add-to-cart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(30, 144, 255, 0.4);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .campo-error {
    border: 2px solid #ff4444 !important;
    background: #fff0f0 !important;
  }

  .mensaje-error {
    color: #ff4444;
    font-size: 0.8rem;
    margin-top: 4px;
    display: block;
    font-weight: 600;
  }

  .formulario-error {
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid #ff4444;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
  }

  .formulario-error h4 {
    color: #ff4444;
    margin: 0 0 8px 0;
    font-size: 0.9rem;
  }

  .formulario-error ul {
    margin: 0;
    padding-left: 20px;
  }

  .formulario-error li {
    color: #ff4444;
    font-size: 0.8rem;
    margin-bottom: 4px;
  }

  @media (max-width: 768px) {
      #reprogramacion .checkbox-group {
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          gap: 6px !important;
          width: 100% !important;
          margin-top: 15px !important;
      }
      
      #reprogramacion .checkbox-group label {
          display: flex !important;
          align-items: center !important;
          font-size: 11px !important;
          padding: 4px 4px !important;
          background: rgba(255,255,255,0.05) !important;
          border-radius: 6px !important;
          margin: 0 !important;
          min-height: 32px !important;
          height: 32px !important;
          width: 100% !important;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      
      #reprogramacion .checkbox-group input[type="checkbox"] {
          -webkit-appearance: none !important;
          width: 14px !important;
          height: 14px !important;
          border: 2px solid #666 !important;
          border-radius: 3px !important;
          background: #e0e0e0 !important;
          margin-right: 6px !important;
          position: relative !important;
          flex-shrink: 0 !important;
      }
      
      #reprogramacion .checkbox-group input[type="checkbox"]:checked {
          background: #1E90FF !important;
          border-color: #1E90FF !important;
      }
      
      #reprogramacion .checkbox-group input[type="checkbox"]:checked::after {
          content: "‚úì" !important;
          position: absolute !important;
          color: white !important;
          font-size: 10px !important;
          font-weight: bold !important;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%) !important;
      }
  }

  @media (max-width: 980px) {
    input, select, textarea {
      font-size: 16px !important;
      padding: 14px !important;
      min-height: 50px !important;
    }
    
    ::placeholder {
      font-size: 16px !important;
    }
    
    input, select, textarea {
      font-size: 16px !important;
    }
    
    label {
      font-size: 16px !important;
      margin-bottom: 10px !important;
    }
    
    .cta, button {
      min-height: 50px !important;
      font-size: 16px !important;
    }
    
    .form-row {
      gap: 15px !important;
      margin-bottom: 15px !important;
    }
    
    .form-card {
      padding: 20px !important;
    }
    
    .nav-links{
      display:none !important;
    }
    .hamburger{
      display:inline-block !important;
    }
    .side-menu{width:86%}
    
    .brand .logo {
      width: 60px;
      height: 60px;
      margin-top: 0;
      margin-bottom: 0;
    }
  }

  @media (max-width: 980px) {
    .categorias-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .archivos-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 600px) {
    .categorias-grid {
      grid-template-columns: 1fr;
    }
    
    .modal-content {
      padding: 20px;
    }
    
    .modal-title {
      font-size: 1.3rem;
    }
    
    input, select, textarea {
      padding: 16px !important;
      min-height: 54px !important;
    }
    
    .cta, button {
      min-height: 54px !important;
      padding: 16px 20px !important;
    }
  }

  @media (max-width: 980px) {
    .imagenes-derecha {
      display: none;
    }
  }

  #reservasH,
  #reprogH {
    color: #ffffff !important;
  }

  #contacto {
    color: #ffffff !important;
  }

  #contacto h2,
  #contacto p,
  #contacto label,
  #contacto h4,
  #contacto a,
  #contacto div {
    color: #ffffff !important;
  }

  #contacto input,
  #contacto textarea {
    color: #000000 !important;
    background: #e0e0e0 !important;
  }

  #contacto ::placeholder {
    color: #000000 !important;
  }

  #btnPagar {
    background: linear-gradient(135deg, var(--purple), var(--accent)) !important;
  }

  button[type="reset"] {
    background: white !important;
    color: #000000 !important;
    border: 0 !important;
    border-radius: 12px !important;
    padding: 12px 18px !important;
    font-weight: 700 !important;
    display: inline-block !important;
  }

  .btn-secondary {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-secondary:hover {
    background: rgba(255,255,255,0.2);
  }

  .metodos-pago {
    margin: 20px 0;
  }

  .metodos-pago h4 {
    margin-bottom: 15px;
    color: var(--text);
  }

  .metodos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .metodo-pago {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .metodo-pago:hover {
    border-color: var(--electric-blue);
    background: rgba(30, 144, 255, 0.1);
  }

  .metodo-pago.active {
    border-color: var(--electric-blue);
    background: rgba(30, 144, 255, 0.15);
  }

  .metodo-pago img {
    height: 40px;
    margin-bottom: 10px;
    object-fit: contain;
  }

  .metodo-pago .nombre {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text);
  }

  .metodo-pago .descripcion {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 5px;
  }

  .resumen-compra {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .resumen-compra h4 {
    margin-bottom: 15px;
    color: var(--text);
  }

  .resumen-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .resumen-total {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid rgba(255,255,255,0.2);
  }

  .pago-manual-info {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid var(--electric-blue);
  }

  .pago-manual-info h5 {
    margin: 0 0 10px 0;
    color: var(--text);
  }

  .pago-manual-info p {
    margin: 5px 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  /* ELIMINADO: Estilos para .whatsapp-logo y .bizum-logo que ya no se usan */
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; color: var(--text); background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%); }
    form {
      background: var(--card-bg);
      border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,0.06);
      padding:1.5rem;
      margin-top:1rem;
    }
    button, input, select, textarea {
      transition: all 0.2s ease;
    }
    button:hover {
      transform: scale(1.02);
      box-shadow: 0 0 8px rgba(27,79,114,0.3);
    }
    footer {
      background: rgba(0,0,0,0.2);
      color: var(--text);
      padding:1rem;
      text-align:center;
      font-size:0.9rem;
      border-top:4px solid rgba(255,255,255,0.1);
      margin-top:2rem;
    }
    .file-input-container label {
      font-weight:600;
      color: var(--text);
    }
    .swal2-popup {
      font-family: 'Inter', sans-serif !important;
    }
  </style>
  <link rel="icon" href="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png" type="image/png">
  <meta name="theme-color" content="#1B4F72">
  <meta property="og:title" content="ReproGarage - Reprogramaci√≥n profesional ECU">
  <meta property="og:description" content="Optimiza el rendimiento de tu veh√≠culo con reprogramaciones seguras y personalizadas.">
  <meta property="og:image" content="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png">

</head>
<body>
<nav aria-label="Navegaci√≥n principal" class="nav" role="navigation">
<div class="nav-inner">
<div class="brand">
<div class="logo">
  <img src="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png" alt="ReproGarage Logo">
</div>
<div>
<h3 style="margin:0">ReproGarage.es</h3>
<div style="font-size:12px;color:var(--muted)">Tuning ¬∑ Reprogramaciones ¬∑ Servicios</div>
</div>
</div>
<div class="nav-links" role="menubar">
<a href="#productos" role="menuitem">Archivos ECU</a>
<a href="#carrito" role="menuitem" onclick="scrollToCarrito()">Carrito</a>
<a href="#reservas" role="menuitem">Reservar</a>
<a href="#reprogramacion" role="menuitem">Reprogramaci√≥n</a>
<a href="#contacto" role="menuitem" onclick="scrollToContacto()">Contacto</a>
</div>
<button aria-controls="sideMenu" aria-expanded="false" aria-label="Abrir men√∫" class="hamburger" id="btnHamb">
<svg aria-hidden="true" fill="none" height="26" viewbox="0 0 24 24" width="26"><path d="M4 7h16M4 12h16M4 17h16" stroke="white" stroke-linecap="round" stroke-width="2"></path></svg>
</button>
</div>
</nav>

<aside aria-hidden="true" class="side-menu" id="sideMenu">
<button aria-label="Cerrar men√∫" class="side-close" id="btnClose">‚úï</button>
<h4>Men√∫</h4>
<a href="#productos" onclick="handleMenuClick('productos')">Archivos ECU</a>
<a href="#carrito" onclick="handleMenuClick('carrito')">Carrito</a>
<a href="#reservas" onclick="handleMenuClick('reservas')">Reservar</a>
<a href="#reprogramacion" onclick="handleMenuClick('reprogramacion')">Reprogramaci√≥n</a>
<a href="#contacto" onclick="handleMenuClick('contacto')">Contacto</a>
<div style="margin-top:auto;color:var(--muted);font-size:0.92rem">
<strong>Contacto</strong><br/>
    Iv√°n - 644 777 079
  </div>
</aside>
<header class="main-header" role="banner">
<div class="hero-inner wrap">
<h1 class="hero-title">ReproGarage ‚Äî Reprogramaci√≥n de ECU Profesional</h1>
<p class="hero-sub">Archivos Stage 1 y Stage 2 ¬∑ Reprogramaciones a medida para particulares y talleres en Espa√±a</p>
</div>
</header>
<main class="wrap" id="main">
<div aria-label="Cat√°logo y carrito" class="grid" role="region">
<section aria-labelledby="productosH" id="productos">
<h2 id="productosH">Archivos ECU Disponibles</h2>
<p style="color:var(--muted);margin-bottom:16px;">Selecciona el archivo que mejor se adapte a tu veh√≠culo</p>
<div class="productos" role="list">
<article class="producto" role="listitem">
<img alt="Stage 1 - optimizaci√≥n para uso diario" height="200" loading="lazy" src="https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 1 - Optimizaci√≥n diaria</h4>
<p style="color:var(--muted);font-size:0.95rem;">Mejora de respuesta y eficiencia, sin modificaciones hardware.</p>
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Incluye ajuste de mapa motor y optimizaci√≥n de curva de par
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 1')" style="margin-top:auto;">Ver archivos</button>
</article>
<article class="producto" role="listitem">
<img alt="Stage 2 - optimizaci√≥n rendimiento" height="200" loading="lazy" src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 2 - Performance</h4>
<p style="color:var(--muted);font-size:0.95rem;">Manejo avanzado del motor para veh√≠culos con mejoras hardware.</p>
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Mapeo optimizado y calibraciones espec√≠ficas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 2')" style="margin-top:auto;">Ver archivos</button>
</article>
<article class="producto" role="listitem">
<img alt="Personalizado - eliminaciones y optimizaciones avanzadas" height="200" loading="lazy" src="https://images.unsplash.com/photo-1563720223185-11003d516935?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Personalizado - Eliminaciones Avanzadas</h4>
<p style="color:var(--muted);font-size:0.95rem;">Eliminaci√≥n de EGR, AdBlue, DTCs, pops and bangs, l√≠mite de corte y m√°s opciones.</p>
<div style="margin:12px 0;padding:10px;background:rgba(218,112,214,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            üí° Incluye eliminaciones personalizadas y optimizaciones espec√≠ficas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Personalizado')" style="margin-top:auto;">Ver archivos</button>
</article>
</div>
</section>
<aside aria-label="Carrito y acciones">
<div aria-live="polite" class="panel" id="carrito">
<h3>Tu Carrito</h3>
<ul class="cart-list" id="cartList"></ul>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px"><strong>Total</strong><div id="cartTotal">‚Ç¨0</div></div>
<div style="margin-top:12px;display:flex;gap:10px;">
<button class="cta" id="btnPagar" onclick="procederPago()" style="flex:1">Pagar</button>
<button class="cta" id="btnVaciar" style="flex:1;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)">Vaciar</button>
</div>
</div>

<div class="texto-pagos">
  <div>Medios de pago seguros ¬∑ Env√≠o digital inmediato</div>
</div>

<div class="imagenes-derecha">
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=600&q=80" alt="Herramienta profesional para reprogramaci√≥n ECU">
    <div class="imagen-contenido">
      <h4>KessV3 Professional</h4>
      <p>Equipo profesional KessV3 para lectura y escritura de ECU. Tecnolog√≠a de √∫ltima generaci√≥n</p>
    </div>
  </div>
  
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=600&q=80" alt="An√°lisis especializado de centralitas">
    <div class="imagen-contenido">
      <h4>An√°lisis Especializado</h4>
      <p>T√©cnicos cualificados creando mapas personalizados para m√°ximo rendimiento</p>
    </div>
  </div>
</div>

</aside>
</div>

<section aria-labelledby="reservasH" id="reservas" style="margin-top:36px;">
<h2 id="reservasH">Reservar Servicio Presencial</h2>
<p style="color:var(--muted);margin-bottom:16px;">Agenda tu cita para reprogramaci√≥n presencial</p>
<div class="form-card" style="max-width:900px;margin:0 auto">
<form id="formReserva" method="POST" enctype="application/x-www-form-urlencoded" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreRes">Nombre y apellidos</label><input id="nombreRes" maxlength="100" name="nombreRes" placeholder="Ej: Juan P√©rez" required="" type="text"/></div>
<div class="col"><label for="telefonoRes">Tel√©fono</label><input id="telefonoRes" maxlength="15" name="telefonoRes" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailRes">Email</label><input id="emailRes" maxlength="254" name="emailRes" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="fechaRes">Fecha</label><input id="fechaRes" name="fechaRes" placeholder="Ej: ejemplo" required="" type="date"/></div>
</div>
<div class="form-row">
<div class="col"><label for="horaRes">Hora</label>
<select id="horaRes" name="horaRes">
  <option value="">Selecciona hora</option>
  <option>08:00</option><option>09:00</option><option>10:00</option><option>11:00</option>
  <option>12:00</option><option>13:00</option><option>14:00</option><option>15:00</option>
  <option>16:00</option><option>17:00</option><option>18:00</option>
</select>
</div>
<div class="col"><label for="vehiculoRes">Marca y modelo</label><input id="vehiculoRes" maxlength="100" name="vehiculoRes" placeholder="Ej: BMW 320d 2019" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="localidadRes">Localidad del servicio</label><input id="localidadRes" maxlength="100" name="localidadRes" placeholder="Ej: Santander" required="" type="text"/></div></div>
<div class="form-row"><div class="col"><label for="dynoactiveRes">DynoActive (resultados de par y cv)</label><select id="dynoactiveRes" name="dynoactiveRes" required=""><option value="">Selecciona</option><option value="si">S√≠</option><option value="no">No</option></select></div></div>
<label for="detallesRes">Detalles del veh√≠culo y servicio</label>
<textarea id="detallesRes" maxlength="1000" name="detallesRes" placeholder="Ej: BMW 320d 2019, matr√≠cula 1234ABC, Stage 1..." required="" style="color:var(--muted)"></textarea>

<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta" id="btnEnviarReserva" type="button">Reservar ahora</button><button type="reset">Limpiar</button></div>
<p aria-live="polite" id="mensajeRes" style="color:var(--muted);margin-top:10px"></p>
</form>
</div>
</section>
<section aria-labelledby="reprogH" id="reprogramacion" style="margin-top:36px;">
<h2 id="reprogH">Solicitud de Reprogramaci√≥n</h2>
<p style="color:var(--muted);margin-bottom:16px;">Proporciona los datos del veh√≠culo para una reprogramaci√≥n a medida</p>
<div class="form-card" style="max-width:920px;margin:0 auto">
<form id="formReprog" method="POST" enctype="application/x-www-form-urlencoded" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreReprog">Nombre y apellidos</label><input id="nombreReprog" maxlength="100" name="nombreReprog" placeholder="Ej: Juan P√©rez" required="" type="text"/></div>
<div class="col"><label for="telefonoReprog">Tel√©fono</label><input id="telefonoReprog" maxlength="15" name="telefonoReprog" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailReprog">Email</label><input id="emailReprog" maxlength="254" name="emailReprog" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="marcaCoche">Marca</label><input id="marcaCoche" maxlength="50" name="marcaCoche" placeholder="Ej: BMW, Audi" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="col"><label for="modeloCoche">Modelo</label><input id="modeloCoche" maxlength="50" name="modeloCoche" placeholder="Ej: 320d, A4" required="" type="text"/></div>
<div class="col"><label for="anioCoche">A√±o</label><input id="anioCoche" max="2099" min="1900" name="anioCoche" placeholder="Ej: 2019" required="" type="number"/></div>
</div>
<div class="form-row">
<div class="col"><label for="potenciaECU">Potencia (kW)</label><input id="potenciaECU" max="2000" min="1" name="potenciaECU" placeholder="Ej: 140" required="" type="number"/></div>
<div class="col"><label for="marcaECU">Marca de ECU</label><input id="marcaECU" maxlength="50" name="marcaECU" placeholder="Ej: Bosch" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="serieECU">N√∫mero de serie ECU</label><input id="serieECU" maxlength="50" name="serieECU" placeholder="Ej: EDC17C50" required="" type="text"/></div></div>
<label>Opciones de modificaci√≥n</label>
<div aria-label="Opciones de modificaci√≥n" class="checkbox-group" role="group">
  <label><input name="opciones" type="checkbox" value="Stage 1"/> Stage 1</label>
  <label><input name="opciones" type="checkbox" value="Stage 2"/> Stage 2</label>
  <label><input name="opciones" type="checkbox" value="EGR"/> EGR</label>
  <label><input name="opciones" type="checkbox" value="AdBlue"/> AdBlue</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DTCs"/> Eliminar DTCs</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DPF"/> Eliminar DPF</label>
  <label><input name="opciones" type="checkbox" value="Inmo"/> Inmo</label>
  <label><input name="opciones" type="checkbox" value="Pops and bangs"/> Pops and bangs</label>
  <label><input name="opciones" type="checkbox" value="L√≠mite de corte"/> L√≠mite de corte</label>
</div>
<label for="comentariosECU">Informaci√≥n adicional</label>
<textarea id="comentariosECU" maxlength="2000" name="comentariosECU" placeholder="Ej: Modificaciones hechas al veh√≠culo (downpipe, EGR anulada, escape 2.5 pulgadas, etc.)" style="color:var(--muted)"></textarea>

<div class="file-input-container" style="margin-top:10px;">
  <label class="file-input-label" for="archivoReprog">Adjuntar archivo (opcional) ‚Äî .bin .zip .rar .7z .gz .tar</label>
  <input id="archivoReprog" class="file-input" type="file" accept=".bin,.zip,.rar,.7z,.gz,.tar" />
</div>
<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta" id="btnEnviarReprogramacion" type="button">Solicitar reprogramaci√≥n</button><button type="reset">Limpiar</button></div>
<p aria-live="polite" id="mensajeReprog" style="color:var(--muted);margin-top:10px"></p>
</form>
</div>
</section>
</main>
<footer id="contacto" style="padding:40px 20px;background:rgba(0,0,0,0.2);margin-top:60px;">
<div style="max-width:1140px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:30px;">
<div>
<h4 style="margin-bottom:8px">ReproGarage</h4>
<p style="color:var(--muted);font-size:0.9rem;line-height:1.6">Reprogramaci√≥n ECU y servicios of tuning profesional. Equipos profesionales para lectura y escritura de centralitas (Kess3, ECM Titanium).</p>
</div>
<div>
<h4 style="margin-bottom:8px">Contacto</h4>
<p style="color:var(--muted);font-size:0.9rem">info@reprogarage.es<br/>Iv√°n - 644 777 079<br/>Horario: Lun-Vie 08:00-19:00</p>
</div>
<div>
<h4 style="margin-bottom:8px">Enlaces</h4>
<div style="display:flex;flex-direction:column;gap:8px;color:var(--muted)"><a href="#productos">Archivos ECU</a><a href="#reservas">Reservar cita</a><a href="#reprogramacion">Reprogramaci√≥n</a><a href="#contacto" onclick="scrollToContacto()">Contacto</a></div>
</div>
</div>
<div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:30px;padding-top:20px;text-align:center;color:var(--muted);font-size:0.85rem">¬© <span id="year">2025</span> ReproGarage.es</div>
</footer>

<!-- CAMBIO: Bot√≥n de WhatsApp del primer archivo con el tel√©fono dentro del glovo blanco -->
<a aria-label="Contactar por WhatsApp" href="https://wa.me/34644777079?text=Hola%20ReproGarage,%20quiero%20informaci%C3%B3n%20sobre%20reprogramaci%C3%B3n" id="whatsappCTA" rel="noopener noreferrer" target="_blank">
  <svg width="32" height="32" viewBox="0 0 32 32" fill="white">
    <path d="M16 0C7.164 0 0 7.164 0 16c0 2.825.748 5.476 2.053 7.764L0 32l8.516-2.053C10.732 31.338 13.323 32 16 32c8.836 0 16-7.164 16-16S24.836 0 16 0zm7.914 22.375c-.297.834-1.484 1.525-2.422 1.617-.297.033-1.813.297-5.008-1.617-3.195-1.914-5.213-5.545-5.378-5.801-.165-.256-1.352-1.813-1.352-3.461s.843-2.422 1.156-2.734c.313-.313.678-.396.909-.396.231 0 .462 0 .66.033.198.033.462.066.66.429.198.363.66 1.254.726 1.352.066.099.132.231.066.396-.066.165-.066.297-.132.429-.066.132-.66.759-.909 1.023-.231.264-.462.396-.396.66.066.264.66 1.155 1.419 1.875.99.957 1.815 1.254 2.079 1.419.264.165.413.132.578.066.165-.066.99-.429 1.254-.578.264-.149.462-.099.66.033.198.132.99.578 1.155.678.165.099.33.165.33.33 0 .165-.033.264-.198.429z"/>
  </svg>
</a>

<button aria-label="Volver arriba" id="backToTop" title="Volver arriba">‚Üë</button>

<!-- El resto del c√≥digo permanece igual -->
<div id="catalogoModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitulo">üìÅ Cat√°logo de Archivos ECU</h2>
      <button class="close-btn" id="closeCatalogBtn">‚úï</button>
    </div>
    
    <p style="color: var(--muted); margin-bottom: 25px; text-align: center;">
      Selecciona la marca de tu veh√≠culo para ver los archivos disponibles
    </p>
    
    <div class="categorias-grid" id="categoriasGrid">
    </div>
    
    <div class="subcategorias" id="subcategorias">
      <h3 class="subcategoria-title" id="subcategoriaTitle">Selecciona un modelo</h3>
      <div class="filtros" id="filtros">
      </div>
      <div class="archivos-grid" id="archivosGrid">
      </div>
    </div>
  </div>
</div>

<div id="seleccionMetodoPagoModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Selecciona m√©todo de pago</h2>
      <button class="close-btn" id="closeSeleccionMetodoBtn">‚úï</button>
    </div>
    
    <div style="padding: 20px;">
      <div class="resumen-compra">
        <h4>Resumen de tu compra</h4>
        <div id="resumenProductosSeleccion"></div>
        <div class="resumen-total">
          <span>Total:</span>
          <span id="resumenTotalSeleccion">‚Ç¨0</span>
        </div>
      </div>
      
      <div class="metodos-pago">
        <h4>Elige c√≥mo quieres pagar</h4>
        <div class="metodos-grid">
          <div class="metodo-pago" data-metodo="stripe">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Stripe_Logo%2C_revised_2016.svg/2560px-Stripe_Logo%2C_revised_2016.svg.png" alt="Stripe">
            <div class="nombre">Tarjeta</div>
            <div class="descripcion">Visa, Mastercard, Amex</div>
          </div>
          <div class="metodo-pago" data-metodo="bizum">
            <img src="https://i.ibb.co/pB5yKqNn/bizum-logo.webp" alt="Bizum">
            <div class="nombre">Bizum</div>
            <div class="descripcion">Pago r√°pido con m√≥vil</div>
          </div>
          <div class="metodo-pago" data-metodo="transferencia">
            <img src="https://th.bing.com/th/id/OIP.i_9ZPfqcxKdRXEolt9sKZwHaHa?w=186&h=186&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3" alt="Transferencia">
            <div class="nombre">Transferencia</div>
            <div class="descripcion">Transferencia bancaria</div>
          </div>
        </div>
      </div>
      
      <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <button type="button" id="cancelarSeleccionMetodoBtn" class="btn-secondary" style="padding: 10px 20px;">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<div id="facturacionModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">üßæ Datos de Facturaci√≥n</h2>
      <button class="close-btn" id="closeFacturacionBtn">‚úï</button>
    </div>
    
    <div style="padding: 20px;">
      <div id="pasoFacturacion">
        <p style="color: var(--muted); margin-bottom: 20px;">
          Por favor, introduce tus datos para generar la factura. Estos datos solo se utilizar√°n para fines de facturaci√≥n.
        </p>
        
        <form id="formFacturacion">
          <div class="form-row">
            <div class="col">
              <label for="facturacionNombre">Nombre completo *</label>
              <input type="text" id="facturacionNombre" required placeholder="Ej: Juan P√©rez">
            </div>
            <div class="col">
              <label for="facturacionEmail">Email *</label>
              <input type="email" id="facturacionEmail" required placeholder="ejemplo@email.com">
            </div>
          </div>
          
          <div class="form-row">
            <div class="col">
              <label for="facturacionTelefono">Tel√©fono *</label>
              <input type="tel" id="facturacionTelefono" required placeholder="Ej: 644 777 079">
            </div>
            <div class="col">
              <label for="facturacionNIF">NIF/CIF *</label>
              <input type="text" id="facturacionNIF" required placeholder="Ej: 12345678A">
            </div>
          </div>
          
          <div class="form-row">
            <div class="col">
              <label for="facturacionDireccion">Direcci√≥n *</label>
              <input type="text" id="facturacionDireccion" required placeholder="Ej: Calle Falsa 123">
            </div>
          </div>
          
          <div class="form-row">
            <div class="col">
              <label for="facturacionCP">C√≥digo Postal *</label>
              <input type="text" id="facturacionCP" required placeholder="Ej: 28001">
            </div>
            <div class="col">
              <label for="facturacionCiudad">Ciudad *</label>
              <input type="text" id="facturacionCiudad" required placeholder="Ej: Madrid">
            </div>
            <div class="col">
              <label for="facturacionPais">Pa√≠s *</label>
              <input type="text" id="facturacionPais" required placeholder="Ej: Espa√±a">
            </div>
          </div>
          
          <div class="pago-manual-info" id="infoPagoManual" style="display: none;">
            <h5 id="tituloPagoManual"></h5>
            <div id="contenidoPagoManual"></div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" id="cancelarFacturacionBtn" class="btn-secondary" style="padding: 10px 20px;">Cancelar</button>
            <button type="button" id="confirmarFacturacionBtn" class="cta" style="padding: 10px 20px;">Confirmar Pedido</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="recaptchaModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">üîí Verificaci√≥n de seguridad</h2>
      <button class="close-btn" id="closeRecaptchaBtn">‚úï</button>
    </div>
    
    <div style="padding: 20px; text-align: center;">
      <p style="color: var(--muted); margin-bottom: 20px;">
        Por favor, completa la verificaci√≥n reCAPTCHA para continuar.
      </p>
      
      <div id="recaptchaContainer" style="display: flex; justify-content: center; margin: 20px 0;"></div>
      
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button type="button" id="cancelarRecaptchaBtn" class="btn-secondary" style="padding: 10px 20px;">Cancelar</button>
        <button type="button" id="confirmarRecaptchaBtn" class="cta" style="padding: 10px 20px;" disabled>Continuar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.google.com/recaptcha/api.js?render=explicit" async defer></script>

<script>
// ============================
// CONFIGURACI√ìN PRINCIPAL
// ============================
const WORKER_URL = 'https://curly-hall-2272.ivansomarriba92.workers.dev';
const RECAPTCHA_SITE_KEY = '6LcBivIrAAAAALSzLolJNtTZT3YBK4V7XpVR40bR';

// Variables globales
let recaptchaWidgetId = null;
let formularioPendiente = null;
let datosFormularioPendiente = null;
let metodoPagoSeleccionado = null;

// Estado global
window.appState = {
  carrito: [],
  tipoStage: ''
};

// ============================
// üóÇÔ∏è BASE DE DATOS DE ARCHIVOS
// ============================

const archivosECU = {
    'audi_stage1': {
        nombre: 'Audi Stage 1',
        precio: 50,
        archivo: 'audi_stage1.bin',
        compatibilidad: 'Audi 2015-2020, m√∫ltiples modelos',
        descripcion: 'Archivo Stage 1 optimizado para Audi. Mejora de potencia y par motor.'
    },
    'audi_stage2': {
        nombre: 'Audi Stage 2',
        precio: 150,
        archivo: 'Audi_Stage2.bin', 
        compatibilidad: 'Audi 2015-2020 con modificaciones',
        descripcion: 'Archivo Stage 2 para Audi con modificaciones hardware.'
    },
    'bmw_stage1': {
        nombre: 'BMW Stage 1',
        precio: 50,
        archivo: 'BMW_Stage1.bin',
        compatibilidad: 'BMW 2015-2020, m√∫ltiples modelos',
        descripcion: 'Archivo Stage 1 optimizado para BMW.'
    },
    'bmw_stage2': {
        nombre: 'BMW Stage 2',
        precio: 150,
        archivo: 'BMW_Stage2.bin',
        compatibilidad: 'BMW 2015-2020 con modificaciones',
        descripcion: 'Archivo Stage 2 para BMW con modificaciones hardware.'
    },
    'mercedes_stage1': {
        nombre: 'Mercedes Stage 1',
        precio: 50,
        archivo: 'Mercedes_Stage1.bin',
        compatibilidad: 'Mercedes 2015-2020, m√∫ltiples modelos',
        descripcion: 'Archivo Stage 1 optimizado para Mercedes.'
    },
    'mercedes_stage2': {
        nombre: 'Mercedes Stage 2', 
        precio: 150,
        archivo: 'Mercedes_Stage2.bin',
        compatibilidad: 'Mercedes 2015-2020 con modificaciones',
        descripcion: 'Archivo Stage 2 para Mercedes con modificaciones hardware.'
    },
    'volkswagen_stage1': {
        nombre: 'Volkswagen Stage 1 - Golf',
        precio: 50,
        archivo: 'stage1_vw_golf.bin',
        compatibilidad: 'Volkswagen Golf 2015-2020, m√∫ltiples motores',
        descripcion: 'Archivo Stage 1 optimizado para Volkswagen Golf.'
    },
    'volkswagen_stage2': {
        nombre: 'Volkswagen Stage 2',
        precio: 150,
        archivo: 'Volkswagen_Stage2.bin',
        compatibilidad: 'Volkswagen 2015-2020 con modificaciones',
        descripcion: 'Archivo Stage 2 para Volkswagen con modificaciones hardware.'
    }
};

// ============================
// üí≥ SISTEMA DE PAGO CON STRIPE - MEJORADO
// ============================

async function procesarPagoStripe() {
    console.log('üîÑ Iniciando proceso de pago con Stripe');
    
    // Validar que el carrito no est√© vac√≠o
    if (!window.appState.carrito || window.appState.carrito.length === 0) {
        mostrarNotificacion('‚ùå El carrito est√° vac√≠o', 'error');
        return;
    }

    const total = window.appState.carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const productos = window.appState.carrito;
    
    try {
        Swal.fire({
            title: 'Procesando pago...',
            text: 'Por favor, espera mientras creamos tu sesi√≥n de pago.',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        console.log('üì¶ Productos en carrito:', productos);
        console.log('üí∞ Total a pagar:', total);

        // Preparar datos para Stripe - FORMA CORREGIDA
        const sessionData = {
            items: productos,
            total: total,
            success_url: `${window.location.origin}${window.location.pathname}?session_id={CHECKOUT_SESSION_ID}&success=true`,
            cancel_url: `${window.location.origin}${window.location.pathname}?canceled=true`
        };

        console.log('üì§ Enviando solicitud a Stripe:', sessionData);

        // CAMBIO: Usar el nuevo endpoint espec√≠fico
        const response = await fetch(`${WORKER_URL}/api/create-stripe-session`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(sessionData)
        });

        console.log('üì• Respuesta del servidor:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error HTTP:', response.status, errorText);
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('‚úÖ Datos recibidos:', data);
        
        if (!data.success) {
            throw new Error(data.error || "Error al crear sesi√≥n de pago");
        }

        console.log('‚úÖ Sesi√≥n de Stripe creada:', data.sessionId);
        
        Swal.close();
        
        // Redirigir a Stripe Checkout
        console.log('üîó Redirigiendo a:', data.url);
        window.location.href = data.url;

    } catch (error) {
        console.error('‚ùå Error en proceso de pago Stripe:', error);
        Swal.close();
        mostrarNotificacion(`‚ùå Error al procesar el pago: ${error.message}`, 'error');
    }
}

// ============================
// üí∞ PAGOS MANUALES - CORREGIDO
// ============================

async function realizarPagoManual(datosFacturacion) {
    console.log('üîÑ Iniciando proceso de pago manual');
    
    const total = window.appState.carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const productos = window.appState.carrito.map(p => `${p.nombre} - ${p.precio}‚Ç¨ x ${p.cantidad}`).join('\n');
    
    try {
        console.log('üì§ Enviando notificaci√≥n de pedido...');
        
        const payload = {
            type: "notificacion-pedido",
            total: total,
            productos: productos,
            metodoPago: metodoPagoSeleccionado,
            datosFacturacion: datosFacturacion
        };

        // CAMBIO: Usar el nuevo endpoint espec√≠fico
        const response = await fetch(`${WORKER_URL}/api/purchase-notification`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Error enviando notificaci√≥n');
        }
        
        console.log('‚úÖ Notificaci√≥n de pedido enviada correctamente');
        mostrarConfirmacionPedidoManual(datosFacturacion, total);
        
        // Limpiar carrito despu√©s del pago exitoso
        window.appState.carrito = [];
        guardarCarrito();
        actualizarCarrito();
        
    } catch (error) {
        console.error('‚ùå Error en proceso de pedido manual:', error);
        mostrarNotificacion('‚ùå Error al procesar el pedido. Contacta con soporte.', 'error');
    }
}

function mostrarConfirmacionPedidoManual(datosFacturacion, total) {
    const productosTexto = window.appState.carrito.map(p => 
        `${p.nombre} - ${p.precio}‚Ç¨ x ${p.cantidad}`
    ).join('\n');
    
    let mensaje = `¬°Gracias por tu pedido, ${datosFacturacion.nombre}!\n\n`;
    mensaje += `**Resumen del pedido:**\n${productosTexto}\n\n`;
    mensaje += `**Total: ${total}‚Ç¨**\n\n`;
    
    if (metodoPagoSeleccionado === 'bizum') {
        mensaje += `**Para completar tu pedido con Bizum:**\n`;
        mensaje += `1. Realiza el pago de ${total}‚Ç¨ al n√∫mero 644 777 079\n`;
        mensaje += `2. En el concepto indica: "${datosFacturacion.nombre}"\n`;
        mensaje += `3. Una vez confirmado el pago, te enviaremos los archivos por email\n\n`;
    } else if (metodoPagoSeleccionado === 'transferencia') {
        mensaje += `**Para completar tu pedido con Transferencia:**\n`;
        mensaje += `1. Realiza la transferencia de ${total}‚Ç¨ a nuestra cuenta\n`;
        mensaje += `2. Banco: [Nombre del banco]\n`;
        mensaje += `3. IBAN: [N√∫mero de cuenta IBAN]\n`;
        mensaje += `4. En el concepto indica: "${datosFacturacion.nombre}"\n`;
        mensaje += `5. Una vez confirmada la transferencia, te enviaremos los archivos por email\n\n`;
    }
    
    mensaje += `Recibir√°s los archivos comprados en: ${datosFacturacion.email}\n\n`;
    mensaje += `¬°Gracias por confiar en ReproGarage!`;
    
    Swal.fire({
        title: '‚úÖ Pedido Confirmado',
        html: mensaje.replace(/\n/g, '<br>'),
        icon: 'success',
        confirmButtonText: 'Entendido',
        width: 600
    });
}

// ============================
// üßæ MANEJO DE RETORNO DE STRIPE
// ============================

function manejarRetornoStripe() {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const success = urlParams.get('success');
    const canceled = urlParams.get('canceled');
    
    if (success && sessionId) {
        const nuevaURL = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, nuevaURL);
        
        Swal.fire({
            title: '‚úÖ Pago Completado',
            html: `
                <div style="text-align: left;">
                    <p>¬°Gracias por tu compra! El pago se ha procesado correctamente.</p>
                    <p><strong>ID de sesi√≥n:</strong> ${sessionId}</p>
                    <p>Recibir√°s los archivos por email en los pr√≥ximos minutos.</p>
                    <p>Si tienes alguna duda, contacta con nosotros.</p>
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'Entendido'
        }).then(() => {
            window.appState.carrito = [];
            guardarCarrito();
            actualizarCarrito();
        });
    }
    
    if (canceled) {
        const nuevaURL = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, nuevaURL);
        mostrarNotificacion('El pago fue cancelado. Puedes intentarlo de nuevo cuando lo desees.', 'info');
    }
}

// ============================
// üñºÔ∏è MODALES DE FACTURACI√ìN Y PAGO
// ============================

function mostrarModalSeleccionMetodo() {
    actualizarResumenCompraSeleccion();
    document.getElementById('seleccionMetodoPagoModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function cerrarModalSeleccionMetodo() {
    document.getElementById('seleccionMetodoPagoModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function mostrarModalFacturacion() {
    document.getElementById('facturacionModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Configurar informaci√≥n espec√≠fica del m√©todo de pago
    const infoPagoManual = document.getElementById('infoPagoManual');
    const tituloPagoManual = document.getElementById('tituloPagoManual');
    const contenidoPagoManual = document.getElementById('contenidoPagoManual');
    
    infoPagoManual.style.display = 'block';
    
    if (metodoPagoSeleccionado === 'bizum') {
        tituloPagoManual.textContent = 'üì± Pago con Bizum';
        contenidoPagoManual.innerHTML = `
            <p>Para completar tu pedido con Bizum:</p>
            <p><strong>N√∫mero Bizum:</strong> 644 777 079</p>
            <p><strong>Concepto:</strong> Tu nombre completo</p>
            <p><strong>Importe:</strong> <span id="importeBizum">${calcularTotal()}</span>‚Ç¨</p>
            <p>Una vez confirmado el pago, te enviaremos los archivos por email.</p>
        `;
    } else if (metodoPagoSeleccionado === 'transferencia') {
        tituloPagoManual.textContent = 'üè¶ Pago con Transferencia';
        contenidoPagoManual.innerHTML = `
            <p>Para completar tu pedido con Transferencia:</p>
            <p><strong>Banco:</strong> [Nombre del banco]</p>
            <p><strong>IBAN:</strong> [N√∫mero de cuenta IBAN]</p>
            <p><strong>Beneficiario:</strong> ReproGarage</p>
            <p><strong>Concepto:</strong> Tu nombre completo</p>
            <p><strong>Importe:</strong> <span id="importeTransferencia">${calcularTotal()}</span>‚Ç¨</p>
            <p>Una vez confirmada la transferencia, te enviaremos los archivos por email.</p>
        `;
    }
}

function cerrarModalFacturacion() {
    document.getElementById('facturacionModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function calcularTotal() {
    return window.appState.carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
}

function actualizarResumenCompraSeleccion() {
    const resumenProductos = document.getElementById('resumenProductosSeleccion');
    const resumenTotal = document.getElementById('resumenTotalSeleccion');
    
    let html = '';
    let total = 0;
    
    window.appState.carrito.forEach(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        
        html += `
            <div class="resumen-item">
                <span>${item.nombre} x${item.cantidad}</span>
                <span>${subtotal}‚Ç¨</span>
            </div>
        `;
    });
    
    resumenProductos.innerHTML = html;
    resumenTotal.textContent = `${total}‚Ç¨`;
}

// ============================
// üîÑ SISTEMA DE reCAPTCHA
// ============================

function abrirModalRecaptcha(formulario, datos) {
    formularioPendiente = formulario;
    datosFormularioPendiente = datos;
    
    document.getElementById('recaptchaModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.getElementById('confirmarRecaptchaBtn').disabled = true;
    
    if (recaptchaWidgetId !== null) {
        grecaptcha.reset(recaptchaWidgetId);
    } else {
        renderizarRecaptcha();
    }
}

function renderizarRecaptcha() {
    const recaptchaContainer = document.getElementById('recaptchaContainer');
    recaptchaContainer.innerHTML = '';
    
    try {
        recaptchaWidgetId = grecaptcha.render('recaptchaContainer', {
            'sitekey': RECAPTCHA_SITE_KEY,
            'theme': 'dark',
            'size': 'normal',
            'callback': function(response) {
                document.getElementById('confirmarRecaptchaBtn').disabled = false;
            },
            'expired-callback': function() {
                document.getElementById('confirmarRecaptchaBtn').disabled = true;
            },
            'error-callback': function() {
                document.getElementById('confirmarRecaptchaBtn').disabled = true;
            }
        });
    } catch (error) {
        console.error('‚ùå Error cr√≠tico renderizando reCAPTCHA:', error);
        mostrarNotificacion('Error cr√≠tico al cargar el reCAPTCHA. Por favor, recarga la p√°gina.', 'error');
    }
}

function procesarFormularioConRecaptcha() {
    const token = obtenerTokenRecaptcha();
    
    if (!token) {
        mostrarNotificacion('‚ùå Por favor, completa el reCAPTCHA antes de continuar', 'error');
        return false;
    }

    datosFormularioPendiente.recaptchaToken = token;
    cerrarModalRecaptcha();

    if (formularioPendiente === 'reserva') {
        enviarReserva(datosFormularioPendiente);
    } else if (formularioPendiente === 'reprogramacion') {
        enviarReprogramacion(datosFormularioPendiente);
    }
    
    return true;
}

function cerrarModalRecaptcha() {
    document.getElementById('recaptchaModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function obtenerTokenRecaptcha() {
    if (recaptchaWidgetId === null) {
        return '';
    }
    
    try {
        const token = grecaptcha.getResponse(recaptchaWidgetId);
        if (!token) {
            return '';
        }
        return token;
    } catch (error) {
        console.error('‚ùå Error obteniendo token reCAPTCHA:', error);
        return '';
    }
}

// ============================
// üìß FUNCIONES DE ENV√çO PRINCIPALES
// ============================

async function enviarReserva(formData) {
    const errores = validarReserva(formData);
    if (errores.length > 0) {
        mostrarErrores(errores, 'reserva');
        return;
    }

    if (!formData.recaptchaToken) {
        mostrarNotificacion('‚ùå Error de seguridad: Falta la verificaci√≥n reCAPTCHA', 'error');
        return;
    }

    try {
        const payload = {
            type: "reserva",
            name: formData.nombre,
            email: formData.email,
            phone: formData.telefono,
            message: formData.detalles,
            fecha: formData.fecha,
            hora: formData.hora,
            vehiculo: formData.vehiculo,
            localidad: formData.localidad,
            dynoactive: formData.dynoactive,
            recaptchaToken: formData.recaptchaToken
        };

        Swal.fire({ 
            title: 'Enviando reserva...', 
            text: 'Por favor espera',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const response = await fetch(WORKER_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(payload)
        });
        
        const responseText = await response.text();
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            throw new Error('Respuesta inv√°lida del servidor');
        }

        Swal.close();

        if (!response.ok) {
            throw new Error(data.error || `Error HTTP ${response.status}`);
        }

        if (!data.success) {
            throw new Error(data.error || "Error desconocido del servidor");
        }

        mostrarNotificacion("‚úÖ Reserva enviada correctamente. Te contactaremos pronto.", 'success');
        setTimeout(() => { document.getElementById('formReserva').reset(); }, 1000);

    } catch (error) {
        console.error("‚ùå Error en enviarReserva:", error);
        Swal.close();
        mostrarNotificacion(`‚ùå Error al enviar: ${error.message}`, 'error');
    }
}

async function enviarReprogramacion(formData) {
    const errores = validarReprogramacion(formData);
    if (errores.length > 0) {
        mostrarErrores(errores, 'reprogramacion');
        return;
    }

    if (!formData.recaptchaToken) {
        mostrarNotificacion('‚ùå Error de seguridad: Falta la verificaci√≥n reCAPTCHA', 'error');
        return;
    }

    try {
        const fileInput = document.getElementById('archivoReprog');
        let attachment = null;
        
        if (fileInput && fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            const allowed = ['.bin','.zip','.rar','.7z','.gz','.tar'];
            const name = file.name.toLowerCase();
            const ext = name.slice(name.lastIndexOf('.'));
            
            if (!allowed.includes(ext)) {
                mostrarNotificacion('Extensiones permitidas: ' + allowed.join(', '), 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                mostrarNotificacion('M√°ximo permitido: 10MB', 'error');
                return;
            }
            
            const b64 = await fileToBase64(file);
            attachment = { name: file.name, data: b64 };
        }

        const payload = {
            type: "reprogramacion",
            name: formData.nombre,
            email: formData.email,
            phone: formData.telefono,
            message: formData.comentariosECU,
            marcaCoche: formData.marcaCoche,
            modeloCoche: formData.modeloCoche,
            anioCoche: formData.anioCoche,
            potenciaECU: formData.potenciaECU,
            marcaECU: formData.marcaECU,
            serieECU: formData.serieECU,
            opciones: formData.opciones,
            recaptchaToken: formData.recaptchaToken,
            attachment: attachment
        };

        Swal.fire({ 
            title: 'Enviando solicitud...', 
            text: 'Por favor espera',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const response = await fetch(WORKER_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(payload)
        });
        
        const responseText = await response.text();
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            throw new Error('Respuesta inv√°lida del servidor');
        }

        Swal.close();

        if (!response.ok) {
            throw new Error(data.error || `Error HTTP ${response.status}`);
        }

        if (!data.success) {
            throw new Error(data.error || "Error desconocido del servidor");
        }

        mostrarNotificacion("‚úÖ Solicitud de reprogramaci√≥n enviada correctamente. Te contactaremos pronto.", 'success');
        setTimeout(() => { document.getElementById('formReprog').reset(); }, 1000);

    } catch (error) {
        console.error("‚ùå Error en enviarReprogramacion:", error);
        Swal.close();
        mostrarNotificacion(`‚ùå Error al enviar: ${error.message}`, 'error');
    }
}

// ============================
// üîç FUNCIONES DE VALIDACI√ìN
// ============================

function validarReserva(datos) {
  const errores = [];
  
  if (!datos.nombre || datos.nombre.trim().length < 2) {
    errores.push({ campo: 'nombreRes', mensaje: 'El nombre y apellidos son obligatorios (m√≠nimo 2 caracteres)' });
  }
  
  if (!datos.telefono || !validarTelefono(datos.telefono)) {
    errores.push({ campo: 'telefonoRes', mensaje: 'El tel√©fono es obligatorio y debe tener un formato v√°lido' });
  }
  
  if (!datos.email || !validarEmail(datos.email)) {
    errores.push({ campo: 'emailRes', mensaje: 'El email es obligatorio y debe tener un formato v√°lido' });
  }
  
  if (!datos.fecha || !validarFechaFutura(datos.fecha)) {
    errores.push({ campo: 'fechaRes', mensaje: 'La fecha es obligatoria y debe ser futura' });
  }
  
  if (!datos.hora) {
    errores.push({ campo: 'horaRes', mensaje: 'La hora es obligatoria' });
  }
  
  if (!datos.vehiculo || datos.vehiculo.trim().length < 2) {
    errores.push({ campo: 'vehiculoRes', mensaje: 'La marca y modelo son obligatorios' });
  }
  
  if (!datos.localidad || datos.localidad.trim().length < 2) {
    errores.push({ campo: 'localidadRes', mensaje: 'La localidad es obligatoria' });
  }
  
  if (!datos.dynoactive) {
    errores.push({ campo: 'dynoactiveRes', mensaje: 'Debes seleccionar una opci√≥n para DynoActive' });
  }
  
  if (!datos.detalles || datos.detalles.trim().length < 10) {
    errores.push({ campo: 'detallesRes', mensaje: 'Los detalles del servicio son obligatorios (m√≠nimo 10 caracteres)' });
  }
  
  return errores;
}

function validarReprogramacion(datos) {
  const errores = [];
  
  if (!datos.nombre || datos.nombre.trim().length < 2) {
    errores.push({ campo: 'nombreReprog', mensaje: 'El nombre y apellidos son obligatorios (m√≠nimo 2 caracteres)' });
  }
  
  if (!datos.telefono || !validarTelefono(datos.telefono)) {
    errores.push({ campo: 'telefonoReprog', mensaje: 'El tel√©fono es obligatorio y debe tener un formato v√°lido' });
  }
  
  if (!datos.email || !validarEmail(datos.email)) {
    errores.push({ campo: 'emailReprog', mensaje: 'El email es obligatorio y debe tener un formato v√°lido' });
  }
  
  if (!datos.marcaCoche || datos.marcaCoche.trim().length < 2) {
    errores.push({ campo: 'marcaCoche', mensaje: 'La marca del veh√≠culo es obligatoria' });
  }
  
  if (!datos.modeloCoche || datos.modeloCoche.trim().length < 1) {
    errores.push({ campo: 'modeloCoche', mensaje: 'El modelo del veh√≠culo es obligatorio' });
  }
  
  if (!datos.anioCoche || !validarAnio(datos.anioCoche)) {
    errores.push({ campo: 'anioCoche', mensaje: 'El a√±o del veh√≠culo es obligatorio (entre 1990 y 2025)' });
  }
  
  if (!datos.potenciaECU || !validarPotencia(datos.potenciaECU)) {
    errores.push({ campo: 'potenciaECU', mensaje: 'La potencia es obligatoria y debe ser un n√∫mero positivo' });
  }
  
  if (!datos.marcaECU || datos.marcaECU.trim().length < 2) {
    errores.push({ campo: 'marcaECU', mensaje: 'La marca de la ECU es obligatoria' });
  }
  
  if (!datos.serieECU || datos.serieECU.trim().length < 2) {
    errores.push({ campo: 'serieECU', mensaje: 'El n√∫mero de serie de la ECU es obligatorio' });
  }
  
  return errores;
}

// ============================
// üîß FUNCIONES AUXILIARES
// ============================

function validarTelefono(telefono) {
  const regexTelefono = /^[+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,4}[-\s\.]?[0-9]{1,9}$/;
  return regexTelefono.test(telefono.replace(/\s/g, ''));
}

function validarEmail(email) {
  const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regexEmail.test(email);
}

function validarFechaFutura(fecha) {
  const hoy = new Date();
  const fechaSeleccionada = new Date(fecha);
  hoy.setHours(0, 0, 0, 0);
  return fechaSeleccionada >= hoy;
}

function validarAnio(anio) {
  const anioNum = parseInt(anio);
  return anioNum >= 1990 && anioNum <= new Date().getFullYear() + 1;
}

function validarPotencia(potencia) {
  const potenciaNum = parseFloat(potencia);
  return !isNaN(potenciaNum) && potenciaNum > 0;
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result;
      const idx = result.indexOf(',') + 1;
      resolve(result.slice(idx));
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function mostrarNotificacion(text, type = 'info') {
  const opts = { 
    toast: true, 
    position: 'top-end', 
    showConfirmButton: false, 
    timer: 3500,
    title: text
  };
  
  if (type === 'success') opts.icon = 'success';
  else if (type === 'error') opts.icon = 'error';
  else if (type === 'warning') opts.icon = 'warning';
  else opts.icon = 'info';
  
  Swal.fire(opts);
}

function mostrarErrores(errores, tipo) {
  limpiarErrores();
  
  const erroresPorCampo = {};
  errores.forEach(error => {
    if (!erroresPorCampo[error.campo]) {
      erroresPorCampo[error.campo] = [];
    }
    erroresPorCampo[error.campo].push(error.mensaje);
  });
  
  Object.keys(erroresPorCampo).forEach(campoId => {
    const campo = document.getElementById(campoId);
    if (campo) {
      campo.classList.add('campo-error');
      
      const mensajeError = document.createElement('span');
      mensajeError.className = 'mensaje-error';
      mensajeError.textContent = erroresPorCampo[campoId][0];
      campo.parentNode.appendChild(mensajeError);
    }
  });
  
  mostrarResumenErrores(errores, tipo);
}

function mostrarResumenErrores(errores, tipo) {
  const seccionId = tipo === 'reserva' ? 'reservas' : 'reprogramacion';
  const seccion = document.getElementById(seccionId);
  
  const resumenAnterior = seccion.querySelector('.formulario-error');
  if (resumenAnterior) {
    resumenAnterior.remove();
  }
  
  const resumenError = document.createElement('div');
  resumenError.className = 'formulario-error';
  resumenError.innerHTML = `
    <h4>‚ùå Por favor, corrige los siguientes errores:</h4>
    <ul>
      ${errores.map(error => `<li>${error.mensaje}</li>`).join('')}
    </ul>
  `;
  
  const formCard = seccion.querySelector('.form-card');
  seccion.insertBefore(resumenError, formCard);
  resumenError.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function limpiarErrores() {
  document.querySelectorAll('.campo-error').forEach(campo => {
    campo.classList.remove('campo-error');
  });
  
  document.querySelectorAll('.mensaje-error').forEach(mensaje => {
    mensaje.remove();
  });
  
  document.querySelectorAll('.formulario-error').forEach(resumen => {
    resumen.remove();
  });
}

// ============================
// FUNCIONES PARA OBTENER DATOS
// ============================

function obtenerDatosReserva() {
    return {
        nombre: (document.getElementById("nombreRes")?.value || '').trim(),
        telefono: (document.getElementById("telefonoRes")?.value || '').trim(),
        email: (document.getElementById("emailRes")?.value || '').trim(),
        fecha: (document.getElementById("fechaRes")?.value || ''),
        hora: (document.getElementById("horaRes")?.value || ''),
        vehiculo: (document.getElementById("vehiculoRes")?.value || '').trim(),
        localidad: (document.getElementById("localidadRes")?.value || '').trim(),
        dynoactive: (document.getElementById("dynoactiveRes")?.value || ''),
        detalles: (document.getElementById("detallesRes")?.value || '').trim(),
        recaptchaToken: ''
    };
}

function obtenerDatosReprogramacion() {
    const opciones = Array.from(document.querySelectorAll('#formReprog input[name="opciones"]:checked'))
        .map(cb => cb.value);
    
    return {
        nombre: (document.getElementById("nombreReprog")?.value || '').trim(),
        telefono: (document.getElementById("telefonoReprog")?.value || '').trim(),
        email: (document.getElementById("emailReprog")?.value || '').trim(),
        marcaCoche: (document.getElementById("marcaCoche")?.value || '').trim(),
        modeloCoche: (document.getElementById("modeloCoche")?.value || '').trim(),
        anioCoche: (document.getElementById("anioCoche")?.value || ''),
        potenciaECU: (document.getElementById("potenciaECU")?.value || ''),
        marcaECU: (document.getElementById("marcaECU")?.value || '').trim(),
        serieECU: (document.getElementById("serieECU")?.value || '').trim(),
        comentariosECU: (document.getElementById("comentariosECU")?.value || '').trim(),
        opciones: opciones,
        recaptchaToken: ''
    };
}

function obtenerDatosFacturacion() {
  return {
    nombre: document.getElementById('facturacionNombre').value.trim(),
    email: document.getElementById('facturacionEmail').value.trim(),
    telefono: document.getElementById('facturacionTelefono').value.trim(),
    nif: document.getElementById('facturacionNIF').value.trim(),
    direccion: document.getElementById('facturacionDireccion').value.trim(),
    cp: document.getElementById('facturacionCP').value.trim(),
    ciudad: document.getElementById('facturacionCiudad').value.trim(),
    pais: document.getElementById('facturacionPais').value.trim()
  };
}

function validarDatosFacturacion(datos) {
  const errores = [];
  
  if (!datos.nombre) errores.push('El nombre es obligatorio');
  if (!datos.email || !validarEmail(datos.email)) errores.push('El email es obligatorio y debe ser v√°lido');
  if (!datos.telefono || !validarTelefono(datos.telefono)) errores.push('El tel√©fono es obligatorio y debe ser v√°lido');
  if (!datos.nif) errores.push('El NIF/CIF es obligatorio');
  if (!datos.direccion) errores.push('La direcci√≥n es obligatoria');
  if (!datos.cp) errores.push('El c√≥digo postal es obligatorio');
  if (!datos.ciudad) errores.push('La ciudad es obligatoria');
  if (!datos.pais) errores.push('El pa√≠s es obligatorio');
  
  return errores;
}

// ============================
// üõí SISTEMA DE CARRITO MEJORADO
// ============================

function agregarAlCarrito(id, nombre, precio) {
    // Validar datos de entrada
    if (!id || !nombre || precio === undefined || precio === null) {
        console.error('‚ùå Datos inv√°lidos para agregar al carrito:', { id, nombre, precio });
        mostrarNotificacion('Error: Datos del producto inv√°lidos', 'error');
        return;
    }

    // Validar que el precio sea un n√∫mero positivo
    const precioNum = parseFloat(precio);
    if (isNaN(precioNum) || precioNum < 0) {
        console.error('‚ùå Precio inv√°lido:', precio);
        mostrarNotificacion('Error: Precio del producto inv√°lido', 'error');
        return;
    }

    const productoExistente = window.appState.carrito.find(item => item.id === id);
    
    if (productoExistente) {
        productoExistente.cantidad += 1;
    } else {
        window.appState.carrito.push({
            id: id,
            nombre: nombre,
            precio: precioNum,
            cantidad: 1
        });
    }
    
    guardarCarrito();
    actualizarCarrito();
    cerrarCatalogo();
    mostrarNotificacion(`‚úÖ ${nombre} a√±adido al carrito`, 'success');
    
    setTimeout(() => {
        scrollToCarrito();
    }, 500);
}

function actualizarCantidadProducto(id, nuevaCantidad) {
    const producto = window.appState.carrito.find(item => item.id === id);
    if (producto) {
        if (nuevaCantidad <= 0) {
            eliminarDelCarrito(id);
        } else {
            producto.cantidad = nuevaCantidad;
            guardarCarrito();
            actualizarCarrito();
        }
    }
}

function eliminarDelCarrito(id) {
  window.appState.carrito = window.appState.carrito.filter(item => item.id !== id);
  guardarCarrito();
  actualizarCarrito();
}

function vaciarCarrito() {
  if (window.appState.carrito.length === 0) {
    mostrarNotificacion('El carrito ya est√° vac√≠o', 'info');
    return;
  }
  
  Swal.fire({
    title: '¬øVaciar carrito?',
    text: "Se eliminar√°n todos los productos del carrito",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, vaciar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      window.appState.carrito = [];
      localStorage.removeItem('reprogarage-carrito');
      guardarCarrito();
      actualizarCarrito();
      mostrarNotificacion('Carrito vaciado correctamente', 'success');
    }
  });
}

function actualizarCarrito() {
  const container = document.getElementById('cartList');
  const totalElement = document.getElementById('cartTotal');
  const checkoutBtn = document.getElementById('btnPagar');
  
  if (!container) return;
  
  if (window.appState.carrito.length === 0) {
    container.innerHTML = '<li style="text-align:center;color:var(--muted);padding:20px;">üõí Carrito vac√≠o</li>';
    if (totalElement) totalElement.textContent = '‚Ç¨0';
    if (checkoutBtn) checkoutBtn.disabled = true;
    return;
  }
  
  let html = '';
  let total = 0;
  
  window.appState.carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    total += subtotal;
    
    html += `
      <li style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px dashed rgba(255,255,255,0.1);">
        <div style="flex:1">
          <div style="font-weight:600;font-size:0.9rem;">${item.nombre}</div>
          <div style="font-size:0.8rem;color:var(--muted);margin-top:4px;">
            <button onclick="actualizarCantidadProducto('${item.id}', ${item.cantidad - 1})" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;">‚àí</button>
            <span style="margin:0 8px;">${item.cantidad}</span>
            <button onclick="actualizarCantidadProducto('${item.id}', ${item.cantidad + 1})" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;">+</button>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:600;">${subtotal}‚Ç¨</div>
          <button onclick="eliminarDelCarrito('${item.id}')" style="background:none;border:none;color:#ff6b6b;font-size:0.7rem;cursor:pointer;margin-top:4px;">Eliminar</button>
        </div>
      </li>
    `;
  });
  
  container.innerHTML = html;
  if (totalElement) totalElement.textContent = `‚Ç¨${total.toFixed(2)}`;
  if (checkoutBtn) checkoutBtn.disabled = false;
}

function guardarCarrito() {
  try {
    localStorage.setItem('reprogarage-carrito', JSON.stringify(window.appState.carrito));
  } catch (e) {
    console.warn('No se pudo guardar el carrito:', e);
  }
}

function cargarCarrito() {
  try {
    const carritoGuardado = localStorage.getItem('reprogarage-carrito');
    if (carritoGuardado) {
      window.appState.carrito = JSON.parse(carritoGuardado);
    }
  } catch (e) {
    console.warn('No se pudo cargar el carrito:', e);
  }
  actualizarCarrito();
}

// ============================
// üõ°Ô∏è VALIDACI√ìN DE CARRITO ANTES DE PAGO
// ============================

function validarCarritoAntesDePago() {
    if (!window.appState.carrito || window.appState.carrito.length === 0) {
        return { valido: false, error: 'El carrito est√° vac√≠o' };
    }
    
    // Validar que todos los productos tengan datos v√°lidos
    const productosInvalidos = window.appState.carrito.filter(item => 
        !item.id || !item.nombre || item.precio === undefined || item.precio === null || item.precio < 0
    );
    
    if (productosInvalidos.length > 0) {
        return { valido: false, error: 'Algunos productos tienen datos inv√°lidos' };
    }
    
    // Validar que las cantidades sean positivas
    const cantidadesInvalidas = window.appState.carrito.filter(item => 
        item.cantidad <= 0
    );
    
    if (cantidadesInvalidas.length > 0) {
        return { valido: false, error: 'Algunas cantidades son inv√°lidas' };
    }
    
    return { valido: true, error: null };
}

// ============================
// üí≥ PROCESO DE PAGO MEJORADO
// ============================

function procederPago() {
    const validacion = validarCarritoAntesDePago();
    if (!validacion.valido) {
        mostrarNotificacion(`‚ùå ${validacion.error}`, 'error');
        return;
    }
    mostrarModalSeleccionMetodo();
}

// ============================
// üöÄ INICIALIZACI√ìN
// ============================

document.addEventListener('DOMContentLoaded', function() {
  const yearEl = document.getElementById('year'); 
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  manejarRetornoStripe();

  const btnHamb = document.getElementById('btnHamb'); 
  if (btnHamb) { 
    btnHamb.addEventListener('click', openMenu);
  } 
  
  const btnClose = document.getElementById('btnClose');
  if (btnClose) {
    btnClose.addEventListener('click', closeMenu);
  } 

  const backBtn = document.getElementById('backToTop'); 
  if (backBtn) {
    window.addEventListener('scroll', function() { 
      if (window.scrollY > 400) { 
        backBtn.style.display = 'flex'; 
      } else { 
        backBtn.style.display = 'none'; 
      } 
    }); 
    backBtn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
  }

  const closeCatalogBtn = document.getElementById('closeCatalogBtn');
  if (closeCatalogBtn) {
    closeCatalogBtn.addEventListener('click', cerrarCatalogo);
  }
  
  const catalogoModal = document.getElementById('catalogoModal');
  if (catalogoModal) {
    catalogoModal.addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarCatalogo();
      }
    });
  }

  const closeSeleccionMetodoBtn = document.getElementById('closeSeleccionMetodoBtn');
  if (closeSeleccionMetodoBtn) {
    closeSeleccionMetodoBtn.addEventListener('click', cerrarModalSeleccionMetodo);
  }

  const cancelarSeleccionMetodoBtn = document.getElementById('cancelarSeleccionMetodoBtn');
  if (cancelarSeleccionMetodoBtn) {
    cancelarSeleccionMetodoBtn.addEventListener('click', cerrarModalSeleccionMetodo);
  }

  document.getElementById('seleccionMetodoPagoModal').addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarModalSeleccionMetodo();
    }
  });

  document.querySelectorAll('#seleccionMetodoPagoModal .metodo-pago').forEach(btn => {
    btn.addEventListener('click', function() {
      metodoPagoSeleccionado = this.dataset.metodo;
      cerrarModalSeleccionMetodo();

      if (metodoPagoSeleccionado === 'stripe') {
        procesarPagoStripe();
      } else {
        mostrarModalFacturacion();
      }
    });
  });

  const closeFacturacionBtn = document.getElementById('closeFacturacionBtn');
  if (closeFacturacionBtn) {
    closeFacturacionBtn.addEventListener('click', cerrarModalFacturacion);
  }

  const cancelarFacturacionBtn = document.getElementById('cancelarFacturacionBtn');
  if (cancelarFacturacionBtn) {
    cancelarFacturacionBtn.addEventListener('click', cerrarModalFacturacion);
  }

  document.getElementById('facturacionModal').addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarModalFacturacion();
    }
  });

  const confirmarFacturacionBtn = document.getElementById('confirmarFacturacionBtn');
  if (confirmarFacturacionBtn) {
    confirmarFacturacionBtn.addEventListener('click', function() {
      const datosFacturacion = obtenerDatosFacturacion();
      const errores = validarDatosFacturacion(datosFacturacion);
      
      if (errores.length > 0) {
        mostrarNotificacion('Por favor, completa todos los campos obligatorios', 'error');
        return;
      }
      
      cerrarModalFacturacion();
      realizarPagoManual(datosFacturacion);
    });
  }

  const closeRecaptchaBtn = document.getElementById('closeRecaptchaBtn');
  if (closeRecaptchaBtn) {
    closeRecaptchaBtn.addEventListener('click', cerrarModalRecaptcha);
  }

  const cancelarRecaptchaBtn = document.getElementById('cancelarRecaptchaBtn');
  if (cancelarRecaptchaBtn) {
    cancelarRecaptchaBtn.addEventListener('click', cerrarModalRecaptcha);
  }

  const confirmarRecaptchaBtn = document.getElementById('confirmarRecaptchaBtn');
  if (confirmarRecaptchaBtn) {
    confirmarRecaptchaBtn.addEventListener('click', function() {
        procesarFormularioConRecaptcha();
    });
  }

  document.getElementById('recaptchaModal').addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarModalRecaptcha();
    }
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      cerrarCatalogo();
      closeMenu();
      cerrarModalSeleccionMetodo();
      cerrarModalFacturacion();
      cerrarModalRecaptcha();
      document.body.style.overflow = 'auto';
    }
  });

  const btnVaciar = document.getElementById('btnVaciar');
  if (btnVaciar) {
    btnVaciar.addEventListener('click', vaciarCarrito);
  }

  const btnReserva = document.getElementById('btnEnviarReserva');
  if (btnReserva) {
    btnReserva.addEventListener('click', function() {
      limpiarErrores();
      const formData = obtenerDatosReserva();
      const errores = validarReserva(formData);
      if (errores.length > 0) {
        mostrarErrores(errores, 'reserva');
        return;
      }
      abrirModalRecaptcha('reserva', formData);
    });
  }

  const btnReprog = document.getElementById('btnEnviarReprogramacion');
  if (btnReprog) {
    btnReprog.addEventListener('click', function() {
      limpiarErrores();
      const formData = obtenerDatosReprogramacion();
      const errores = validarReprogramacion(formData);
      if (errores.length > 0) {
        mostrarErrores(errores, 'reprogramacion');
        return;
      }
      abrirModalRecaptcha('reprogramacion', formData);
    });
  }

  cargarCarrito();

  const formReserva = document.getElementById('formReserva'); 
  if (formReserva) { 
    formReserva.addEventListener('submit', function(e) { 
      e.preventDefault(); 
    }); 
  }
  
  const formReprog = document.getElementById('formReprog'); 
  if (formReprog) { 
    formReprog.addEventListener('submit', function(e) { 
      e.preventDefault(); 
    }); 
  }
});

// ============================
// üèéÔ∏è SISTEMA DE CAT√ÅLOGO
// ============================

const catalogoMarcas = [
  { id: 'audi', nombre: 'Audi', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/92/Audi-Logo_2016.svg/300px-Audi-Logo_2016.svg.png' },
  { id: 'bmw', nombre: 'BMW', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/300px-BMW.svg.png' },
  { id: 'mercedes', nombre: 'Mercedes-Benz', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/Mercedes-Logo.svg/300px-Mercedes-Logo.svg.png' },
  { id: 'volkswagen', nombre: 'Volkswagen', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Volkswagen_logo_2019.svg/300px-Volkswagen_logo_2019.svg.png' }
];

function mostrarCatalogo(tipoStage) {
  window.appState.tipoStage = tipoStage;
  document.getElementById('modalTitulo').textContent = `üìÅ Cat√°logo - ${tipoStage}`;
  document.getElementById('catalogoModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  cargarCategorias();
}

function cerrarCatalogo() {
  document.getElementById('catalogoModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function cargarCategorias() {
  const categoriasGrid = document.getElementById('categoriasGrid');
  categoriasGrid.innerHTML = '';
  
  catalogoMarcas.forEach(marca => {
    const botonCategoria = document.createElement('button');
    botonCategoria.className = 'categoria-btn';
    botonCategoria.innerHTML = `
      <img src="${marca.logo}" alt="${marca.nombre}" class="logo-marca">
      <span>${marca.nombre}</span>
    `;
    
    botonCategoria.addEventListener('click', () => {
      mostrarArchivosEjemplo(marca);
    });
    categoriasGrid.appendChild(botonCategoria);
  });
}

function mostrarArchivosEjemplo(marca) {
  const archivosGrid = document.getElementById('archivosGrid');
  archivosGrid.innerHTML = '';
  
  const archivosFiltrados = Object.entries(archivosECU).filter(([id, archivo]) => {
    const marcaId = marca.id.toLowerCase();
    const stageTipo = window.appState.tipoStage.toLowerCase();
    return id.includes(marcaId) && id.includes(stageTipo.toLowerCase().replace(' ', ''));
  });
  
  if (archivosFiltrados.length === 0) {
    archivosGrid.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted);">
        <p>No hay archivos disponibles para ${marca.nombre} - ${window.appState.tipoStage}</p>
        <p>Contacta con nosotros para archivos personalizados</p>
      </div>
    `;
    return;
  }
  
  archivosFiltrados.forEach(([id, archivo]) => {
    const archivoCard = document.createElement('div');
    archivoCard.className = 'archivo-card';
    archivoCard.innerHTML = `
      <div class="archivo-header">
        <h4 class="archivo-title">${archivo.nombre}</h4>
        <div class="archivo-precio">${archivo.precio}‚Ç¨</div>
      </div>
      <div class="archivo-info">
        <div><strong>Compatibilidad:</strong> ${archivo.compatibilidad}</div>
        <div><strong>Archivo:</strong> ${archivo.archivo}</div>
      </div>
      <div class="archivo-features">
        <span class="feature-tag">Descarga inmediata</span>
        <span class="feature-tag">Soporte t√©cnico</span>
        <span class="feature-tag">Garant√≠a 30 d√≠as</span>
      </div>
      <button class="add-to-cart-btn" onclick="agregarAlCarrito('${id}', '${archivo.nombre}', ${archivo.precio})">
        A√±adir al Carrito - ${archivo.precio}‚Ç¨
      </button>
    `;
    
    archivosGrid.appendChild(archivoCard);
  });
  
  document.getElementById('subcategorias').classList.add('active');
  document.getElementById('subcategoriaTitle').textContent = `Archivos ${marca.nombre} - ${window.appState.tipoStage}`;
}

// ============================
// üß≠ FUNCIONES DE NAVEGACI√ìN
// ============================

function openMenu() {
  const menu = document.getElementById('sideMenu');
  if (menu) {
    menu.classList.add('open');
    menu.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
}

function closeMenu() {
  const menu = document.getElementById('sideMenu');
  if (menu) {
    menu.classList.remove('open');
    menu.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = 'auto';
  }
}

function handleMenuClick(section) {
  closeMenu();
  setTimeout(() => {
    const el = document.getElementById(section);
    if (el) {
      const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
      window.scrollTo({ top: y, behavior: 'smooth' });
    }
  }, 300);
}

function scrollToCarrito() {
  const el = document.getElementById('carrito');
  if (el) {
    const y = el.getBoundingClientRect().top + window.pageYOffset - 100;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
}

function scrollToContacto() {
  const el = document.getElementById('contacto');
  if (el) {
    const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
}

// ============================
// üõ°Ô∏è SCRIPT ANTI-FRAMING
// ============================

if (top != self) {
  top.location.replace(self.location.href);
}
</script>
</body>
</html>