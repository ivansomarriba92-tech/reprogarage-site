<!DOCTYPE html>
<html lang="es">
<head>

  <!-- SEO / Social meta tags added -->
  <meta name="description" content="ReproGarage — Reprogramación de ECU, archivos Stage 1 y Stage 2. Reprogramaciones a medida para particulares y talleres en España."/>
  <meta name="keywords" content="reprogramacion ECU, tuning, archivos stage 1, stage 2, reprogarage, reprogramacion coche, chip tuning, aumentar potencia"/>
  <meta property="og:locale" content="es_ES" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ReproGarage.es — Reprogramación ECU Profesional" />
  <meta property="og:description" content="Archivos Stage 1/2 y reprogramaciones a medida. Servicios para particulares y talleres en España. Reserva online y compra segura." />
  <meta property="og:url" content="https://reprogarage.es/" />
  <meta property="og:image" content="https://reprogarage.es/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@ReproGarage" />
  <meta name="twitter:title" content="ReproGarage.es — Reprogramación ECU Profesional" />
  <meta name="twitter:description" content="Archivos Stage 1/2 y reprogramaciones a medida. Reserva online y compra segura." />
  <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Structured data (Organization) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "ReproGarage",
    "url": "https://reprogarage.es/",
    "logo": "https://reprogarage.es/logo.png",
    "contactPoint": [{"@type":"ContactPoint","telephone":"+34 644 777 079","contactType":"customer service","areaServed":"ES"}],
    "sameAs": ["https://www.facebook.com/reprogarage","https://www.instagram.com/reprogarage"]
  }
  </script>
  <meta name="robots" content="index, follow" />
  <meta name="google-site-verification" content="PUT_YOUR_VERIFICATION_TOKEN_HERE" />
  <!-- End SEO additions -->

<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" name="viewport"/>
<meta content="#1E90FF" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="ReproGarage" name="apple-mobile-web-app-title"/>
<meta content="telephone=no" name="format-detection"/>
<meta content="ReproGarage - Reprogramación de ECU y tuning profesional. Archivos Stage 1 y Stage 2, reprogramaciones a medida para particulares y talleres en España." name="description"/>
<meta content="reprogramación ECU, tuning, archivos stage 1, stage 2, reprogarage, chip tuning, potencia coche, BMW, Audi, Mercedes, Volkswagen" name="keywords"/>
<link href="https://reprogarage.es" rel="canonical"/>
<!-- SECURITY HEADERS (mantenidos) -->
<meta content="
  default-src 'self';
  script-src 'self' https://js.stripe.com https://cdn.jsdelivr.net https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ 'unsafe-inline' https://cdn.jsdelivr.net;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' data: https:;
  connect-src 'self' https://api.emailjs.com https://www.google.com/recaptcha/;
  frame-src https://js.stripe.com https://www.google.com/recaptcha/;
  base-uri 'self';
  form-action 'self';
" http-equiv="Content-Security-Policy"/>
<meta content="nosniff" http-equiv="X-Content-Type-Options"/>
<meta content="DENY" http-equiv="X-Frame-Options"/>
<meta content="1; mode=block" http-equiv="X-XSS-Protection"/>
<meta content="strict-origin-when-cross-origin" http-equiv="Referrer-Policy"/>
<!-- Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&amp;display=swap" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
<noscript><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&amp;display=swap" rel="stylesheet"/></noscript>
<!-- Social / Open Graph -->
<meta content="ReproGarage - Reprogramación ECU Profesional" property="og:title"/>
<meta content="Reprogramaciones ECU seguras y archivos Stage 1/Stage 2. Servicios optimizados para particulares y talleres en España." property="og:description"/>
<meta content="https://reprogarage.es/og-image.jpg" property="og:image"/>
<meta content="https://reprogarage.es" property="og:url"/>
<meta content="website" property="og:type"/>
<meta content="ReproGarage" property="og:site_name"/>
<meta content="es_ES" property="og:locale"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="ReproGarage - Reprogramación ECU" name="twitter:title"/>
<meta content="Archivos ECU seguros y reprogramaciones profesionales en España" name="twitter:description"/>
<title>ReproGarage.es — Reprogramación ECU y Tuning Profesional</title>
<style>
:root{ --bg-1:#0b0b0e; --electric-blue:#1E90FF; --purple:#8E44AD; --accent:#DA70D6; --card-bg:#2F2F2F; --glass:rgba(255,255,255,0.03); --text:#fff; --muted:#cfcfe0; --radius:12px; --gap:18px; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Montserrat, system-ui, Arial, sans-serif;background:linear-gradient(90deg, #757575 0%, #2F2F2F 100%);color:var(--text);-webkit-font-smoothing:antialiased;background-attachment:fixed}
.wrap{max-width:1140px;margin:0 auto;padding:20px 16px}
.nav{position:sticky;top:0;z-index:120;backdrop-filter:blur(6px);background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.12));padding-top:env(safe-area-inset-top)}
.nav-inner{display:flex;align-items:center;max-width:1140px;margin:0 auto;padding:12px 16px 12px 30px;position:relative}
.brand{display:flex;align-items:center;gap:12px}
/* LOGO MÁS GRANDE - OCUPA TODO EL ENCABEZADO */
.brand .logo{width:80px;height:80px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden;margin-top:-5px;margin-bottom:-5px}
.brand .logo img{width:100%;height:100%;object-fit:contain}
/* MENÚ FIJO CON ESTILO ORIGINAL - SIN FONDO OSCURO */
.nav-links{
    display:flex;
    gap:16px;
    align-items:center;
    position:fixed !important;
    right:20px !important;
    top:50% !important;
    transform:translateY(-50%) !important;
    margin:0 !important;
    z-index:1000 !important;
}
.nav-links a{
    padding:10px 8px;
    border-radius:8px;
    color:#ffffff !important;
    font-weight:600;
    text-decoration:none;
    white-space:nowrap;
    background: transparent !important;
}
.nav-links a:hover {
    background: rgba(255,255,255,0.1) !important;
}
.hamburger{display:none;background:none;border:0;color:var(--text);padding:8px}
.side-menu{position:fixed;right:0;top:0;height:100vh;width:320px;background:linear-gradient(0deg, rgba(8,3,20,0.95), rgba(20,4,40,0.95));transform:translateX(110%);transition:transform .35s;z-index:200;padding:28px;display:flex;flex-direction:column}
.side-menu.open{transform:translateX(0)}
.side-menu a { color: #ffffff; text-decoration: none; }
/* Header */
header.main-header{position:relative;min-height:420px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;background: url('https://i.ibb.co/Y7cvnHj1/reprogarage-header.png') center center / cover no-repeat}
.hero-inner{z-index:2}
.hero-title{font-size:2rem;margin:0}
.hero-sub{color:#ffffff;margin-top:8px;text-shadow:0 2px 4px rgba(0,0,0,0.5);}
.cta{display:inline-block;padding:12px 18px;border-radius:12px;background:linear-gradient(135deg,var(--electric-blue),#4aa0ff);border:0;color:white;font-weight:700}

/* ========== GRID PRINCIPAL MODIFICADO ========== */
.grid{
    display:grid;
    grid-template-columns: 1fr 400px;
    gap: 40px;
    margin-top:20px;
    align-items: start;
}

/* PRODUCTOS - TRES COLUMNAS EN DESKTOP */
.productos {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    max-width: 100%;
}

/* Tarjetas mantienen su tamaño */
.producto {
    background: var(--card-bg);
    padding: 14px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.04);
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 380px;
}

.producto img {
    width: 100%;
    display: block;
    border-radius: 8px;
    margin-bottom: 10px;
    object-fit: cover;
    height: 130px;
}

.producto h4 {
    margin: 8px 0 4px;
    font-size: 1.1rem;
}

.producto p {
    flex-grow: 1;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* ========== COLUMNA DERECHA MÁS SEPARADA ========== */
.panel{
    background: linear-gradient(90deg, #757575 0%, #2F2F2F 100%);
    padding:16px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.04);
    margin-left: 20px;
}

.imagenes-derecha {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    margin-left: 20px;
}

.imagen-derecha {
    background: transparent;
    border-radius: 12px;
    overflow: hidden;
    border: none;
    width: 100%;
    margin-left: 0;
    position: relative;
}

.imagen-derecha img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
    border-radius: 12px;
}

.imagen-contenido {
    padding: 12px;
}

.imagen-contenido h4 {
    margin: 0 0 6px 0;
    color: var(--text);
    font-size: 0.95rem;
}

.imagen-contenido p {
    color: var(--muted);
    font-size: 0.8rem;
    line-height: 1.4;
    margin: 0;
}

/* Texto de medios de pago */
.texto-pagos {
    text-align: center;
    color: #ffffff !important;
    font-size: 0.92rem;
    margin: 15px 0;
    padding: 12px;
    background: transparent;
    border-radius: 8px;
    font-weight: 600;
    margin-left: 20px;
}

/* Responsive: 1 columna en móvil */
@media (max-width: 980px) {
    .productos {
        grid-template-columns: 1fr;
        gap: 18px;
    }
    
    .producto {
        min-height: auto;
    }
    
    .grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .panel,
    .imagenes-derecha,
    .texto-pagos {
        margin-left: 0;
    }
}

/* Fondo de los formularios cambiado a var(--card-bg) */
#reservas .form-card,
#reprogramacion .form-card {
    background: var(--card-bg);
    padding:14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.04);
}

.form-row{display:flex;gap:10px}
.form-row .col{flex:1}

/* CAMBIO: CAMPOS DE FORMULARIO CON FONDO BLANCO ROTO MÁS OSCURO */
input,select,textarea{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:0;
    background:#e0e0e0; /* Cambiado a un blanco más roto y oscuro */
    color:#000000
}

/* CHECKBOX GROUP CON AJUSTE PARA POPS AND BANGS - ESCRITORIO */
.checkbox-group{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:15px;
}

/* Ajuste específico para escritorio - Límite de corte en su posición original */
.checkbox-group label:nth-child(9) {
    /* Esto asegura que "Límite de corte" esté en la posición correcta en escritorio */
    order: 9;
}

/* BOTÓN DE ELEGIR ARCHIVO EN GRIS - MANTENIENDO EL CAMPO ORIGINAL */
.file-input-container {
  margin-top: 15px;
}

.file-input-label {
  display: block;
  margin-bottom: 8px;
  color: #ffffff;
  font-weight: 600;
}

.file-input {
  background: #e0e0e0 !important; /* Mantenemos el fondo original */
  padding: 10px;
  border-radius: 8px;
  color: #000000 !important; /* Texto negro como antes */
  width: 100%;
  border: 0;
}

/* BOTÓN DE ELEGIR ARCHIVO EN GRIS */
.file-input::file-selector-button {
  background: #757575 !important; /* Gris como solicitado */
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 10px;
  font-weight: 600;
}

.file-input::file-selector-button:hover {
  background: #5a5a5a !important; /* Gris más oscuro al hover */
}

/* Estilo para navegadores WebKit (Chrome, Safari) */
.file-input::-webkit-file-upload-button {
  background: #757575 !important; /* Gris como solicitado */
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 10px;
  font-weight: 600;
}

.file-input::-webkit-file-upload-button:hover {
  background: #5a5a5a !important; /* Gris más oscuro al hover */
}

/* Floating WhatsApp CTA */
#whatsappCTA{position:fixed;right:18px;bottom:18px;background:#25D366;color:#fff;border-radius:50%;width:62px;height:62px;display:flex;align-items:center;justify-content:center;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,0.3);text-decoration:none}
#whatsappCTA:focus{outline:3px solid rgba(37,211,102,0.25)}
/* Back to top - CAMBIADO A AZUL ELÉCTRICO */
#backToTop{position:fixed;bottom:96px;right:20px;background:var(--electric-blue);color:white;border:0;border-radius:50%;width:50px;height:50px;display:none;align-items:center;justify-content:center;z-index:99}

/* PLACEHOLDERS EN NEGRO */
::placeholder { color: #000000 !important; opacity: 1; }
input, select, textarea { color: #000000 !important; }

/* ENLACES DEL FOOTER EN NEGRO */
footer a { color: #000000 !important; text-decoration: none; }

/* ESPACIADO PARA EL TEXTAREA DE INFORMACIÓN ADICIONAL */
#comentariosECU {
  margin-top: 20px;
}

/* ===== ESTILOS PARA EL MODAL DE CATÁLOGO ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  overflow-y: auto;
}

.modal-content {
  background: var(--card-bg);
  padding: 30px;
  border-radius: 15px;
  max-width: 1000px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 15px;
}

.modal-title {
  margin: 0;
  font-size: 1.5rem;
  color: var(--text);
}

.close-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  padding: 5px;
  border-radius: 5px;
}

.close-btn:hover {
  background: rgba(255,255,255,0.1);
}

/* CATEGORÍAS CON LOGOS */
.categorias-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}

.categoria-btn {
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.1);
  padding: 25px 15px;
  border-radius: 12px;
  color: var(--text);
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.categoria-btn:hover {
  border-color: var(--electric-blue);
  transform: translateY(-3px);
}

.categoria-btn.active {
  border-color: var(--electric-blue);
  background: rgba(30, 144, 255, 0.1);
}

.logo-marca {
  width: 60px;
  height: 60px;
  object-fit: contain;
  filter: brightness(0) invert(1);
}

/* SUBCATEGORÍAS */
.subcategorias {
  display: none;
  margin: 20px 0;
  padding: 25px;
  background: rgba(255,255,255,0.02);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.05);
}

.subcategorias.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

.subcategoria-title {
  color: var(--muted);
  font-size: 1.3rem;
  margin-bottom: 20px;
  text-align: center;
}

.filtros {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 25px;
  justify-content: center;
}

.filtro-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  padding: 10px 20px;
  border-radius: 20px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.filtro-btn:hover, .filtro-btn.active {
  background: var(--electric-blue);
  border-color: var(--electric-blue);
}

/* ARCHIVOS */
.archivos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 25px;
}

.archivo-card {
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  transition: all 0.3s ease;
  text-align: left;
}

.archivo-card:hover {
  transform: translateY(-5px);
  border-color: var(--electric-blue);
  box-shadow: 0 10px 30px rgba(30, 144, 255, 0.2);
}

.archivo-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.archivo-title {
  margin: 0;
  font-size: 1.1rem;
  color: var(--text);
}

.archivo-precio {
  background: linear-gradient(135deg, var(--electric-blue), var(--purple));
  padding: 6px 14px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.95rem;
}

.archivo-info {
  color: var(--muted);
  margin: 8px 0;
  font-size: 0.9rem;
}

.archivo-features {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 15px 0;
}

.feature-tag {
  background: rgba(30, 144, 255, 0.15);
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 0.8rem;
  color: var(--electric-blue);
}

.add-to-cart-btn {
  background: linear-gradient(135deg, var(--electric-blue), #4aa0ff);
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: all 0.3s ease;
  font-family: inherit;
}

.add-to-cart-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(30, 144, 255, 0.4);
}

.add-to-cart-btn.added {
  background: var(--success);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden {
  display: none;
}

/* ===== SOLUCIÓN MEJORADA PARA SAFARI IPHONE ===== */
@media (max-width: 768px) {
    #reprogramacion .checkbox-group {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 6px !important;
        width: 100% !important;
        margin-top: 15px !important; /* SEPARACIÓN DEL LABEL SUPERIOR */
    }
    
    #reprogramacion .checkbox-group label {
        display: flex !important;
        align-items: center !important;
        font-size: 11px !important;
        padding: 4px 4px !important;
        background: rgba(255,255,255,0.05) !important;
        border-radius: 6px !important;
        margin: 0 !important;
        min-height: 32px !important;
        height: 32px !important;
        width: 100% !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    #reprogramacion .checkbox-group input[type="checkbox"] {
        -webkit-appearance: none !important;
        width: 14px !important;
        height: 14px !important;
        border: 2px solid #666 !important;
        border-radius: 3px !important;
        background: #e0e0e0 !important;
        margin-right: 6px !important;
        position: relative !important;
        flex-shrink: 0 !important;
    }
    
    #reprogramacion .checkbox-group input[type="checkbox"]:checked {
        background: #1E90FF !important;
        border-color: #1E90FF !important;
    }
    
    #reprogramacion .checkbox-group input[type="checkbox"]:checked::after {
        content: "✓" !important;
        position: absolute !important;
        color: white !important;
        font-size: 10px !important;
        font-weight: bold !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
    }
}

/* ===== AJUSTES ESPECÍFICOS PARA MÓVILES ===== */
@media (max-width: 980px) {
  input, select, textarea {
    font-size: 16px !important;
    padding: 14px !important;
    min-height: 50px !important;
  }
  
  ::placeholder {
    font-size: 16px !important;
  }
  
  input, select, textarea {
    font-size: 16px !important;
  }
  
  label {
    font-size: 16px !important;
    margin-bottom: 10px !important;
  }
  
  .cta, button {
    min-height: 50px !important;
    font-size: 16px !important;
  }
  
  .form-row {
    gap: 15px !important;
    margin-bottom: 15px !important;
  }
  
  .form-card {
    padding: 20px !important;
  }
  
  /* OCULTAR MENÚ FIJO EN MÓVIL Y MOSTRAR HAMBURGUESA NORMAL */
  .nav-links{
    display:none !important;
  }
  .hamburger{
    display:inline-block !important;
  }
  .side-menu{width:86%}
  
  /* Ajuste del logo en móviles */
  .brand .logo {
    width: 60px;
    height: 60px;
    margin-top: 0;
    margin-bottom: 0;
  }
}

@media (max-width: 980px) {
  .categorias-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .archivos-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 600px) {
  .categorias-grid {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    padding: 20px;
  }
  
  .modal-title {
    font-size: 1.3rem;
  }
  
  input, select, textarea {
    padding: 16px !important;
    min-height: 54px !important;
  }
  
  .cta, button {
    min-height: 54px !important;
    padding: 16px 20px !important;
  }
}

@media (max-width: 980px) {
  .imagenes-derecha {
    display: none;
  }
}

/* ESTILOS ESPECÍFICOS PARA MANTENER ELEMENTOS EN BLANCO */
#reservasH,
#reprogH {
  color: #ffffff !important;
}

/* ESTILOS PARA LA SECCIÓN DE CONTACTO (REVERTIR CAMBIOS) */
#contacto {
  color: #ffffff !important;
}

#contacto h2,
#contacto p,
#contacto label,
#contacto h4,
#contacto a,
#contacto div {
  color: #ffffff !important;
}

/* Los campos en la sección de contacto mantienen su estilo original */
#contacto input,
#contacto textarea {
  color: #000000 !important;
  background: #e0e0e0 !important; /* Cambiado para mantener consistencia */
}

#contacto ::placeholder {
  color: #000000 !important;
}

/* Botón de pagar en morado */
#btnPagar {
  background: linear-gradient(135deg, var(--purple), var(--accent)) !important;
}

/* Botón de limpiar en blanco con texto negro */
button[type="reset"] {
  background: white !important;
  color: #000000 !important;
  border: 0 !important;
  border-radius: 12px !important;
  padding: 12px 18px !important;
  font-weight: 700 !important;
  display: inline-block !important;
}

/* ===== CORRECCIONES ESPECÍFICAS PARA MÓVILES ===== */
@media (max-width: 768px) {
  /* REDUCIR DISTANCIA ENTRE CAMPOS DEL FORMULARIO */
  .form-row {
    gap: 8px !important;
    margin-bottom: 12px !important;
  }
  
  /* ESPECÍFICAMENTE PARA REDUCIR ESPACIO ENTRE NOMBRE COMPLETO Y TELÉFONO */
  #formReserva .form-row:nth-child(1),
  #formReprog .form-row:nth-child(1) {
    margin-bottom: 8px !important;
  }
  
  /* ESPECÍFICAMENTE PARA REDUCIR ESPACIO ENTRE EMAIL Y MARCA */
  #formReprog .form-row:nth-child(2) {
    margin-bottom: 8px !important;
  }
  
  /* MARCA Y MODELO EN FILA INDEPENDIENTE SIN CAMPOS A LA DERECHA */
  #formReserva .form-row:nth-child(3) {
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  
  #formReserva .form-row:nth-child(3) .col {
    width: 100% !important;
    margin-right: 0 !important;
  }
  
  /* ESPECÍFICAMENTE PARA EL CAMPO "MARCA Y MODELO" - OCUPA FILA COMPLETA */
  #formReserva .form-row:nth-child(3) .col:last-child {
    margin-top: 8px;
  }
  
  /* AUMENTAR ALTURA DEL CAMPO DE INFORMACIÓN ADICIONAL EN MÓVILES */
  #comentariosECU {
    min-height: 120px !important;
  }
  
  /* MANTENER LOS BOTONES MÁS PEQUEÑOS EN MÓVILES */
  .cta, button {
    padding: 10px 14px !important;
    font-size: 14px !important;
    min-height: 44px !important;
  }
}

/* ===== AJUSTES ESPECÍFICOS PARA MÓVILES ===== */
@media (max-width: 768px) {
  /* Campos de nombre y email en filas individuales */
  #formReserva .form-row:nth-child(1),
  #formReserva .form-row:nth-child(2),
  #formReprog .form-row:nth-child(1),
  #formReprog .form-row:nth-child(2) {
    flex-direction: column !important;
  }
  
  #formReserva .form-row:nth-child(1) .col:first-child,
  #formReserva .form-row:nth-child(2) .col:first-child,
  #formReprog .form-row:nth-child(1) .col:first-child,
  #formReprog .form-row:nth-child(2) .col:first-child {
    margin-bottom: 15px;
  }
  
  /* Botones más pequeños en móviles */
  .cta, button {
    padding: 10px 16px !important;
    font-size: 14px !important;
    min-height: 44px !important;
  }
  
  /* Ajustes específicos para los botones de envío */
  #reservas button.cta,
  #reprogramacion button.cta,
  #reservas button[type="reset"],
  #reprogramacion button[type="reset"] {
    padding: 10px 14px !important;
    font-size: 14px !important;
    min-height: 44px !important;
  }
}

/* ===== AJUSTE ESPECÍFICO PARA LÍMITE DE CORTE EN ESCRITORIO ===== */
@media (min-width: 981px) {
  .checkbox-group label:last-child input[type="checkbox"] {
    position: relative;
    right: 35px;
  }
}

/* ===== CORRECCIÓN MEJORADA PARA CHECKBOXES EN MÓVILES ===== */
@media (max-width: 768px) {
  /* UNIFICAR TAMAÑO DE TODOS LOS CHECKBOXES */
  #reprogramacion .checkbox-group label {
    min-height: 32px !important;
    height: 32px !important;
    display: flex !important;
    align-items: center !important;
    font-size: 11px !important;
    padding: 4px 4px !important;
    background: rgba(255,255,255,0.05) !important;
    border-radius: 6px !important;
    margin: 0 !important;
    width: 100% !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* ESPACIADO SUPERIOR PARA SEPARAR DEL LABEL */
  #reprogramacion .checkbox-group {
    margin-top: 15px !important;
  }
  
  /* GARANTIZAR QUE TODOS LOS CHECKBOXES TIENEN MISMO ESTILO */
  #reprogramacion .checkbox-group input[type="checkbox"] {
    -webkit-appearance: none !important;
    width: 14px !important;
    height: 14px !important;
    border: 2px solid #666 !important;
    border-radius: 3px !important;
    background: #e0e0e0 !important;
    margin-right: 6px !important;
    position: relative !important;
    flex-shrink: 0 !important;
  }
  
  #reprogramacion .checkbox-group input[type="checkbox"]:checked {
    background: #1E90FF !important;
    border-color: #1E90FF !important;
  }
  
  #reprogramacion .checkbox-group input[type="checkbox"]:checked::after {
    content: "✓" !important;
    position: absolute !important;
    color: white !important;
    font-size: 10px !important;
    font-weight: bold !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
  }
}
</style>
</head>
<body>
<nav aria-label="Navegación principal" class="nav" role="navigation">
<div class="nav-inner">
<div class="brand">
<!-- LOGO MÁS GRANDE - OCUPA TODO EL ENCABEZADO -->
<div class="logo">
  <img src="https://i.ibb.co/G3Qd3G1R/Cropped-Image.png" alt="ReproGarage Logo">
</div>
<div>
<h3 style="margin:0">ReproGarage.es</h3>
<div style="font-size:12px;color:var(--muted)">Tuning · Reprogramaciones · Servicios</div>
</div>
</div>
<!-- MENÚ FIJO CON ESTILO ORIGINAL -->
<div class="nav-links" role="menubar">
<a href="#productos" role="menuitem">Archivos ECU</a>
<a href="#carrito" role="menuitem" onclick="scrollToCarrito()">Carrito</a>
<a href="#reservas" role="menuitem">Reservar</a>
<a href="#reprogramacion" role="menuitem">Reprogramación</a>
<a href="#contacto" role="menuitem" onclick="scrollToContacto()">Contacto</a>
</div>
<button aria-controls="sideMenu" aria-expanded="false" aria-label="Abrir menú" class="hamburger" id="btnHamb">
<svg aria-hidden="true" fill="none" height="26" viewbox="0 0 24 24" width="26"><path d="M4 7h16M4 12h16M4 17h16" stroke="white" stroke-linecap="round" stroke-width="2"></path></svg>
</button>
</div>
</nav>

<aside aria-hidden="true" class="side-menu" id="sideMenu">
<button aria-label="Cerrar menú" class="side-close" id="btnClose">✕</button>
<h4>Menú</h4>
<a href="#productos" onclick="closeMenu()">Archivos ECU</a>
<a href="#carrito" onclick="closeMenu(); scrollToCarrito();">Carrito</a>
<a href="#reservas" onclick="closeMenu()">Reservar</a>
<a href="#reprogramacion" onclick="closeMenu()">Reprogramación</a>
<a href="#contacto" onclick="closeMenu(); scrollToContacto();">Contacto</a>
<div style="margin-top:auto;color:var(--muted);font-size:0.92rem">
<strong>Contacto</strong><br/>
    Iván - 644 777 079
  </div>
</aside>
<header class="main-header" role="banner">
<div class="hero-inner wrap">
<h1 class="hero-title">ReproGarage — Reprogramación ECU Profesional</h1>
<p class="hero-sub">Archivos Stage 1 y Stage 2 · Reprogramaciones a medida para particulares y talleres en España</p>
</div>
</header>
<main class="wrap" id="main">
<div aria-label="Catálogo y carrito" class="grid" role="region">
<section aria-labelledby="productosH" id="productos">
<h2 id="productosH">Archivos ECU Disponibles</h2>
<p style="color:var(--muted);margin-bottom:16px;">Selecciona el archivo que mejor se adapte a tu vehículo</p>
<div class="productos" role="list">
<article class="producto" role="listitem">
<!-- IMAGEN MEJORADA PARA STAGE 1 -->
<img alt="Stage 1 - optimización para uso diario" height="200" loading="lazy" src="https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 1 - Optimización diaria</h4>
<p style="color:var(--muted);font-size:0.95rem;">Mejora de respuesta y eficiencia, sin modificaciones hardware.</p>
<!-- COLOR DE FONDO CAMBIADO PARA QUE COINCIDA CON STAGE 2 -->
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            💡 Incluye ajuste de mapa motor y optimización de curva de par
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 1')" style="margin-top:auto;">Seleccionar archivo</button>
</article>
<article class="producto" role="listitem">
<!-- IMAGEN MEJORADA PARA STAGE 2 -->
<img alt="Stage 2 - optimización rendimiento" height="200" loading="lazy" src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Stage 2 - Performance</h4>
<p style="color:var(--muted);font-size:0.95rem;">Manejo avanzado del motor para vehículos con mejoras hardware.</p>
<div style="margin:12px 0;padding:10px;background:rgba(142,68,173,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            💡 Mapeo optimizado y calibraciones específicas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Stage 2')" style="margin-top:auto;">Seleccionar archivo</button>
</article>
<article class="producto" role="listitem">
<!-- IMAGEN MANTENIDA PARA PERSONALIZADO -->
<img alt="Personalizado - eliminaciones y optimizaciones avanzadas" height="200" loading="lazy" src="https://images.unsplash.com/photo-1563720223185-11003d516935?auto=format&amp;fit=crop&amp;w=800&amp;q=80&amp;dpr=2" width="300"/>
<h4>Personalizado - Eliminaciones Avanzadas</h4>
<p style="color:var(--muted);font-size:0.95rem;">Eliminación de EGR, AdBlue, DTCs, pops and bangs, límite de corte y más opciones.</p>
<div style="margin:12px 0;padding:10px;background:rgba(218,112,214,0.08);border-radius:8px;font-size:0.85rem;color:var(--muted);">
            💡 Incluye eliminaciones personalizadas y optimizaciones específicas
          </div>
<button aria-haspopup="dialog" class="cta" onclick="mostrarCatalogo('Personalizado')" style="margin-top:auto;">Seleccionar archivo</button>
</article>
</div>
</section>
<aside aria-label="Carrito y acciones">
<div aria-live="polite" class="panel" id="carrito">
<h3>Tu Carrito</h3>
<ul class="cart-list" id="cartList"></ul>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px"><strong>Total</strong><div id="cartTotal">€0</div></div>
<div style="margin-top:12px;display:flex;gap:10px;">
<button class="cta" id="btnPagar" onclick="procederPago()" style="flex:1">Pagar</button>
<button class="cta" id="btnVaciar" style="flex:1;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)">Vaciar</button>
</div>
</div>

<div class="texto-pagos">
  <div>Medios de pago seguros · Envío digital inmediato</div>
</div>

<div class="imagenes-derecha">
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=600&q=80" alt="Herramienta profesional para reprogramación ECU">
    <div class="imagen-contenido">
      <h4>KessV3 Professional</h4>
      <p>Equipo profesional KessV3 para lectura y escritura de ECU. Tecnología de última generación</p>
    </div>
  </div>
  
  <div class="imagen-derecha">
    <img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=600&q=80" alt="Análisis especializado de centralitas">
    <div class="imagen-contenido">
      <h4>Análisis Especializado</h4>
      <p>Técnicos cualificados creando mapas personalizados para máximo rendimiento</p>
    </div>
  </div>
</div>

</aside>
</div>

<section aria-labelledby="reservasH" id="reservas" style="margin-top:36px;">
<h2 id="reservasH">Reservar Servicio Presencial</h2>
<p style="color:var(--muted);margin-bottom:16px;">Agenda tu cita para reprogramación presencial</p>
<div class="form-card" style="max-width:900px;margin:0 auto">
<form id="formReserva" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreRes">Nombre completo</label><input id="nombreRes" maxlength="100" name="nombreRes" placeholder="Ej: Juan Pérez" required="" type="text"/></div>
<div class="col"><label for="telefonoRes">Teléfono</label><input id="telefonoRes" maxlength="15" name="telefonoRes" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailRes">Email</label><input id="emailRes" maxlength="254" name="emailRes" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="fechaRes">Fecha</label><input id="fechaRes" name="fechaRes" placeholder="Ej: ejemplo" required="" type="date"/></div>
</div>
<div class="form-row">
<div class="col"><label for="horaRes">Hora</label>
<select id="horaRes" name="horaRes">
  <option>08:00</option><option>09:00</option><option>10:00</option><option>11:00</option>
  <option>12:00</option><option>13:00</option><option>14:00</option><option>15:00</option>
  <option>16:00</option><option>17:00</option><option>18:00</option>
</select>
</div>
<div class="col"><label for="vehiculoRes">Marca y modelo</label><input id="vehiculoRes" maxlength="100" name="vehiculoRes" placeholder="Ej: BMW 320d 2019" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="localidadRes">Localidad del servicio</label><input id="localidadRes" maxlength="100" name="localidadRes" placeholder="Ej: Santander" required="" type="text"/></div></div>
<div class="form-row"><div class="col"><label for="dynoactiveRes">DynoActive (resultados de par y cv)</label><select id="dynoactiveRes" name="dynoactiveRes" required=""><option value="">Selecciona</option><option value="si">Sí</option><option value="no">No</option></select></div></div>
<label for="detallesRes">Detalles del vehículo y servicio</label>
<textarea id="detallesRes" maxlength="1000" name="detallesRes" placeholder="Ej: BMW 320d 2019, matrícula 1234ABC, Stage 1..." required="" style="color:var(--muted)"></textarea>
<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta" onclick="enviarReserva()" type="button">Enviar reserva</button><button type="reset">Limpiar</button></div>
<p aria-live="polite" id="mensajeRes" style="color:var(--muted);margin-top:10px"></p>
</form>
</div>
</section>
<section aria-labelledby="reprogH" id="reprogramacion" style="margin-top:36px;">
<h2 id="reprogH">Solicitud de Reprogramación</h2>
<p style="color:var(--muted);margin-bottom:16px;">Proporciona los datos del vehículo para una reprogramación a medida</p>
<div class="form-card" style="max-width:920px;margin:0 auto">
<form id="formReprog" novalidate="">
<div class="form-row">
<div class="col"><label for="nombreReprog">Nombre completo</label><input id="nombreReprog" maxlength="100" name="nombreReprog" placeholder="Ej: Juan Pérez" required="" type="text"/></div>
<div class="col"><label for="telefonoReprog">Teléfono</label><input id="telefonoReprog" maxlength="15" name="telefonoReprog" placeholder="Ej: 644 777 079" required="" type="tel"/></div>
</div>
<div class="form-row">
<div class="col"><label for="emailReprog">Email</label><input id="emailReprog" maxlength="254" name="emailReprog" placeholder="ejemplo@email.com" required="" type="email"/></div>
<div class="col"><label for="marcaCoche">Marca</label><input id="marcaCoche" maxlength="50" name="marcaCoche" placeholder="Ej: BMW, Audi" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="col"><label for="modeloCoche">Modelo</label><input id="modeloCoche" maxlength="50" name="modeloCoche" placeholder="Ej: 320d, A4" required="" type="text"/></div>
<div class="col"><label for="anioCoche">Año</label><input id="anioCoche" max="2099" min="1900" name="anioCoche" placeholder="Ej: 2019" required="" type="number"/></div>
</div>
<div class="form-row">
<div class="col"><label for="potenciaECU">Potencia (kW)</label><input id="potenciaECU" max="2000" min="1" name="potenciaECU" placeholder="Ej: 140" required="" type="number"/></div>
<div class="col"><label for="marcaECU">Marca de ECU</label><input id="marcaECU" maxlength="50" name="marcaECU" placeholder="Ej: Bosch" required="" type="text"/></div>
</div>
<div class="form-row"><div class="col"><label for="serieECU">Número de serie ECU</label><input id="serieECU" maxlength="50" name="serieECU" placeholder="Ej: EDC17C50" required="" type="text"/></div></div>
<label>Opciones de modificación</label>
<div aria-label="Opciones de modificación" class="checkbox-group" role="group">
  <label><input name="opciones" type="checkbox" value="Stage 1"/> Stage 1</label>
  <label><input name="opciones" type="checkbox" value="Stage 2"/> Stage 2</label>
  <label><input name="opciones" type="checkbox" value="EGR"/> EGR</label>
  <label><input name="opciones" type="checkbox" value="AdBlue"/> AdBlue</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DTCs"/> Eliminar DTCs</label>
  <label><input name="opciones" type="checkbox" value="Eliminar DPF"/> Eliminar DPF</label>
  <label><input name="opciones" type="checkbox" value="Inmo"/> Inmo</label>
  <label><input name="opciones" type="checkbox" value="Pops and bangs"/> Pops and bangs</label>
  <label><input name="opciones" type="checkbox" value="Límite de corte"/> Límite de corte</label>
</div>
<label for="comentariosECU">Información adicional</label>
<textarea id="comentariosECU" maxlength="2000" name="comentariosECU" placeholder="Ej: Modificaciones hechas al vehículo (downpipe, EGR anulada, escape 2.5 pulgadas, etc.)" style="color:var(--muted)"></textarea>

<!-- CAMPO PARA ADJUNTAR ARCHIVO BIN CON BOTÓN GRIS -->
<div class="file-input-container">
  <label for="archivoBin" class="file-input-label">Adjuntar archivo .bin (opcional)</label>
  <input type="file" id="archivoBin" name="archivoBin" class="file-input" accept=".bin" />
</div>

<div style="display:flex;gap:12px;margin-top:10px;"><button class="cta" onclick="enviarReprogramacion()" type="button">Enviar solicitud</button><button type="reset">Limpiar</button></div>
<p aria-live="polite" id="mensajeReprog" style="color:var(--muted);margin-top:10px"></p>
</form>
</div>
</section>
</main>
<footer id="contacto" style="padding:40px 20px;background:rgba(0,0,0,0.2);margin-top:60px;">
<div style="max-width:1140px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:30px;">
<div>
<h4 style="margin-bottom:8px">ReproGarage</h4>
<p style="color:var(--muted);font-size:0.9rem;line-height:1.6">Reprogramación ECU y servicios of tuning profesional. Equipos profesionales para lectura y escritura de centralitas (Kess3, ECM Titanium).</p>
</div>
<div>
<h4 style="margin-bottom:8px">Contacto</h4>
<p style="color:var(--muted);font-size:0.9rem">info@reprogarage.es<br/>Iván - 644 777 079<br/>Horario: Lun-Vie 08:00-19:00</p>
</div>
<div>
<h4 style="margin-bottom:8px">Enlaces</h4>
<div style="display:flex;flex-direction:column;gap:8px;color:var(--muted)"><a href="#productos">Archivos ECU</a><a href="#reservas">Reservar cita</a><a href="#reprogramacion">Reprogramación</a><a href="#contacto" onclick="scrollToContacto()">Contacto</a></div>
</div>
</div>
<div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:30px;padding-top:20px;text-align:center;color:var(--muted);font-size:0.85rem">© <span id="year">2025</span> ReproGarage.es</div>
</footer>
<a aria-label="Contactar por WhatsApp" href="https://wa.me/34644777079?text=Hola%20ReproGarage,%20quiero%20informaci%C3%B3n%20sobre%20reprogramaci%C3%B3n" id="whatsappCTA" rel="noopener noreferrer" target="_blank">💬</a>
<!-- BOTÓN VOLVER ARRIBA CON COLOR AZUL ELÉCTRICO -->
<button aria-label="Volver arriba" id="backToTop" title="Volver arriba">↑</button>

<!-- MODAL CATÁLOGO -->
<div id="catalogoModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitulo">📁 Catálogo de Archivos ECU</h2>
      <button class="close-btn" id="closeCatalogBtn">✕</button>
    </div>
    
    <p style="color: var(--muted); margin-bottom: 25px; text-align: center;">
      Selecciona la marca de tu vehículo para ver los archivos disponibles
    </p>
    
    <div class="categorias-grid" id="categoriasGrid">
    </div>
    
    <div class="subcategorias" id="subcategorias">
      <h3 class="subcategoria-title" id="subcategoriaTitle">Selecciona un modelo</h3>
      <div class="filtros" id="filtros">
      </div>
      <div class="archivos-grid" id="archivosGrid">
      </div>
    </div>
  </div>
</div>

<!-- SCRIPT DE EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
// Inicializar EmailJS
(function() {
  emailjs.init("T_fWrGlGp-KQ-AyHb");
})();

// ============================
// 🏎️ SISTEMA DE CATÁLOGO OPTIMIZADO
// ============================

// Datos del catálogo optimizados
const catalogo = {
  marcas: [
    {
      id: 'audi',
      nombre: 'Audi',
      logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/92/Audi-Logo_2016.svg/300px-Audi-Logo_2016.svg.png',
      modelos: [
        {
          id: 'a3',
          nombre: 'A3',
          años: ['2012-2016', '2017-2020'],
          archivos: [
            { id: 'audi-a3-20tdi-stage1', nombre: 'A3 2.0 TDI Stage 1', potencia: '+25 CV', par: '+50 Nm', precio: 199, compatibilidad: '2015-2020' },
            { id: 'audi-a3-20tdi-stage2', nombre: 'A3 2.0 TDI Stage 2', potencia: '+40 CV', par: '+80 Nm', precio: 249, compatibilidad: '2015-2020' }
          ]
        },
        {
          id: 'a4',
          nombre: 'A4',
          años: ['2015-2019', '2020-2023'],
          archivos: [
            { id: 'audi-a4-20t-stage1', nombre: 'A4 2.0 TFSI Stage 1', potencia: '+45 HP', par: '+65 Nm', precio: 219, compatibilidad: '2015-2019' },
            { id: 'audi-a4-30t-stage1', nombre: 'A4 3.0 TFSI Stage 1', potencia: '+50 HP', par: '+70 Nm', precio: 249, compatibilidad: '2020-2023' }
          ]
        }
      ]
    },
    {
      id: 'bmw',
      nombre: 'BMW',
      logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/300px-BMW.svg.png',
      modelos: [
        {
          id: 'serie3',
          nombre: 'Serie 3',
          años: ['2012-2015', '2016-2018', '2019-2022'],
          archivos: [
            { id: 'bmw-320d-stage1', nombre: '320d Stage 1', potencia: '+35 HP', par: '+70 Nm', precio: 189, compatibilidad: '2012-2015' },
            { id: 'bmw-330i-stage1', nombre: '330i Stage 1', potencia: '+40 HP', par: '+50 Nm', precio: 209, compatibilidad: '2016-2018' }
          ]
        },
        {
          id: 'serie5',
          nombre: 'Serie 5',
          años: ['2010-2016', '2017-2023'],
          archivos: [
            { id: 'bmw-520d-stage1', nombre: '520d Stage 1', potencia: '+40 HP', par: '+75 Nm', precio: 199, compatibilidad: '2010-2016' },
            { id: 'bmw-530d-stage2', nombre: '530d Stage 2', potencia: '+70 HP', par: '+100 Nm', precio: 329, compatibilidad: '2017-2023' }
          ]
        }
      ]
    },
    {
      id: 'mercedes',
      nombre: 'Mercedes-Benz',
      logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/Mercedes-Logo.svg/300px-Mercedes-Logo.svg.png',
      modelos: [
        {
          id: 'clasea',
          nombre: 'Clase A',
          años: ['2012-2018', '2019-2023'],
          archivos: [
            { id: 'mercedes-a200-stage1', nombre: 'A200 Stage 1', potencia: '+30 HP', par: '+45 Nm', precio: 179, compatibilidad: '2012-2018' },
            { id: 'mercedes-a35-stage1', nombre: 'A35 AMG Stage 1', potencia: '+50 HP', par: '+70 Nm', precio: 299, compatibilidad: '2019-2023' }
          ]
        },
        {
          id: 'clasec',
          nombre: 'Clase C',
          años: ['2014-2021', '2022-2023'],
          archivos: [
            { id: 'mercedes-c220d-stage1', nombre: 'C220d Stage 1', potencia: '+35 HP', par: '+65 Nm', precio: 199, compatibilidad: '2014-2021' },
            { id: 'mercedes-c63-stage1', nombre: 'C63 AMG Stage 1', potencia: '+60 HP', par: '+80 Nm', precio: 349, compatibilidad: '2022-2023' }
          ]
        }
      ]
    },
    {
      id: 'volkswagen',
      nombre: 'Volkswagen',
      logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Volkswagen_logo_2019.svg/300px-Volkswagen_logo_2019.svg.png',
      modelos: [
        {
          id: 'golf',
          nombre: 'Golf',
          años: ['2009-2012', '2013-2017', '2018-2020', '2021-2023'],
          archivos: [
            { id: 'vw-golf-20tdi-stage1', nombre: 'Golf 2.0 TDI Stage 1', potencia: '+40 HP', par: '+75 Nm', precio: 179, compatibilidad: '2009-2012' },
            { id: 'vw-golf-gti-stage1', nombre: 'Golf GTI Stage 1', potencia: '+45 HP', par: '+60 Nm', precio: 219, compatibilidad: '2013-2017' }
          ]
        },
        {
          id: 'passat',
          nombre: 'Passat',
          años: ['2011-2014', '2015-2019', '2020-2023'],
          archivos: [
            { id: 'vw-passat-20tdi-stage1', nombre: 'Passat 2.0 TDI Stage 1', potencia: '+35 HP', par: '+70 Nm', precio: 189, compatibilidad: '2011-2014' },
            { id: 'vw-passat-20tsi-stage1', nombre: 'Passat 2.0 TSI Stage 1', potencia: '+40 HP', par: '+55 Nm', precio: 209, compatibilidad: '2015-2019' }
          ]
        }
      ]
    }
  ]
};

// Estado de la aplicación
let estado = {
  carrito: [],
  tipoStage: '',
  marcaSeleccionada: null,
  modeloSeleccionado: null,
  filtroAnio: null
};

// FUNCIONES DEL CATÁLOGO
function mostrarCatalogo(tipoStage) {
  estado.tipoStage = tipoStage;
  document.getElementById('modalTitulo').textContent = `📁 Catálogo de Archivos ECU - ${tipoStage}`;
  document.getElementById('catalogoModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  cargarCategorias();
}

function cerrarCatalogo() {
  document.getElementById('catalogoModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function cargarCategorias() {
  const categoriasGrid = document.getElementById('categoriasGrid');
  categoriasGrid.innerHTML = '';
  
  catalogo.marcas.forEach(marca => {
    const botonCategoria = document.createElement('button');
    botonCategoria.className = 'categoria-btn';
    botonCategoria.innerHTML = `
      <img src="${marca.logo}" alt="${marca.nombre}" class="logo-marca">
      <span>${marca.nombre}</span>
    `;
    
    botonCategoria.addEventListener('click', () => seleccionarMarca(marca));
    categoriasGrid.appendChild(botonCategoria);
  });
}

function seleccionarMarca(marca) {
  estado.marcaSeleccionada = marca;
  estado.modeloSeleccionado = null;
  estado.filtroAnio = null;
  
  document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  const subcategorias = document.getElementById('subcategorias');
  subcategorias.classList.add('active');
  document.getElementById('subcategoriaTitle').textContent = `Modelos ${marca.nombre} - ${estado.tipoStage}`;
  
  cargarModelos(marca);
}

function cargarModelos(marca) {
  const filtros = document.getElementById('filtros');
  const archivosGrid = document.getElementById('archivosGrid');
  
  filtros.innerHTML = '';
  archivosGrid.innerHTML = '';
  
  marca.modelos.forEach(modelo => {
    const botonModelo = document.createElement('button');
    botonModelo.className = 'filtro-btn';
    botonModelo.textContent = modelo.nombre;
    botonModelo.addEventListener('click', () => seleccionarModelo(modelo));
    filtros.appendChild(botonModelo);
  });
}

function seleccionarModelo(modelo) {
  estado.modeloSeleccionado = modelo;
  
  document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  cargarFiltrosAnio(modelo);
}

function cargarFiltrosAnio(modelo) {
  const filtros = document.getElementById('filtros');
  
  const botonesModelo = Array.from(filtros.querySelectorAll('.filtro-btn'));
  
  modelo.años.forEach(anio => {
    const botonAnio = document.createElement('button');
    botonAnio.className = 'filtro-btn';
    botonAnio.textContent = anio;
    botonAnio.addEventListener('click', () => filtrarPorAnio(anio));
    filtros.appendChild(botonAnio);
  });
  
  cargarArchivos(modelo);
}

function filtrarPorAnio(anio) {
  estado.filtroAnio = anio;
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    if (btn.textContent === anio) {
      btn.classList.add('active');
    } else if (estado.modeloSeleccionado.años.includes(btn.textContent)) {
      btn.classList.remove('active');
    }
  });
  
  cargarArchivos(estado.modeloSeleccionado, anio);
}

function cargarArchivos(modelo, anioFiltro = null) {
  const archivosGrid = document.getElementById('archivosGrid');
  archivosGrid.innerHTML = '';
  
  const archivosFiltrados = anioFiltro 
    ? modelo.archivos.filter(archivo => archivo.compatibilidad === anioFiltro)
    : modelo.archivos;
  
  if (archivosFiltrados.length === 0) {
    archivosGrid.innerHTML = '<p style="text-align:center;color:var(--muted);grid-column:1/-1;">No hay archivos disponibles para este filtro</p>';
    return;
  }
  
  archivosFiltrados.forEach(archivo => {
    const archivoCard = document.createElement('div');
    archivoCard.className = 'archivo-card';
    archivoCard.innerHTML = `
      <div class="archivo-header">
        <h4 class="archivo-title">${archivo.nombre}</h4>
        <div class="archivo-precio">${archivo.precio}€</div>
      </div>
      <div class="archivo-info">
        <div><strong>Compatibilidad:</strong> ${archivo.compatibilidad}</div>
        <div><strong>Potencia:</strong> ${archivo.potencia}</div>
        <div><strong>Par motor:</strong> ${archivo.par}</div>
      </div>
      <div class="archivo-features">
        <span class="feature-tag">Garantía 30 días</span>
        <span class="feature-tag">Soporte técnico</span>
        <span class="feature-tag">Descarga inmediata</span>
      </div>
      <button class="add-to-cart-btn" data-id="${archivo.id}" data-name="${archivo.nombre}" data-price="${archivo.precio}">
        Añadir al Carrito
      </button>
    `;
    
  archivosGrid.appendChild(archivoCard);
  });
  
  document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const nombre = this.getAttribute('data-name');
      const precio = parseFloat(this.getAttribute('data-price'));
      
      agregarAlCarrito({ id, nombre, precio });
      
      cerrarCatalogo();
      scrollToCarrito();
      
      mostrarNotificacion(`${nombre} añadido al carrito`);
    });
  });
}

// ============================
// 🛒 SISTEMA DE CARRITO MEJORADO
// ============================

function agregarAlCarrito(producto) {
  const productoExistente = estado.carrito.find(item => item.id === producto.id);
  
  if (productoExistente) {
    productoExistente.cantidad += 1;
  } else {
    estado.carrito.push({
      ...producto,
      cantidad: 1
    });
  }
  
  guardarCarrito();
  actualizarCarrito();
}

function eliminarDelCarrito(id) {
  estado.carrito = estado.carrito.filter(item => item.id !== id);
  guardarCarrito();
  actualizarCarrito();
}

function vaciarCarrito() {
  if (estado.carrito.length === 0) {
    mostrarNotificacion('El carrito ya está vacío', 'info');
    return;
  }
  
  if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
    estado.carrito = [];
    localStorage.removeItem('reprogarage-carrito');
    guardarCarrito();
    actualizarCarrito();
    mostrarNotificacion('Carrito vaciado correctamente');
  }
}

function actualizarCarrito() {
  const container = document.getElementById('cartList');
  const totalElement = document.getElementById('cartTotal');
  const checkoutBtn = document.getElementById('btnPagar');
  
  if (estado.carrito.length === 0) {
    container.innerHTML = '<li style="text-align:center;color:var(--muted);">Carrito vacío</li>';
    totalElement.textContent = '€0';
    checkoutBtn.disabled = true;
    return;
  }
  
  let html = '';
  let total = 0;
  
  estado.carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    total += subtotal;
    
    html += `
      <li style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03);">
        <span>${item.nombre} x${item.cantidad}</span>
        <span>${subtotal}€</span>
      </li>
    `;
  });
  
  container.innerHTML = html;
  totalElement.textContent = `€${total.toFixed(2)}`;
  checkoutBtn.disabled = false;
}

function guardarCarrito() {
  localStorage.setItem('reprogarage-carrito', JSON.stringify(estado.carrito));
}

function cargarCarrito() {
  const carritoGuardado = localStorage.getItem('reprogarage-carrito');
  if (carritoGuardado) {
    estado.carrito = JSON.parse(carritoGuardado);
  }
  actualizarCarrito();
}

function procederPago() {
  if (estado.carrito.length === 0) return;
  
  mostrarNotificacion('Redirigiendo a pasarela de pago...');
  
  setTimeout(() => {
    procesarPedidoExitoso();
  }, 2000);
}

function procesarPedidoExitoso() {
  const archivosPedido = generarArchivosPedido();
  
  enviarEmailConfirmacion(archivosPedido);
  
  mostrarConfirmacionPedido(archivosPedido);
  
  estado.carrito = [];
  guardarCarrito();
  actualizarCarrito();
}

function generarArchivosPedido() {
  const archivos = [];
  
  estado.carrito.forEach(item => {
    archivos.push({
      nombre: `${item.id}.bin`,
      url: `#`,
      tamaño: '2.4 MB',
      producto: item.nombre
    });
  });
  
  return archivos;
}

function enviarEmailConfirmacion(archivos) {
  console.log('Email de confirmación enviado con archivos:', archivos);
  mostrarNotificacion('Email de confirmación enviado con los archivos adjuntos');
}

function mostrarConfirmacionPedido(archivos) {
  alert('¡Pedido completado! Revisa tu email para descargar los archivos.');
}

// ============================
// 🔧 FUNCIONES GENERALES MEJORADAS
// ============================

function mostrarNotificacion(mensaje, tipo = 'success') {
  const notificacion = document.createElement('div');
  notificacion.className = `notificacion ${tipo === 'error' ? 'error' : tipo === 'info' ? 'info' : 'success'}`;
  notificacion.textContent = mensaje;
  
  let backgroundColor = '#4CAF50';
  if (tipo === 'error') {
    backgroundColor = '#f44336';
  } else if (tipo === 'info') {
    backgroundColor = '#2196F3';
  }
  
  notificacion.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: ${backgroundColor};
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    max-width: 300px;
    animation: slideInRight 0.3s ease;
  `;
  
  document.body.appendChild(notificacion);
  
  setTimeout(() => {
    notificacion.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => {
      if (document.body.contains(notificacion)) {
        document.body.removeChild(notificacion);
      }
    }, 300);
  }, 3000);
}

function scrollToCarrito() {
  setTimeout(() => {
    const carritoElement = document.getElementById('carrito');
    const carritoPosition = carritoElement.getBoundingClientRect().top + window.pageYOffset;
    
    const offset = window.innerHeight * 0.1;
    const targetPosition = carritoPosition - offset;
    
    window.scrollTo({
      top: targetPosition,
      behavior: 'smooth'
    });
  }, 50);
}

function scrollToContacto() {
  setTimeout(() => {
    const contactoElement = document.getElementById('contacto');
    const contactoPosition = contactoElement.getBoundingClientRect().top + window.pageYOffset;
    
    const offset = window.innerHeight * 0.1;
    const targetPosition = contactoPosition - offset;
    
    window.scrollTo({
      top: targetPosition,
      behavior: 'smooth'
    });
  }, 50);
}

// ============================
// 📧 FUNCIONES DE VALIDACIÓN MEJORADAS
// ============================

// Funciones auxiliares de validación
function validarEmail(email) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

function validarTelefono(telefono) {
  const regex = /^[0-9\s\+\-\(\)]{9,}$/;
  return regex.test(telefono);
}

// ============================
// 📧 INTEGRACIÓN CON EMAILJS
// ============================

function enviarReserva() {
  const form = document.getElementById('formReserva');
  const mensaje = document.getElementById('mensajeRes');
  const campos = form.querySelectorAll('input[required], select[required], textarea[required]');
  
  // Resetear estilos de error anteriores
  campos.forEach(campo => {
    campo.style.border = '';
    campo.style.backgroundColor = '';
  });
  
  let camposInvalidos = [];
  let mensajeError = '';

  // Validar cada campo individualmente
  campos.forEach(campo => {
    const valor = campo.value.trim();
    let nombreCampo = '';
    
    // Obtener el nombre del campo desde la etiqueta label anterior
    if (campo.previousElementSibling && campo.previousElementSibling.tagName === 'LABEL') {
      nombreCampo = campo.previousElementSibling.textContent.replace('*', '').trim();
    } else {
      nombreCampo = campo.getAttribute('name') || 'Campo';
    }
    
    if (!valor) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> está vacío<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.type === 'email' && !validarEmail(valor)) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> tiene un formato de email inválido<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.name === 'telefonoRes' && !validarTelefono(valor)) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> debe contener solo números y símbolos válidos (+, -, (, ), espacio)<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.type === 'date' && isNaN(new Date(valor).getTime())) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> tiene una fecha inválida<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    }
  });

  // Si hay campos inválidos, mostrar errores específicos
  if (camposInvalidos.length > 0) {
    mensaje.innerHTML = `<div style="text-align: left;">
      <strong style="color: #ff6b6b;">❌ Errores encontrados:</strong><br><br>
      ${mensajeError}
    </div>`;
    mensaje.style.color = '#ff6b6b';
    
    // Hacer scroll al primer campo con error
    setTimeout(() => {
      camposInvalidos[0].scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      camposInvalidos[0].focus();
    }, 100);
    
    return;
  }

  // Si todo está correcto, proceder con el envío
  const btn = event.target;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Enviando...';
  btn.style.opacity = '0.7';
  
  // Recoger datos del formulario
  const formData = new FormData(form);
  const datos = Object.fromEntries(formData);
  
  // Enviar con EmailJS
  emailjs.send('service_y6d8z8h', 'template_p0yer4p', datos)
    .then(function(response) {
      console.log('SUCCESS!', response.status, response.text);
      mensaje.innerHTML = '✅ <strong>Reserva enviada correctamente.</strong> Te contactaremos pronto.';
      mensaje.style.color = '#4CAF50';
      form.reset();
    }, function(error) {
      console.log('FAILED...', error);
      mensaje.innerHTML = '❌ <strong>Error al enviar la reserva.</strong> Por favor, inténtalo de nuevo.';
      mensaje.style.color = '#ff6b6b';
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = originalText;
      btn.style.opacity = '1';
    });
}

function enviarReprogramacion() {
  const form = document.getElementById('formReprog');
  const mensaje = document.getElementById('mensajeReprog');
  const campos = form.querySelectorAll('input[required], select[required], textarea[required]');
  
  // Resetear estilos de error anteriores
  campos.forEach(campo => {
    campo.style.border = '';
    campo.style.backgroundColor = '';
  });
  
  let camposInvalidos = [];
  let mensajeError = '';

  // Validar cada campo individualmente
  campos.forEach(campo => {
    const valor = campo.value.trim();
    let nombreCampo = '';
    
    // Obtener el nombre del campo desde la etiqueta label anterior
    if (campo.previousElementSibling && campo.previousElementSibling.tagName === 'LABEL') {
      nombreCampo = campo.previousElementSibling.textContent.replace('*', '').trim();
    } else {
      nombreCampo = campo.getAttribute('name') || 'Campo';
    }
    
    if (!valor) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> está vacío<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.type === 'email' && !validarEmail(valor)) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> tiene un formato de email inválido<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.name === 'telefonoReprog' && !validarTelefono(valor)) {
      camposInvalidos.push(campo);
      mensajeError += `• <strong>${nombreCampo}</strong> debe contener solo números y símbolos válidos (+, -, (, ), espacio)<br>`;
      campo.style.border = '2px solid #ff6b6b';
      campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
    } else if (campo.type === 'number') {
      const num = parseInt(valor);
      if (isNaN(num)) {
        camposInvalidos.push(campo);
        mensajeError += `• <strong>${nombreCampo}</strong> debe ser un número válido<br>`;
        campo.style.border = '2px solid #ff6b6b';
        campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
      } else if (campo.name === 'anioCoche' && (num < 1900 || num > 2099)) {
        camposInvalidos.push(campo);
        mensajeError += `• <strong>${nombreCampo}</strong> debe estar entre 1900 y 2099<br>`;
        campo.style.border = '2px solid #ff6b6b';
        campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
      } else if (campo.name === 'potenciaECU' && (num < 1 || num > 2000)) {
        camposInvalidos.push(campo);
        mensajeError += `• <strong>${nombreCampo}</strong> debe estar entre 1 y 2000 kW<br>`;
        campo.style.border = '2px solid #ff6b6b';
        campo.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
      }
    }
  });

  // Si hay campos inválidos, mostrar errores específicos
  if (camposInvalidos.length > 0) {
    mensaje.innerHTML = `<div style="text-align: left;">
      <strong style="color: #ff6b6b;">❌ Errores encontrados:</strong><br><br>
      ${mensajeError}
    </div>`;
    mensaje.style.color = '#ff6b6b';
    
    // Hacer scroll al primer campo con error
    setTimeout(() => {
      camposInvalidos[0].scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      camposInvalidos[0].focus();
    }, 100);
    
    return;
  }

  // Si todo está correcto, proceder con el envío
  const btn = event.target;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Enviando...';
  btn.style.opacity = '0.7';
  
  // Recoger datos del formulario
  const formData = new FormData(form);
  const datos = Object.fromEntries(formData);
  
  // Procesar checkboxes seleccionados
  const opcionesCheckboxes = form.querySelectorAll('input[name="opciones"]:checked');
  const opcionesSeleccionadas = Array.from(opcionesCheckboxes).map(cb => cb.value).join(', ');
  datos.opciones = opcionesSeleccionadas;
  
  // Procesar archivo adjunto si existe
  const archivoInput = document.getElementById('archivoBin');
  if (archivoInput.files.length > 0) {
    datos.archivoAdjunto = archivoInput.files[0].name;
    
    // Enviar el archivo adjunto
    emailjs.send('service_y6d8z8h', 'template_s7gwwvt', datos, {
      'attachment': archivoInput.files[0]
    })
    .then(function(response) {
      console.log('SUCCESS!', response.status, response.text);
      mensaje.innerHTML = '✅ <strong>Solicitud enviada correctamente.</strong> Te contactaremos pronto.';
      mensaje.style.color = '#4CAF50';
      form.reset();
    }, function(error) {
      console.log('FAILED...', error);
      mensaje.innerHTML = '❌ <strong>Error al enviar la solicitud.</strong> Por favor, inténtalo de nuevo.';
      mensaje.style.color = '#ff6b6b';
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = originalText;
      btn.style.opacity = '1';
    });
  } else {
    // Enviar sin archivo adjunto
    emailjs.send('service_y6d8z8h', 'template_s7gwwvt', datos)
    .then(function(response) {
      console.log('SUCCESS!', response.status, response.text);
      mensaje.innerHTML = '✅ <strong>Solicitud enviada correctamente.</strong> Te contactaremos pronto.';
      mensaje.style.color = '#4CAF50';
      form.reset();
    }, function(error) {
      console.log('FAILED...', error);
      mensaje.innerHTML = '❌ <strong>Error al enviar la solicitud.</strong> Por favor, inténtalo de nuevo.';
      mensaje.style.color = '#ff6b6b';
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = originalText;
      btn.style.opacity = '1';
    });
  }
}

// ============================
// 🚀 INICIALIZACIÓN
// ============================

document.addEventListener('DOMContentLoaded', function(){
  const yearEl = document.getElementById('year'); if(yearEl) yearEl.textContent = new Date().getFullYear();

  const btnHamb = document.getElementById('btnHamb'); const sideMenu = document.getElementById('sideMenu'); const btnClose = document.getElementById('btnClose');
  function openMenu(){ sideMenu.classList.add('open'); sideMenu.setAttribute('aria-hidden','false'); btnHamb.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; }
  function closeMenu(){ sideMenu.classList.remove('open'); sideMenu.setAttribute('aria-hidden','true'); btnHamb.setAttribute('aria-expanded','false'); document.body.style.overflow='auto'; }
  window.closeMenu = closeMenu; if(btnHamb){btnHamb.addEventListener('click', openMenu);} if(btnClose){btnClose.addEventListener('click', closeMenu);} 

  const backBtn = document.getElementById('backToTop'); window.addEventListener('scroll', function(){ if(window.scrollY>400){ backBtn.style.display='flex'; } else { backBtn.style.display='none'; } }); backBtn.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

  document.getElementById('closeCatalogBtn').addEventListener('click', cerrarCatalogo);
  
  document.getElementById('catalogoModal').addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarCatalogo();
    }
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      cerrarCatalogo();
    }
  });

  document.getElementById('btnVaciar').addEventListener('click', vaciarCarrito);

  cargarCarrito();

  const formReserva = document.getElementById('formReserva'); if(formReserva){ formReserva.addEventListener('submit', function(e){ e.preventDefault(); }); }
  const formReprog = document.getElementById('formReprog'); if(formReprog){ formReprog.addEventListener('submit', function(e){ e.preventDefault(); }); }
});

const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);
</script>

<!-- INI: PATCH - mejoras y correcciones no intrusivas -->
<script>
(function(){
  'use strict';
  // Inicializar EmailJS solo si existe y no está inicializado
  try{
    if(window.emailjs && !window.__emailjs_initialized){
      emailjs.init && emailjs.init('T_fWrGlGp-KQ-AyHb');
      window.__emailjs_initialized = true;
    }
  }catch(e){ console.warn('EmailJS init error', e); }

  // Helper seguro para añadir listeners si el elemento existe
  function safeAdd(el, event, fn){ if(!el) return; el.addEventListener(event, fn); }

  // Side menu (hamburger)
  var hamb = document.getElementById('btnHamb');
  var side = document.getElementById('sideMenu');
  var closeBtn = document.getElementById('btnClose');
  if(hamb && side){
    safeAdd(hamb, 'click', function(e){
      side.classList.add('open');
      hamb.setAttribute('aria-expanded','true');
      side.setAttribute('aria-hidden','false');
    });
  }
  if(closeBtn && side){
    safeAdd(closeBtn, 'click', function(){ side.classList.remove('open'); if(hamb) hamb.setAttribute('aria-expanded','false'); side.setAttribute('aria-hidden','true'); });
  }

  // Modal catálogo: cerrar con ESC y clic fuera (no sustituye al original si ya existe)
  var catalogoModal = document.getElementById('catalogoModal');
  if(catalogoModal){
    safeAdd(catalogoModal, 'click', function(e){
      if(e.target === catalogoModal){
        catalogoModal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    });
    safeAdd(document, 'keydown', function(e){
      if(e.key === 'Escape'){
        if(catalogoModal.style.display === 'flex' || catalogoModal.style.display === 'block'){
          catalogoModal.style.display = 'none'; document.body.style.overflow = 'auto';
        }
        // cerrar side menu si abierto
        if(side && side.classList.contains('open')){ side.classList.remove('open'); if(hamb) hamb.setAttribute('aria-expanded','false'); }
      }
    });
  }

  // Back to top visibility and behavior
  var back = document.getElementById('backToTop');
  if(back){
    back.style.display = (window.scrollY>300)?'flex':'none';
    safeAdd(window,'scroll', function(){ back.style.display=(window.scrollY>300)?'flex':'none'; });
    safeAdd(back,'click', function(){ window.scrollTo({top:0,behavior:'smooth'}); });
  }

  // Garantizar que funciones que usaban "event" global reciban event si es necesario:
  // Reenvía handlers de elementos con data-handler="passEvent:functionName" para que llamen con event
  document.querySelectorAll('[data-handler]').forEach(function(el){
    try{
      var info = el.getAttribute('data-handler'); // formato: functionName
      if(!info) return;
      var fnName = info.trim();
      // sólo si el elemento ya tiene onclick inline que utiliza event no definido, reemplazamos
      // por un listener seguro que pasa el event
      var inline = el.getAttribute('onclick');
      if(inline && inline.indexOf('event')!==-1){
        el.removeAttribute('onclick');
        el.addEventListener('click', function(ev){
          var fn = window[fnName];
          if(typeof fn === 'function') fn(ev);
        });
      }
    }catch(e){ /* silent */ }
  });

  // LocalStorage: si existe carrito guardado, intentar restaurarlo y llamar a actualizarCarrito si existe
  try{
    var saved = localStorage.getItem('reprogarage-carrito');
    if(saved){
      window.__reprogarage_carrito_restored = JSON.parse(saved);
      if(typeof actualizarCarrito === 'function'){
        actualizarCarrito();
      }
    }
  }catch(e){ console.warn('Error restaurando carrito', e); }

  // Añadir aria-hidden a elementos modales no visibles por defecto
  if(side && !side.hasAttribute('aria-hidden')) side.setAttribute('aria-hidden','true');
  if(catalogoModal && !catalogoModal.hasAttribute('aria-hidden')) catalogoModal.setAttribute('aria-hidden','true');

  // Protecciones para enviarReserva / enviarReprogramacion: envolver si existen y no aceptan event
  ['enviarReserva','enviarReprogramacion'].forEach(function(name){
    var orig = window[name];
    if(typeof orig === 'function'){
      // Redefinir amablemente para aceptar event y pasar al original
      window[name] = function(e){
        try{
          return orig.call(this, e || window.event);
        }catch(err){
          console.error('Error en '+name, err);
          return false;
        }
      };
    }
  });

  // Evitar errores si hay botones que llaman a funciones no definidas: añadir stubs que informan por consola
  var stubNames = ['vaciarCarrito','actualizarCarrito','agregarAlCarrito','cargarCategorias','cargarModelos','cargarFiltrosAnio','cargarArchivos'];
  stubNames.forEach(function(n){
    if(typeof window[n] !== 'function'){
      window[n] = function(){ console.info('Función stub llamada: '+n); };
    }
  });

  // Mostrar año actual en elemento con id 'year'
  var y = document.getElementById('year');
  if(y) y.textContent = new Date().getFullYear();

})(); // fin IIFE
</script>
<!-- FIN: PATCH -->


<!-- INI: FULL-FEATURE JS - reemplazo/implementación robusta de funcionalidades clave -->
<script>
(function(){
  'use strict';
  // Estado de la app
  window.RG = window.RG || {};
  const state = window.RG.state = {
    carrito: [],
    catalogo: window.catalogo || null, // si el HTML original define catalogo, se usa
    tipoStage: '',
    marcaSeleccionada: null,
    modeloSeleccionado: null,
  };

  // Helpers
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from((ctx||document).querySelectorAll(sel));

  function saveCarrito(){
    try{ localStorage.setItem('reprogarage-carrito', JSON.stringify(state.carrito)); }catch(e){ console.warn('No se pudo guardar carrito', e); }
  }
  function loadCarrito(){
    try{ const s = localStorage.getItem('reprogarage-carrito'); if(s) state.carrito = JSON.parse(s); }catch(e){ console.warn('No se pudo leer carrito', e); }
  }

  // Mostrar carrito en DOM: busca elementos conocidos y los actualiza
  function actualizarCarrito(){
    saveCarrito();
    // Intentar varios selectores por compatibilidad
    const targets = [
      '#carritoItems', '#carrito-list', '#carrito .items', '#carrito'
    ];
    let updated = false;
    for(const sel of targets){
      const el = document.querySelector(sel);
      if(!el) continue;
      el.innerHTML = '';
      if(state.carrito.length === 0){
        el.innerHTML = '<div class="carrito-vacio">Tu carrito está vacío.</div>';
      } else {
        state.carrito.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'carrito-item';
          row.innerHTML = `<div class="ci-left"><strong>${escapeHtml(it.nombre||it.title||'Producto')}</strong><div class="muted">${escapeHtml(it.descripcion||'')}</div></div>
            <div class="ci-right"><span class="precio">${escapeHtml(it.precio||'0€')}</span> <button class="btn-eliminar" data-idx="${idx}" aria-label="Eliminar item ${idx}">Eliminar</button></div>`;
          el.appendChild(row);
        });
        const vaciar = document.createElement('button');
        vaciar.id = 'btnVaciar';
        vaciar.className = 'btn vaciar';
        vaciar.textContent = 'Vaciar carrito';
        vaciar.addEventListener('click', vaciarCarrito);
        el.appendChild(vaciar);
      }
      updated = true;
    }
    // contador pequeño: actualizar elementos con data-carrito-count
    $$('[data-carrito-count]').forEach(el => el.textContent = state.carrito.length);
    if(!updated){
      // fallback: consola
      console.info('Carrito actualizado (no encontrado contenedor visible). Items:', state.carrito.length);
    }
  }

  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // Agregar objeto al carrito. item puede ser objeto o id (buscar en catalogo)
  function agregarAlCarrito(item){
    let it = null;
    if(typeof item === 'string' || typeof item === 'number'){
      // buscar en catalogo
      if(state.catalogo){
        it = findInCatalogo(item);
      }
      if(!it){
        it = { id: item, nombre: String(item), precio: '0€', descripcion: '' };
      }
    } else if(typeof item === 'object'){
      it = item;
    }
    state.carrito.push(it);
    actualizarCarrito();
    // pequeña notificación visual
    toast('Añadido al carrito: ' + (it.nombre||it.id||'producto'));
  }

  function findInCatalogo(id){
    if(!state.catalogo) return null;
    // Buscar por id o filename
    const all = state.catalogo.archivos || state.catalogo.items || state.catalogo.files || [];
    return all.find(x => x.id==id || x.nombre==id || x.filename==id) || null;
  }

  function vaciarCarrito(){
    if(!confirm('¿Vaciar todo el carrito?')) return;
    state.carrito = [];
    actualizarCarrito();
  }

  // Toast simple
  let toastTimer = null;
  function toast(msg, time=2500){
    let t = document.getElementById('rg-toast');
    if(!t){
      t = document.createElement('div');
      t.id = 'rg-toast';
      t.style.position = 'fixed';
      t.style.right = '18px';
      t.style.bottom = '18px';
      t.style.background = 'rgba(0,0,0,0.75)';
      t.style.color = 'white';
      t.style.padding = '10px 14px';
      t.style.borderRadius = '10px';
      t.style.zIndex = 99999;
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1';
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, time);
  }

  // Menú lateral accesible
  function openMenu(){
    const hamb = document.getElementById('btnHamb');
    const side = document.getElementById('sideMenu');
    if(side){ side.classList.add('open'); side.setAttribute('aria-hidden','false'); if(hamb) hamb.setAttribute('aria-expanded','true'); }
  }
  function closeMenu(){
    const hamb = document.getElementById('btnHamb');
    const side = document.getElementById('sideMenu');
    if(side){ side.classList.remove('open'); side.setAttribute('aria-hidden','true'); if(hamb) hamb.setAttribute('aria-expanded','false'); }
  }

  // Modal catálogo: mostrar y poblar usando state.catalogo si existe
  function mostrarCatalogo(stage){
    state.tipoStage = stage || state.tipoStage || 'Stage';
    const modal = document.getElementById('catalogoModal');
    if(!modal) return;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    // poblar categorias si existen datos
    const catGrid = modal.querySelector('#categoriasGrid') || modal.querySelector('.categorias-grid');
    if(catGrid && state.catalogo && state.catalogo.marcas){
      catGrid.innerHTML = '';
      state.catalogo.marcas.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'categoria-btn';
        btn.type = 'button';
        btn.textContent = m.nombre;
        btn.addEventListener('click', function(){ seleccionarMarca(m); });
        catGrid.appendChild(btn);
      });
    }
  }
  function cerrarCatalogo(){
    const modal = document.getElementById('catalogoModal');
    if(!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = 'auto';
  }
  function seleccionarMarca(marca){
    state.marcaSeleccionada = marca;
    // poblar subcategorias/models si hay espacio
    const sub = document.getElementById('subcategorias') || document.querySelector('.subcategorias');
    if(sub){
      const title = sub.querySelector('#subcategoriaTitle') || sub.querySelector('.subcategoria-title');
      if(title) title.textContent = 'Modelos ' + (marca.nombre || marca.marca || '');
      const filtros = sub.querySelector('#filtros') || sub.querySelector('.filtros');
      const grid = sub.querySelector('#archivosGrid') || sub.querySelector('.archivos-grid');
      if(filtros) filtros.innerHTML = '';
      if(grid) grid.innerHTML = '';
      const modelos = marca.modelos || marca.models || [];
      modelos.forEach(md => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'filtro-btn';
        b.textContent = md.nombre || md.model;
        b.addEventListener('click', ()=> seleccionarModelo(md));
        if(filtros) filtros.appendChild(b);
      });
    }
  }
  function seleccionarModelo(modelo){
    state.modeloSeleccionado = modelo;
    const grid = document.getElementById('archivosGrid') || document.querySelector('.archivos-grid');
    if(grid){
      grid.innerHTML = '';
      const files = modelo.archivos || modelo.files || modelo.tunes || [];
      files.forEach(f => {
        const card = document.createElement('div');
        card.className = 'archivo-card';
        card.innerHTML = `<h4>${escapeHtml(f.nombre||f.file||'Archivo')}</h4>
          <div class="archivo-desc">${escapeHtml(f.descripcion||'')}</div>
          <div class="archivo-actions"><button class="btn-agregar">Añadir</button></div>`;
        const btn = card.querySelector('.btn-agregar');
        btn.addEventListener('click', ()=> agregarAlCarrito({nombre:f.nombre, descripcion:f.descripcion, precio:f.precio||'Gratis'}));
        grid.appendChild(card);
      });
    }
  }

  // Formularios: enviarReserva y enviarReprogramacion
  function enviarReserva(e){
    if(e && e.preventDefault) e.preventDefault();
    const form = document.getElementById('formReserva') || document.querySelector('form[name="reserva"]') || null;
    if(!form){
      toast('Formulario de reserva no encontrado');
      return false;
    }
    const data = new FormData(form);
    const obj = {};
    for(const [k,v] of data.entries()) obj[k]=v;
    // Intentar enviar por EmailJS si disponible
    if(window.emailjs && emailjs.send){
      emailjs.send('default_service','template_reserva', obj).then(()=>{
        toast('Reserva enviada. Te contactamos pronto.');
        form.reset();
      }).catch(err=>{
        console.error(err);
        toast('Error envío reserva. Comprueba la consola.');
      });
    } else {
      console.info('Datos reserva (simulado):', obj);
      toast('Reserva simulada (EmailJS no configurado).');
      form.reset();
    }
    return false;
  }

  function enviarReprogramacion(e){
    if(e && e.preventDefault) e.preventDefault();
    const form = document.getElementById('formReprogramacion') || document.querySelector('form[name="reprogramacion"]') || null;
    if(!form){
      toast('Formulario de reprogramación no encontrado');
      return false;
    }
    const data = new FormData(form);
    const obj = {};
    for(const [k,v] of data.entries()) obj[k]=v;
    if(window.emailjs && emailjs.send){
      emailjs.send('default_service','template_reprog', obj).then(()=>{
        toast('Solicitud de reprogramación enviada.');
        form.reset();
      }).catch(err=>{
        console.error(err);
        toast('Error envío reprogramación. Comprueba la consola.');
      });
    } else {
      console.info('Datos reprogramación (simulado):', obj);
      toast('Solicitud simulada (EmailJS no configurado).');
      form.reset();
    }
    return false;
  }

  // Inicialización de UI: restaurar carrito y enlazar botones
  function init(){
    loadCarrito();
    actualizarCarrito();

    // Enlazar botones que tengan data-action
    document.querySelectorAll('[data-action]').forEach(el => {
      const act = el.getAttribute('data-action');
      if(act === 'abrirCatalogo'){
        el.addEventListener('click', ()=> mostrarCatalogo(el.getAttribute('data-stage')||'Stage'));
      } else if(act === 'agregarCarrito'){
        el.addEventListener('click', ()=> {
          const id = el.getAttribute('data-id') || el.dataset.id;
          agregarAlCarrito(id || {nombre: el.getAttribute('data-name') || el.textContent});
        });
      } else if(act === 'openMenu'){
        el.addEventListener('click', openMenu);
      } else if(act === 'closeMenu'){
        el.addEventListener('click', closeMenu);
      }
    });

    // Enlazar botones con IDs conocidos
    const btnCatalogo = document.getElementById('btnAbrirCatalogo');
    if(btnCatalogo) btnCatalogo.addEventListener('click', ()=> mostrarCatalogo('Stage 1'));

    const btnCerrarCatalog = document.getElementById('closeCatalogBtn') || document.getElementById('closeCatalog');
    if(btnCerrarCatalog){
      btnCerrarCatalog.addEventListener('click', cerrarCatalogo);
    }

    // Modales: clic fuera para cerrar
    const modal = document.getElementById('catalogoModal');
    if(modal){
      modal.addEventListener('click', function(e){
        if(e.target === modal) cerrarCatalogo();
      });
    }

    // Botón enviar reservas y reprogramaciones
    const fReserva = document.getElementById('formReserva');
    if(fReserva) fReserva.addEventListener('submit', enviarReserva);
    const fReprog = document.getElementById('formReprogramacion');
    if(fReprog) fReprog.addEventListener('submit', enviarReprogramacion);

    // Hamb/Side menu
    const hamb = document.getElementById('btnHamb');
    if(hamb) hamb.addEventListener('click', openMenu);
    const btnClose = document.getElementById('btnClose');
    if(btnClose) btnClose.addEventListener('click', closeMenu);
    // ESC close handlers
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ cerrarCatalogo(); closeMenu(); } });

    // Back to top behavior (ensure presence)
    const back = document.getElementById('backToTop');
    if(back){
      window.addEventListener('scroll', ()=> back.style.display = (window.scrollY > 300) ? 'flex' : 'none');
      back.style.display = (window.scrollY > 300) ? 'flex' : 'none';
      back.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    }

    // Exponer funciones globales útiles
    window.RG.addToCart = agregarAlCarrito;
    window.enviarReserva = enviarReserva;
    window.enviarReprogramacion = enviarReprogramacion;
    window.actualizarCarrito = actualizarCarrito;
    window.vaciarCarrito = vaciarCarrito;
    window.mostrarCatalogo = mostrarCatalogo;
    window.cerrarCatalogo = cerrarCatalogo;
    window.openMenu = openMenu;
    window.closeMenu = closeMenu;

    // Try to initialize EmailJS if present
    try{ if(window.emailjs && !window.__emailjs_initialized){ emailjs.init && emailjs.init('T_fWrGlGp-KQ-AyHb'); window.__emailjs_initialized = true; } }catch(e){}

    console.info('ReproGarage App inicializada.');
  }

  // Start when DOM ready
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

})(); // fin IIFE
</script>
<!-- FIN: FULL-FEATURE JS -->

</body>
</html>